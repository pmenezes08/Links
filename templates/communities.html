<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Communities</title>
	<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=4.0">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
	<meta name="csrf-token" content="{{ csrf_token }}">
</head>
<body>
	<div class="sidebar">
		<button class="menu-btn">â˜° Menu<span id="unread-badge" class="unread-badge">0</span></button>
		<div class="dropdown-content">
			{% if session['username'] == 'admin' %}
			<a href="/admin">Admin Dashboard</a>
			{% endif %}
			<a href="/profile">Profile</a>
			<a href="/user_chat">Messages</a>
			<a href="/premium_dashboard">Premium Dashboard</a>
			<a href="/communities">Your Communities</a>
			<a href="/nutrition">Nutrition</a>
			<a href="/blood_test_analysis">Blood Test Analysis</a>
			<a href="/chat">Chat with Grok</a>
			<a href="/subscribe">Subscribe</a>
			<a href="/logout">Logout</a>
		</div>
	</div>
	<div class="container">
		<h1>Communities</h1>
		
		<!-- Join Community Section -->
		<div class="join-community-section">
			<h3>Join a Community</h3>
			<form id="joinCommunityForm" class="join-community-form">
				<div class="form-group">
					<label for="communityCode">Community Code:</label>
					<input type="text" id="communityCode" name="communityCode" placeholder="Enter community code..." required>
				</div>
				<button type="submit" class="join-community-btn">Join Community</button>
			</form>
			<div id="joinMessage" class="join-message"></div>
		</div>
		
		<!-- Community Creation Section -->
		<div class="community-creation-section">
			<button id="buildCommunityBtn" class="build-community-btn">Build your community</button>
			
			<div id="communityForm" class="community-form" style="display: none;">
				<h3>Create New Community</h3>
				<form id="createCommunityForm">
					<div class="form-group">
						<label for="communityType">Community Type:</label>
						<select id="communityType" name="type" required>
							<option value="">Select a type...</option>
							<option value="Gym">Gym</option>
							<option value="Golf">Golf</option>
							<option value="Running Club">Running Club</option>
							<option value="Basketball">Basketball</option>
							<option value="Soccer">Soccer</option>
							<option value="Tennis">Tennis</option>
							<option value="Swimming">Swimming</option>
							<option value="Cycling">Cycling</option>
							<option value="Yoga">Yoga</option>
							<option value="CrossFit">CrossFit</option>
							<option value="Boxing">Boxing</option>
							<option value="Martial Arts">Martial Arts</option>
							<option value="Other">Other</option>
						</select>
					</div>
					<div class="form-group">
						<label for="communityName">Community Name:</label>
						<input type="text" id="communityName" name="name" placeholder="Enter community name..." required>
					</div>
					<div class="form-group">
						<label for="communityDescription">Description (Optional):</label>
						<textarea id="communityDescription" name="description" placeholder="Describe your community..." rows="3"></textarea>
					</div>
					<div class="form-group">
						<label for="communityLocation">Location (Optional):</label>
						<input type="text" id="communityLocation" name="location" placeholder="City, State, or Venue name...">
					</div>
					<div class="form-group">
						<label for="communityBackground">Background Picture (Optional):</label>
						<div class="background-options">
							<div class="background-option">
								<label for="backgroundFile">Upload from device:</label>
								<input type="file" id="backgroundFile" name="background_file" accept="image/*">
								<span class="file-info" id="fileInfo"></span>
							</div>
							<div class="background-option">
								<label for="backgroundUrl">Or use URL:</label>
								<input type="url" id="backgroundUrl" name="background_url" placeholder="https://example.com/image.jpg">
							</div>
						</div>
						<div class="background-preview" id="backgroundPreview" style="display: none;">
							<img id="previewImage" src="" alt="Background preview">
						</div>
					</div>
					<div class="form-group">
						<label for="communityColors">Color Palette:</label>
						<div class="color-palette-section">
							<div class="color-option">
								<label for="backgroundColor">Background Color:</label>
								<input type="color" id="backgroundColor" name="background_color" value="#2d3839">
								<span class="color-preview" id="backgroundColorPreview"></span>
							</div>
							<div class="color-option">
								<label for="textColor">Text Color:</label>
								<input type="color" id="textColor" name="text_color" value="#ffffff">
								<span class="color-preview" id="textColorPreview"></span>
							</div>
							<div class="color-option">
								<label for="accentColor">Accent Color:</label>
								<input type="color" id="accentColor" name="accent_color" value="#4db6ac">
								<span class="color-preview" id="accentColorPreview"></span>
							</div>
							<div class="color-option">
								<label for="cardColor">Card Background:</label>
								<input type="color" id="cardColor" name="card_color" value="#1a2526">
								<span class="color-preview" id="cardColorPreview"></span>
							</div>
						</div>
						<div class="color-preview-section">
							<h4>Preview:</h4>
							<div class="color-preview-card" id="colorPreviewCard">
								<div class="preview-header">Sample Post</div>
								<div class="preview-content">This is how your community will look with the selected colors.</div>
								<div class="preview-actions">
									<button class="preview-btn">Like</button>
									<button class="preview-btn">Comment</button>
								</div>
							</div>
						</div>
					</div>
					<div class="form-actions">
						<button type="submit" class="create-community-btn">Create your community</button>
						<button type="button" id="cancelCommunityBtn" class="cancel-btn">Cancel</button>
					</div>
				</form>
			</div>
		</div>

		<!-- User's Communities Section -->
		<div class="user-communities-section">
			<h3>Your Communities</h3>
			<div id="communitiesList" class="communities-list">
				<!-- Communities will be loaded here -->
			</div>
		</div>

		<button onclick="location.href='/dashboard'" class="go-back-btn">Back</button>
	</div>

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="{{ url_for('static', filename='script.js') }}"></script>
	<script>
		$(document).ready(function() {
			// Load user's communities
			loadUserCommunities();

			// Background image preview functionality
			// Handle file upload preview
			$('#backgroundFile').on('change', function() {
				const file = this.files[0];
				if (file) {
					// Clear URL input
					$('#backgroundUrl').val('');
					
					// Show file info
					$('#fileInfo').text(`Selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
					
					// Preview image
					const reader = new FileReader();
					reader.onload = function(e) {
						$('#previewImage').attr('src', e.target.result);
						$('#backgroundPreview').show();
					};
					reader.readAsDataURL(file);
				} else {
					$('#fileInfo').text('');
					$('#backgroundPreview').hide();
				}
			});
			
			// Handle URL input preview
			$('#backgroundUrl').on('input', function() {
				const url = $(this).val().trim();
				if (url) {
					// Clear file input
					$('#backgroundFile').val('');
					$('#fileInfo').text('');
					
					// Preview image
					$('#previewImage').attr('src', url);
					$('#backgroundPreview').show();
				} else {
					$('#backgroundPreview').hide();
				}
			});
			
			// Color picker functionality
			function updateColorPreview() {
				const backgroundColor = $('#backgroundColor').val();
				const textColor = $('#textColor').val();
				const accentColor = $('#accentColor').val();
				const cardColor = $('#cardColor').val();
				
				// Update color previews
				$('#backgroundColorPreview').css('background-color', backgroundColor);
				$('#textColorPreview').css('background-color', textColor);
				$('#accentColorPreview').css('background-color', accentColor);
				$('#cardColorPreview').css('background-color', cardColor);
				
				// Update preview card
				$('#colorPreviewCard').css({
					'background-color': cardColor,
					'border-color': accentColor
				});
				$('.preview-header').css('color', textColor);
				$('.preview-content').css('color', textColor + 'cc'); // Add transparency
				$('.preview-btn').css({
					'background-color': accentColor + '20',
					'border-color': accentColor,
					'color': textColor
				});
			}
			
			// Initialize color previews
			updateColorPreview();
			
			// Update on color change
			$('#backgroundColor, #textColor, #accentColor, #cardColor').on('input', updateColorPreview);

			// Toggle community creation form
			$('#buildCommunityBtn').click(function() {
				$('#communityForm').slideToggle();
			});

			$('#cancelCommunityBtn').click(function() {
				$('#communityForm').slideUp();
			});

			// Handle community creation
			$('#createCommunityForm').submit(function(e) {
				e.preventDefault();
				
				// Create FormData object to handle file uploads
				const formData = new FormData();
				formData.append('name', $('#communityName').val());
				formData.append('type', $('#communityType').val());
				formData.append('description', $('#communityDescription').val());
				formData.append('location', $('#communityLocation').val());
				formData.append('csrf_token', $('meta[name="csrf-token"]').attr('content'));
				
				// Add background file if selected
				const backgroundFile = $('#backgroundFile')[0].files[0];
				if (backgroundFile) {
					formData.append('background_file', backgroundFile);
				}
				
				// Add background URL if provided
				const backgroundUrl = $('#backgroundUrl').val().trim();
				if (backgroundUrl) {
					formData.append('background_url', backgroundUrl);
				}
				
				// Add color palette values
				formData.append('background_color', $('#backgroundColor').val());
				formData.append('text_color', $('#textColor').val());
				formData.append('accent_color', $('#accentColor').val());
				formData.append('card_color', $('#cardColor').val());

				$.ajax({
					url: '/create_community',
					method: 'POST',
					data: formData,
					processData: false,
					contentType: false,
					success: function(response) {
						if (response.success) {
							alert('Community created successfully! Join code: ' + response.join_code);
							$('#communityForm').slideUp();
							$('#createCommunityForm')[0].reset();
							$('#backgroundPreview').hide();
							$('#fileInfo').text('');
							loadUserCommunities(); // Reload communities
						} else {
							alert('Error: ' + response.error);
						}
					},
					error: function() {
						alert('Error creating community. Please try again.');
					}
				});
			});

			// Handle joining community by code
			$('#joinCommunityForm').submit(function(e) {
				e.preventDefault();
				
				const communityCode = $('#communityCode').val().trim();
				if (!communityCode) {
					showJoinMessage('Please enter a community code.', 'error');
					return;
				}

				$.ajax({
					url: '/join_community',
					method: 'POST',
					data: {
						community_code: communityCode,
						csrf_token: $('meta[name="csrf-token"]').attr('content')
					},
					success: function(response) {
						if (response.success) {
							showJoinMessage('Successfully joined "' + response.community_name + '"!', 'success');
							$('#communityCode').val('');
							loadUserCommunities(); // Reload communities
						} else {
							showJoinMessage('Error: ' + response.error, 'error');
						}
					},
					error: function() {
						showJoinMessage('Error joining community. Please try again.', 'error');
					}
				});
			});
		});

		function loadUserCommunities() {
			$.ajax({
				url: '/get_user_communities',
				method: 'GET',
				success: function(response) {
					if (response.success) {
						const communitiesList = $('#communitiesList');
						communitiesList.empty();
						
						if (response.communities.length === 0) {
							communitiesList.html('<p class="no-communities">You haven\'t joined any communities yet.</p>');
						} else {
							response.communities.forEach(function(community) {
								const joinCodeSection = community.is_creator ? `
									<div class="join-code-section">
										<span class="join-code-label">Join Code:</span>
										<span class="join-code">${community.join_code}</span>
										<button onclick="copyJoinCode('${community.join_code}', '${community.name}')" class="copy-btn" title="Copy join code">
											<i class="fas fa-copy"></i>
										</button>
									</div>
								` : '';
								
								const communityCard = $(`
									<div class="community-card">
										<button class="community-btn" onclick="location.href='/community_feed/${community.id}'">
											${community.name} - Social Feed
										</button>
										${joinCodeSection}
										<div class="community-actions">
											<button class="edit-community-btn" onclick="editCommunity(${community.id}, '${community.name}', '${community.type}')">
												<i class="fas fa-edit"></i> Edit
											</button>
											<button class="delete-community-btn" onclick="deleteCommunity(${community.id}, '${community.name}')">
												<i class="fas fa-trash"></i> Delete
											</button>
										</div>
									</div>
								`);
								communitiesList.append(communityCard);
							});
						}
					}
				},
				error: function() {
					$('#communitiesList').html('<p class="error">Error loading communities.</p>');
				}
			});
		}

		function editCommunity(communityId, currentName, currentType) {
			const newName = prompt('Enter new community name:', currentName);
			if (newName && newName.trim() !== '') {
				$.ajax({
					url: '/edit_community',
					method: 'POST',
					data: {
						community_id: communityId,
						name: newName.trim(),
						csrf_token: $('meta[name="csrf-token"]').attr('content')
					},
					success: function(response) {
						if (response.success) {
							alert('Community updated successfully!');
							loadUserCommunities(); // Reload communities
						} else {
							alert('Error: ' + response.error);
						}
					},
					error: function() {
						alert('Error updating community. Please try again.');
					}
				});
			}
		}

		function deleteCommunity(communityId, communityName) {
			const confirmDelete = confirm(`Are you 100% sure you want to delete "${communityName}"?\n\nThis will permanently delete the community and all its posts. This action cannot be undone.`);
			
			if (confirmDelete) {
				$.ajax({
					url: '/delete_community',
					method: 'POST',
					data: {
						community_id: communityId,
						csrf_token: $('meta[name="csrf-token"]').attr('content')
					},
					success: function(response) {
						if (response.success) {
							alert('Community deleted successfully!');
							loadUserCommunities(); // Reload communities
						} else {
							alert('Error: ' + response.error);
						}
					},
					error: function() {
						alert('Error deleting community. Please try again.');
					}
				});
			}
		}

		function showJoinMessage(message, type) {
			const joinMessage = $('#joinMessage');
			joinMessage.removeClass('success error').addClass(type).text(message);
			
			// Auto-hide success messages after 3 seconds
			if (type === 'success') {
				setTimeout(function() {
					joinMessage.fadeOut();
				}, 3000);
			}
		}

		function copyJoinCode(joinCode, communityName) {
			navigator.clipboard.writeText(joinCode).then(function() {
				// Show success message
				const message = document.createElement('div');
				message.className = 'copy-success';
				message.textContent = `Join code for "${communityName}" copied to clipboard!`;
				message.style.cssText = `
					position: fixed;
					top: 20px;
					right: 20px;
					background: #28a745;
					color: white;
					padding: 12px 20px;
					border-radius: 4px;
					z-index: 10000;
					font-size: 0.9em;
					box-shadow: 0 2px 10px rgba(0,0,0,0.3);
				`;
				document.body.appendChild(message);
				
				// Remove message after 3 seconds
				setTimeout(() => {
					message.remove();
				}, 3000);
			}).catch(function(err) {
				console.error('Could not copy text: ', err);
				alert(`Join code: ${joinCode}\n\nCopy this code manually.`);
			});
		}
	</script>
</body>
</html>