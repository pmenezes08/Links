<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Communities</title>
	<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=4.0">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
	<meta name="csrf-token" content="{{ csrf_token }}">
</head>
<body>
	<div class="sidebar">
		<button class="menu-btn">â˜° Menu<span id="unread-badge" class="unread-badge">0</span></button>
		<div class="dropdown-content">
			{% if session['username'] == 'admin' %}
			<a href="/admin">Admin Dashboard</a>
			{% endif %}
			<a href="/profile">Profile</a>
			<a href="/user_chat">Messages</a>
			<a href="/premium_dashboard">Premium Dashboard</a>
			<a href="/communities">Your Communities</a>
			<a href="/nutrition">Nutrition</a>
			<a href="/blood_test_analysis">Blood Test Analysis</a>
			<a href="/chat">Chat with Grok</a>
			<a href="/subscribe">Subscribe</a>
			<a href="/logout">Logout</a>
		</div>
	</div>
	<div class="container">
		<h1>Communities</h1>
		
		<!-- Join Community Section -->
		<div class="join-community-section">
			<h3>Join a Community</h3>
			<form id="joinCommunityForm" class="join-community-form">
				<div class="form-group">
					<label for="communityCode">Community Code:</label>
					<input type="text" id="communityCode" name="communityCode" placeholder="Enter community code..." required>
				</div>
				<button type="submit" class="join-community-btn">Join Community</button>
			</form>
			<div id="joinMessage" class="join-message"></div>
		</div>
		
		<!-- Community Creation Section -->
		<div class="community-creation-section">
			<button id="buildCommunityBtn" class="build-community-btn">Build your community</button>
			
			<div id="communityForm" class="community-form" style="display: none;">
				<h3>Create New Community</h3>
				<form id="createCommunityForm">
					<div class="form-group">
						<label for="communityType">Community Type:</label>
						<select id="communityType" name="type" required>
							<option value="">Select a type...</option>
							<option value="Gym">Gym</option>
							<option value="Golf">Golf</option>
							<option value="Running Club">Running Club</option>
							<option value="Basketball">Basketball</option>
							<option value="Soccer">Soccer</option>
							<option value="Tennis">Tennis</option>
							<option value="Swimming">Swimming</option>
							<option value="Cycling">Cycling</option>
							<option value="Yoga">Yoga</option>
							<option value="CrossFit">CrossFit</option>
							<option value="Boxing">Boxing</option>
							<option value="Martial Arts">Martial Arts</option>
							<option value="Other">Other</option>
						</select>
					</div>
					<div class="form-group">
						<label for="communityName">Community Name:</label>
						<input type="text" id="communityName" name="name" placeholder="Enter community name..." required>
					</div>
					<div class="form-group">
						<label for="communityDescription">Description (Optional):</label>
						<textarea id="communityDescription" name="description" placeholder="Describe your community..." rows="3"></textarea>
					</div>
					<div class="form-group">
						<label for="communityLocation">Location (Optional):</label>
						<input type="text" id="communityLocation" name="location" placeholder="City, State, or Venue name...">
					</div>
					<div class="form-actions">
						<button type="submit" class="create-community-btn">Create your community</button>
						<button type="button" id="cancelCommunityBtn" class="cancel-btn">Cancel</button>
					</div>
				</form>
			</div>
		</div>

		<!-- User's Communities Section -->
		<div class="user-communities-section">
			<h3>Your Communities</h3>
			<div id="communitiesList" class="communities-list">
				<!-- Communities will be loaded here -->
			</div>
		</div>

		<button onclick="location.href='/dashboard'" class="go-back-btn">Back</button>
	</div>

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="{{ url_for('static', filename='script.js') }}"></script>
	<script>
		$(document).ready(function() {
			// Load user's communities
			loadUserCommunities();

			// Toggle community creation form
			$('#buildCommunityBtn').click(function() {
				$('#communityForm').slideToggle();
			});

			$('#cancelCommunityBtn').click(function() {
				$('#communityForm').slideUp();
			});

			// Handle community creation
			$('#createCommunityForm').submit(function(e) {
				e.preventDefault();
				
				const formData = {
					name: $('#communityName').val(),
					type: $('#communityType').val(),
					csrf_token: $('meta[name="csrf-token"]').attr('content')
				};

				$.ajax({
					url: '/create_community',
					method: 'POST',
					data: formData,
					success: function(response) {
						if (response.success) {
							alert('Community created successfully! Join code: ' + response.join_code);
							$('#communityForm').slideUp();
							$('#createCommunityForm')[0].reset();
							loadUserCommunities(); // Reload communities
						} else {
							alert('Error: ' + response.error);
						}
					},
					error: function() {
						alert('Error creating community. Please try again.');
					}
				});
			});

			// Handle joining community by code
			$('#joinCommunityForm').submit(function(e) {
				e.preventDefault();
				
				const communityCode = $('#communityCode').val().trim();
				if (!communityCode) {
					showJoinMessage('Please enter a community code.', 'error');
					return;
				}

				$.ajax({
					url: '/join_community',
					method: 'POST',
					data: {
						community_code: communityCode,
						csrf_token: $('meta[name="csrf-token"]').attr('content')
					},
					success: function(response) {
						if (response.success) {
							showJoinMessage('Successfully joined "' + response.community_name + '"!', 'success');
							$('#communityCode').val('');
							loadUserCommunities(); // Reload communities
						} else {
							showJoinMessage('Error: ' + response.error, 'error');
						}
					},
					error: function() {
						showJoinMessage('Error joining community. Please try again.', 'error');
					}
				});
			});
		});

		function loadUserCommunities() {
			$.ajax({
				url: '/get_user_communities',
				method: 'GET',
				success: function(response) {
					if (response.success) {
						const communitiesList = $('#communitiesList');
						communitiesList.empty();
						
						if (response.communities.length === 0) {
							communitiesList.html('<p class="no-communities">You haven\'t joined any communities yet.</p>');
						} else {
							response.communities.forEach(function(community) {
								const communityCard = $(`
									<div class="community-card">
										<button class="community-btn" onclick="location.href='/community_feed/${community.id}'">
											${community.name} - Social Feed
										</button>
										<div class="community-actions">
											<button class="edit-community-btn" onclick="editCommunity(${community.id}, '${community.name}', '${community.type}')">
												<i class="fas fa-edit"></i> Edit
											</button>
											<button class="delete-community-btn" onclick="deleteCommunity(${community.id}, '${community.name}')">
												<i class="fas fa-trash"></i> Delete
											</button>
										</div>
									</div>
								`);
								communitiesList.append(communityCard);
							});
						}
					}
				},
				error: function() {
					$('#communitiesList').html('<p class="error">Error loading communities.</p>');
				}
			});
		}

		function editCommunity(communityId, currentName, currentType) {
			const newName = prompt('Enter new community name:', currentName);
			if (newName && newName.trim() !== '') {
				$.ajax({
					url: '/edit_community',
					method: 'POST',
					data: {
						community_id: communityId,
						name: newName.trim(),
						csrf_token: $('meta[name="csrf-token"]').attr('content')
					},
					success: function(response) {
						if (response.success) {
							alert('Community updated successfully!');
							loadUserCommunities(); // Reload communities
						} else {
							alert('Error: ' + response.error);
						}
					},
					error: function() {
						alert('Error updating community. Please try again.');
					}
				});
			}
		}

		function deleteCommunity(communityId, communityName) {
			const confirmDelete = confirm(`Are you 100% sure you want to delete "${communityName}"?\n\nThis will permanently delete the community and all its posts. This action cannot be undone.`);
			
			if (confirmDelete) {
				$.ajax({
					url: '/delete_community',
					method: 'POST',
					data: {
						community_id: communityId,
						csrf_token: $('meta[name="csrf-token"]').attr('content')
					},
					success: function(response) {
						if (response.success) {
							alert('Community deleted successfully!');
							loadUserCommunities(); // Reload communities
						} else {
							alert('Error: ' + response.error);
						}
					},
					error: function() {
						alert('Error deleting community. Please try again.');
					}
				});
			}
		}

		function showJoinMessage(message, type) {
			const joinMessage = $('#joinMessage');
			joinMessage.removeClass('success error').addClass(type).text(message);
			
			// Auto-hide success messages after 3 seconds
			if (type === 'success') {
				setTimeout(function() {
					joinMessage.fadeOut();
				}, 3000);
			}
		}
	</script>
</body>
</html>