<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Your Communities</title>
	<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=4.0">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
	<meta name="csrf-token" content="{{ csrf_token }}">
	<style>
		.communities-container {
			margin-left: 80px;
			padding: 20px;
			max-width: 700px;
			margin: 0 auto;
			position: relative;
			left: 40px;
		}

		.communities-header {
			text-align: center;
			margin-bottom: 16px;
		}

		.communities-header h1 {
			font-size: 20px;
			font-weight: 600;
			color: #ffffff;
			margin-bottom: 4px;
			letter-spacing: -0.5px;
		}

		.communities-header p {
			color: rgba(255, 255, 255, 0.7);
			font-size: 12px;
			margin: 0;
		}

		.join-community-section {
			background: rgba(255, 255, 255, 0.03);
			border: 1px solid rgba(255, 255, 255, 0.08);
			border-radius: 8px;
			padding: 12px;
			margin-bottom: 16px;
			backdrop-filter: blur(20px);
		}

		.join-community-section h3 {
			color: #4db6ac;
			margin-bottom: 8px;
			font-size: 14px;
			font-weight: 600;
			display: flex;
			align-items: center;
			gap: 4px;
		}

		.join-community-form {
			display: flex;
			gap: 8px;
			align-items: flex-end;
			flex-wrap: wrap;
		}

		.join-community-form .form-group {
			flex: 1;
			min-width: 150px;
		}

		.join-community-form label {
			display: block;
			color: rgba(255, 255, 255, 0.8);
			font-size: 11px;
			font-weight: 500;
			margin-bottom: 3px;
		}

		.join-community-form input {
			width: 100%;
			padding: 6px 10px;
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid rgba(255, 255, 255, 0.1);
			border-radius: 4px;
			color: #ffffff;
			font-size: 12px;
			transition: all 0.2s ease;
			height: 32px;
			box-sizing: border-box;
		}

		.join-community-form input:focus {
			outline: none;
			border-color: #4db6ac;
			background: rgba(255, 255, 255, 0.08);
		}

		.join-community-btn {
			background: #4db6ac;
			color: #ffffff;
			border: none;
			padding: 8px 16px;
			border-radius: 4px;
			font-size: 12px;
			font-weight: 500;
			cursor: pointer;
			transition: all 0.2s ease;
			white-space: nowrap;
			height: 32px;
			display: flex;
			align-items: center;
		}

		.join-community-btn:hover {
			background: #37a69c;
			transform: translateY(-1px);
		}

		.community-creation-section {
			text-align: center;
			margin-bottom: 16px;
		}

		.build-community-btn {
			background: rgba(255, 255, 255, 0.05);
			color: #ffffff;
			border: 1px solid rgba(255, 255, 255, 0.1);
			padding: 10px 16px;
			border-radius: 6px;
			font-size: 13px;
			font-weight: 500;
			cursor: pointer;
			transition: all 0.2s ease;
			backdrop-filter: blur(20px);
			display: inline-flex;
			align-items: center;
			gap: 4px;
		}

		.build-community-btn:hover {
			background: rgba(255, 255, 255, 0.08);
			border-color: #4db6ac;
			transform: translateY(-1px);
		}

		.user-communities-section {
			margin-top: 16px;
			text-align: center;
		}

		.view-communities-btn {
			background: rgba(255, 255, 255, 0.05);
			color: #ffffff;
			border: 1px solid rgba(255, 255, 255, 0.1);
			padding: 10px 16px;
			border-radius: 6px;
			font-size: 13px;
			font-weight: 500;
			cursor: pointer;
			transition: all 0.2s ease;
			backdrop-filter: blur(20px);
			display: inline-flex;
			align-items: center;
			gap: 4px;
		}

		.view-communities-btn:hover {
			background: rgba(255, 255, 255, 0.08);
			border-color: #4db6ac;
			transform: translateY(-1px);
		}

		.communities-modal {
			max-width: 800px;
			max-height: 85vh;
			overflow-y: auto;
			min-height: 400px;
		}

		.communities-modal .modal-header {
			border-bottom: 1px solid rgba(255, 255, 255, 0.1);
			padding-bottom: 12px;
			margin-bottom: 16px;
		}

		.communities-modal .modal-header h3 {
			color: #4db6ac;
			font-size: 18px;
			font-weight: 600;
			display: flex;
			align-items: center;
			gap: 6px;
			margin: 0;
		}

		.communities-list {
			display: grid;
			gap: 12px;
			min-height: 300px;
		}

		.community-card {
			background: rgba(255, 255, 255, 0.03);
			border: 1px solid rgba(255, 255, 255, 0.08);
			border-radius: 10px;
			padding: 16px;
			transition: all 0.2s ease;
			backdrop-filter: blur(20px);
		}

		.community-card:hover {
			background: rgba(255, 255, 255, 0.05);
			border-color: rgba(255, 255, 255, 0.12);
		}

		.community-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			margin-bottom: 10px;
		}

		.community-info h4 {
			color: #ffffff;
			font-size: 16px;
			font-weight: 600;
			margin: 0 0 4px 0;
		}

		.community-meta {
			color: rgba(255, 255, 255, 0.6);
			font-size: 12px;
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.community-actions {
			display: flex;
			gap: 6px;
		}

		.edit-community-btn,
		.delete-community-btn {
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid rgba(255, 255, 255, 0.1);
			color: #ffffff;
			padding: 6px 10px;
			border-radius: 4px;
			font-size: 11px;
			cursor: pointer;
			transition: all 0.2s ease;
			display: flex;
			align-items: center;
			gap: 3px;
		}

		.edit-community-btn:hover {
			background: rgba(255, 255, 255, 0.08);
			border-color: #4db6ac;
		}

		.delete-community-btn:hover {
			background: rgba(255, 59, 48, 0.1);
			border-color: #FF3B30;
			color: #FF3B30;
		}

		.community-btn {
			background: rgba(255, 255, 255, 0.05);
			color: #ffffff;
			border: 1px solid rgba(255, 255, 255, 0.1);
			padding: 10px 14px;
			border-radius: 6px;
			font-size: 13px;
			font-weight: 500;
			cursor: pointer;
			transition: all 0.2s ease;
			width: 100%;
			text-align: left;
			display: flex;
			align-items: center;
			justify-content: space-between;
		}

		.community-btn:hover {
			background: rgba(255, 255, 255, 0.08);
			border-color: #4db6ac;
		}

		.join-code-section {
			margin-top: 10px;
			padding: 6px 10px;
			background: rgba(77, 182, 172, 0.1);
			border: 1px solid rgba(77, 182, 172, 0.2);
			border-radius: 5px;
			display: flex;
			align-items: center;
			gap: 8px;
		}

		.join-code-label {
			color: #4db6ac;
			font-size: 11px;
			font-weight: 500;
			white-space: nowrap;
		}

		.join-code {
			font-family: 'Courier New', monospace;
			background: rgba(0, 0, 0, 0.3);
			padding: 3px 6px;
			border-radius: 3px;
			font-size: 11px;
			color: #ffffff;
			border: 1px solid rgba(255, 255, 255, 0.1);
			max-width: 120px;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
		}

		.copy-btn {
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid rgba(255, 255, 255, 0.1);
			color: #ffffff;
			padding: 3px 6px;
			border-radius: 3px;
			font-size: 10px;
			cursor: pointer;
			transition: all 0.2s ease;
			flex-shrink: 0;
		}

		.copy-btn:hover {
			background: rgba(255, 255, 255, 0.08);
			border-color: #4db6ac;
		}

		.no-communities {
			text-align: center;
			padding: 60px 20px;
			color: rgba(255, 255, 255, 0.5);
			min-height: 300px;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
		}

		.no-communities i {
			font-size: 32px;
			margin-bottom: 12px;
			color: #4db6ac;
		}

		.no-communities h4 {
			font-size: 16px;
			margin-bottom: 6px;
			color: #ffffff;
		}

		.no-communities p {
			font-size: 13px;
			margin: 0;
		}

		@media (max-width: 768px) {
			.communities-container {
				margin-left: 0;
				padding: 16px;
				left: 0;
			}

			.join-community-form {
				flex-direction: column;
				align-items: stretch;
			}

			.community-header {
				flex-direction: column;
				align-items: flex-start;
				gap: 8px;
			}

			.community-actions {
				align-self: stretch;
				justify-content: flex-end;
			}
		}
	</style>
</head>
<body>
	<div class="sidebar">
		<button class="menu-btn"><i class="fas fa-bars"></i> Menu</button>
		<div class="dropdown-content">
			{% if session['username'] == 'admin' %}
			<a href="{{ url_for('admin') }}">Admin Dashboard</a>
			<a href="{{ url_for('admin_profile') }}">Admin Profile</a>
			{% endif %}
			<a href="{{ url_for('profile') }}">Profile</a>
			<a href="{{ url_for('user_chat') }}">Messages</a>
			<a href="{{ url_for('premium_dashboard') }}">Main Dashboard</a>
			<a href="{{ url_for('feed') }}">Social</a>
			<a href="{{ url_for('communities') }}">Your Communities</a>
			<a href="{{ url_for('your_sports') }}">Your Sports</a>
			<a href="{{ url_for('logout') }}">Logout</a>
		</div>
	</div>
	
	<div class="communities-container">
		<div class="communities-header">
			<h1>Your Communities</h1>
			<p>Join existing communities or create your own</p>
		</div>
		
		<!-- Join Community Section -->
		<div class="join-community-section">
			<h3><i class="fas fa-users"></i> Join a Community</h3>
			<form id="joinCommunityForm" class="join-community-form">
				<div class="form-group">
					<label for="communityCode">Community Code</label>
					<input type="text" id="communityCode" name="communityCode" placeholder="Enter community code..." required>
				</div>
				<button type="submit" class="join-community-btn">Join Community</button>
			</form>
			<div id="joinMessage" class="join-message"></div>
		</div>
		
		<!-- Community Creation Section -->
		<div class="community-creation-section">
			<button id="buildCommunityBtn" class="build-community-btn">
				<i class="fas fa-plus"></i> Create New Community
			</button>
		</div>
		
		<!-- Community Creation Modal -->
		<div id="communityModal" class="modal-overlay" style="display: none;">
			<div class="modal-content">
				<div class="modal-header">
					<h3>Create Your Community</h3>
					<button class="modal-close" id="closeModal">&times;</button>
				</div>
				
				<form id="createCommunityForm">
					<div class="form-section">
						<div class="form-group">
							<label for="communityName">Community Name</label>
							<input type="text" id="communityName" name="name" required placeholder="Enter community name">
						</div>
						
						<div class="form-group">
							<label for="communityType">Community Type</label>
							<select id="communityType" name="type" required>
								<option value="">Select a type</option>
								<option value="Fitness">Fitness</option>
								<option value="Yoga">Yoga</option>
								<option value="Running">Running</option>
								<option value="Cycling">Cycling</option>
								<option value="Swimming">Swimming</option>
								<option value="CrossFit">CrossFit</option>
								<option value="Bodybuilding">Bodybuilding</option>
								<option value="Pilates">Pilates</option>
								<option value="Dance">Dance</option>
								<option value="Martial Arts">Martial Arts</option>
								<option value="Other">Other</option>
							</select>
						</div>
						
						<div class="form-group">
							<label for="communityDescription">Description (Optional)</label>
							<textarea id="communityDescription" name="description" rows="2" placeholder="Tell people what your community is about..."></textarea>
						</div>
						
						<div class="form-group">
							<label for="communityLocation">Location (Optional)</label>
							<input type="text" id="communityLocation" name="location" placeholder="City, Country, or Online">
						</div>
					</div>
					
					<div class="form-section">
						<div class="form-group">
							<label for="communityBackground">Background Image (Optional)</label>
							<div class="background-options">
								<div class="background-option">
									<label for="backgroundFile">Upload from device:</label>
									<input type="file" id="backgroundFile" name="background_file" accept="image/*">
									<div class="file-info" id="fileInfo"></div>
								</div>
								<div class="background-option">
									<label for="backgroundUrl">Or use URL:</label>
									<input type="text" id="backgroundUrl" name="background_url" placeholder="https://example.com/image.jpg">
								</div>
							</div>
							<div class="background-preview" id="backgroundPreview" style="display: none;">
								<img id="previewImage" src="" alt="Preview">
							</div>
						</div>
					</div>
					
					<div class="form-section">
						<div class="form-group">
							<label>Color Theme</label>
							<div class="color-theme-selector">
								<div class="theme-presets">
									<button type="button" class="theme-preset active" data-theme="default">
										<span class="preset-preview default-theme"></span>
										<span class="preset-name">Default</span>
									</button>
									<button type="button" class="theme-preset" data-theme="dark">
										<span class="preset-preview dark-theme"></span>
										<span class="preset-name">Dark</span>
									</button>
									<button type="button" class="theme-preset" data-theme="light">
										<span class="preset-preview light-theme"></span>
										<span class="preset-name">Light</span>
									</button>
									<button type="button" class="theme-preset" data-theme="colorful">
										<span class="preset-preview colorful-theme"></span>
										<span class="preset-name">Colorful</span>
									</button>
								</div>
								<div class="custom-colors-toggle">
									<button type="button" id="customColorsToggle" class="custom-toggle-btn">
										<i class="fas fa-palette"></i> Custom Colors
									</button>
								</div>
								<div class="custom-colors-panel" id="customColorsPanel" style="display: none;">
									<div class="color-grid">
										<div class="color-item">
											<label>Background</label>
											<input type="color" id="backgroundColor" name="background_color" value="#2d3839">
										</div>
										<div class="color-item">
											<label>Text</label>
											<input type="color" id="textColor" name="text_color" value="#ffffff">
										</div>
										<div class="color-item">
											<label>Accent</label>
											<input type="color" id="accentColor" name="accent_color" value="#4db6ac">
										</div>
										<div class="color-item">
											<label>Cards</label>
											<input type="color" id="cardColor" name="card_color" value="#1a2526">
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					
					<div class="form-actions">
						<button type="button" class="cancel-btn" id="cancelCommunityBtn">Cancel</button>
						<button type="submit" class="create-community-btn">Create Community</button>
					</div>
				</form>
			</div>
		</div>

		<!-- User's Communities Section -->
		<div class="user-communities-section">
			<button id="viewCommunitiesBtn" class="view-communities-btn">
				<i class="fas fa-home"></i> View Your Communities
			</button>
		</div>

		<!-- Communities Modal -->
		<div id="communitiesModal" class="modal-overlay" style="display: none;">
			<div class="modal-content communities-modal">
				<div class="modal-header">
					<h3><i class="fas fa-home"></i> Your Communities</h3>
					<button class="modal-close" id="closeCommunitiesModal">&times;</button>
				</div>
				<div id="communitiesList" class="communities-list">
					<!-- Communities will be loaded here -->
				</div>
			</div>
		</div>
	</div>

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="{{ url_for('static', filename='script.js') }}"></script>
	<script>
		$(document).ready(function() {
			// Load user's communities when modal opens
			$('#viewCommunitiesBtn').on('click', function() {
				loadUserCommunities();
				$('#communitiesModal').show();
			});

			// Close communities modal
			$('#closeCommunitiesModal').on('click', function() {
				$('#communitiesModal').hide();
			});

			// Close modal when clicking outside
			$('#communitiesModal').on('click', function(e) {
				if (e.target === this) {
					$(this).hide();
				}
			});

			// Background image preview functionality
			// Handle file upload preview
			$('#backgroundFile').on('change', function() {
				const file = this.files[0];
				if (file) {
					// Clear URL input
					$('#backgroundUrl').val('');
					
					// Show file info
					$('#fileInfo').text(`Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`);
					
					// Preview image
					const reader = new FileReader();
					reader.onload = function(e) {
						$('#previewImage').attr('src', e.target.result);
						$('#backgroundPreview').show();
					};
					reader.readAsDataURL(file);
				}
			});

			// Handle URL input
			$('#backgroundUrl').on('input', function() {
				const url = $(this).val();
				if (url) {
					// Clear file input
					$('#backgroundFile').val('');
					$('#fileInfo').text('');
					
					// Preview image
					$('#previewImage').attr('src', url);
					$('#backgroundPreview').show();
				} else {
					$('#backgroundPreview').hide();
				}
			});

			// Theme preset selection
			$('.theme-preset').on('click', function() {
				$('.theme-preset').removeClass('active');
				$(this).addClass('active');
			});

			// Custom colors toggle
			$('#customColorsToggle').on('click', function() {
				$('#customColorsPanel').toggle();
			});

			// Build community button
			$('#buildCommunityBtn').on('click', function() {
				$('#communityModal').show();
			});

			// Close modal
			$('#closeModal, #cancelCommunityBtn').on('click', function() {
				$('#communityModal').hide();
			});

			// Close modal when clicking outside
			$('#communityModal').on('click', function(e) {
				if (e.target === this) {
					$(this).hide();
				}
			});

			// Join community form
			$('#joinCommunityForm').on('submit', function(e) {
				e.preventDefault();
				const code = $('#communityCode').val().trim();
				
				if (!code) {
					showJoinMessage('Please enter a community code', 'error');
					return;
				}

				$.ajax({
					url: '/join_community',
					method: 'POST',
					data: {
						community_code: code,
						csrf_token: 'disabled'
					},
					success: function(response) {
						if (response.success) {
							showJoinMessage('Successfully joined the community!', 'success');
							$('#communityCode').val('');
							loadUserCommunities(); // Reload communities list
						} else {
							showJoinMessage(response.error || 'Failed to join community', 'error');
						}
					},
					error: function() {
						showJoinMessage('Error joining community. Please try again.', 'error');
					}
				});
			});

			// Create community form
			$('#createCommunityForm').on('submit', function(e) {
				e.preventDefault();
				
				const formData = new FormData(this);
				formData.append('csrf_token', 'disabled');

				$.ajax({
					url: '/create_community',
					method: 'POST',
					data: formData,
					processData: false,
					contentType: false,
					success: function(response) {
						if (response.success) {
							$('#communityModal').hide();
							$('#createCommunityForm')[0].reset();
							$('#backgroundPreview').hide();
							$('#fileInfo').text('');
							loadUserCommunities(); // Reload communities list
							showJoinMessage('Community created successfully!', 'success');
						} else {
							showJoinMessage(response.error || 'Failed to create community', 'error');
						}
					},
					error: function() {
						showJoinMessage('Error creating community. Please try again.', 'error');
					}
				});
			});

			function showJoinMessage(message, type) {
				const messageDiv = $('#joinMessage');
				messageDiv.removeClass('success error').addClass(type).text(message).show();
				
				setTimeout(function() {
					messageDiv.fadeOut();
				}, 5000);
			}
		});

		function loadUserCommunities() {
			$.ajax({
				url: '/get_user_communities',
				method: 'GET',
				success: function(response) {
					if (response.success) {
						displayCommunities(response.communities);
					} else {
						$('#communitiesList').html('<div class="error">Error loading communities</div>');
					}
				},
				error: function() {
					$('#communitiesList').html('<div class="error">Error loading communities</div>');
				}
			});
		}

		function displayCommunities(communities) {
			const container = $('#communitiesList');
			
			if (!communities || communities.length === 0) {
				container.html(`
					<div class="no-communities">
						<i class="fas fa-users"></i>
						<h4>No communities yet</h4>
						<p>Join an existing community or create your own to get started</p>
					</div>
				`);
				return;
			}

			const communitiesHtml = communities.map(community => `
				<div class="community-card">
					<div class="community-header">
						<div class="community-info">
							<h4>${community.name}</h4>
							<div class="community-meta">
								<span><i class="fas fa-tag"></i> ${community.type}</span>
								${community.location ? `<span><i class="fas fa-map-marker-alt"></i> ${community.location}</span>` : ''}
							</div>
						</div>
						<div class="community-actions">
							<button class="edit-community-btn" onclick="editCommunity(${community.id})">
								<i class="fas fa-edit"></i> Edit
							</button>
							<button class="delete-community-btn" onclick="deleteCommunity(${community.id})">
								<i class="fas fa-trash"></i> Delete
							</button>
						</div>
					</div>
					<button class="community-btn" onclick="location.href='/community/${community.id}'">
						<span>View Community</span>
						<i class="fas fa-arrow-right"></i>
					</button>
					<div class="join-code-section">
						<span class="join-code-label">Join Code:</span>
						<span class="join-code">${community.join_code}</span>
						<button class="copy-btn" onclick="copyJoinCode('${community.join_code}')">
							<i class="fas fa-copy"></i>
						</button>
					</div>
				</div>
			`).join('');

			container.html(communitiesHtml);
		}

		function copyJoinCode(code) {
			navigator.clipboard.writeText(code).then(function() {
				// Show a brief success message
				const btn = event.target.closest('.copy-btn');
				const originalText = btn.innerHTML;
				btn.innerHTML = '<i class="fas fa-check"></i>';
				btn.style.color = '#4db6ac';
				
				setTimeout(function() {
					btn.innerHTML = originalText;
					btn.style.color = '#ffffff';
				}, 1000);
			});
		}

		function editCommunity(communityId) {
			// Implement edit functionality
			console.log('Edit community:', communityId);
		}

		function deleteCommunity(communityId) {
			if (confirm('Are you sure you want to delete this community? This action cannot be undone.')) {
				$.ajax({
					url: '/delete_community',
					method: 'POST',
					data: {
						community_id: communityId,
						csrf_token: 'disabled'
					},
					success: function(response) {
						if (response.success) {
							loadUserCommunities(); // Reload communities list
						} else {
							alert(response.error || 'Failed to delete community');
						}
					},
					error: function() {
						alert('Error deleting community. Please try again.');
					}
				});
			}
		}
	</script>
</body>
</html>