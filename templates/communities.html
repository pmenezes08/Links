<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Communities</title>
	<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=4.0">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
	<meta name="csrf-token" content="{{ csrf_token }}">
</head>
<body>
	<div class="sidebar">
		<button class="menu-btn"><i class="fas fa-bars"></i> Menu</button>
		<div class="dropdown-content">
			<a href="{{ url_for('dashboard') }}">Dashboard</a>
			<a href="{{ url_for('free_workouts') }}">Free Workouts</a>
			<a href="{{ url_for('premium_dashboard') }}">Premium Dashboard</a>
			<a href="{{ url_for('feed') }}">Social</a>
			<a href="{{ url_for('communities') }}">Your Communities</a>
			<a href="{{ url_for('your_sports') }}">Your Sports</a>
			            {% if session['username'] == 'admin' %}
            <a href="{{ url_for('admin') }}">Admin Dashboard</a>
            <a href="{{ url_for('admin_profile') }}">Admin Profile</a>
            {% endif %}
			<a href="{{ url_for('logout') }}">Logout</a>
		</div>
	</div>
	<div class="container">
		<h1>Communities</h1>
		
		<!-- Join Community Section -->
		<div class="join-community-section">
			<h3>Join a Community</h3>
			<form id="joinCommunityForm" class="join-community-form">
				<div class="form-group">
					<label for="communityCode">Community Code:</label>
					<input type="text" id="communityCode" name="communityCode" placeholder="Enter community code..." required>
				</div>
				<button type="submit" class="join-community-btn">Join Community</button>
			</form>
			<div id="joinMessage" class="join-message"></div>
		</div>
		
		<!-- Community Creation Section -->
		<div class="community-creation-section">
			<button id="buildCommunityBtn" class="build-community-btn">
				<i class="fas fa-plus-circle"></i> Build your community
			</button>
		</div>
		
		<!-- Community Creation Modal -->
		<div id="communityModal" class="modal-overlay" style="display: none;">
			<div class="modal-content">
				<div class="modal-header">
					<h3>Create Your Community</h3>
					<button class="modal-close" id="closeModal">&times;</button>
				</div>
				
				<form id="createCommunityForm">
					<div class="form-section">
						<div class="form-group">
							<label for="communityName">Community Name</label>
							<input type="text" id="communityName" name="name" required placeholder="Enter community name">
						</div>
						
						<div class="form-group">
							<label for="communityType">Community Type</label>
							<select id="communityType" name="type" required>
								<option value="">Select a type</option>
								<option value="Fitness">Fitness</option>
								<option value="Yoga">Yoga</option>
								<option value="Running">Running</option>
								<option value="Cycling">Cycling</option>
								<option value="Swimming">Swimming</option>
								<option value="CrossFit">CrossFit</option>
								<option value="Bodybuilding">Bodybuilding</option>
								<option value="Pilates">Pilates</option>
								<option value="Dance">Dance</option>
								<option value="Martial Arts">Martial Arts</option>
								<option value="Other">Other</option>
							</select>
						</div>
						
						<div class="form-group">
							<label for="communityDescription">Description (Optional)</label>
							<textarea id="communityDescription" name="description" rows="2" placeholder="Tell people what your community is about..."></textarea>
						</div>
						
						<div class="form-group">
							<label for="communityLocation">Location (Optional)</label>
							<input type="text" id="communityLocation" name="location" placeholder="City, Country, or Online">
						</div>
					</div>
					
					<div class="form-section">
						<div class="form-group">
							<label for="communityBackground">Background Image (Optional)</label>
							<div class="background-options">
								<div class="background-option">
									<label for="backgroundFile">Upload from device:</label>
									<input type="file" id="backgroundFile" name="background_file" accept="image/*">
									<div class="file-info" id="fileInfo"></div>
								</div>
								<div class="background-option">
									<label for="backgroundUrl">Or use URL:</label>
									<input type="text" id="backgroundUrl" name="background_url" placeholder="https://example.com/image.jpg">
								</div>
							</div>
							<div class="background-preview" id="backgroundPreview" style="display: none;">
								<img id="previewImage" src="" alt="Preview">
							</div>
						</div>
					</div>
					
					<div class="form-section">
						<div class="form-group">
							<label>Color Theme</label>
							<div class="color-theme-selector">
								<div class="theme-presets">
									<button type="button" class="theme-preset active" data-theme="default">
										<span class="preset-preview default-theme"></span>
										<span class="preset-name">Default</span>
									</button>
									<button type="button" class="theme-preset" data-theme="dark">
										<span class="preset-preview dark-theme"></span>
										<span class="preset-name">Dark</span>
									</button>
									<button type="button" class="theme-preset" data-theme="light">
										<span class="preset-preview light-theme"></span>
										<span class="preset-name">Light</span>
									</button>
									<button type="button" class="theme-preset" data-theme="colorful">
										<span class="preset-preview colorful-theme"></span>
										<span class="preset-name">Colorful</span>
									</button>
								</div>
								<div class="custom-colors-toggle">
									<button type="button" id="customColorsToggle" class="custom-toggle-btn">
										<i class="fas fa-palette"></i> Custom Colors
									</button>
								</div>
								<div class="custom-colors-panel" id="customColorsPanel" style="display: none;">
									<div class="color-grid">
										<div class="color-item">
											<label>Background</label>
											<input type="color" id="backgroundColor" name="background_color" value="#2d3839">
										</div>
										<div class="color-item">
											<label>Text</label>
											<input type="color" id="textColor" name="text_color" value="#ffffff">
										</div>
										<div class="color-item">
											<label>Accent</label>
											<input type="color" id="accentColor" name="accent_color" value="#4db6ac">
										</div>
										<div class="color-item">
											<label>Cards</label>
											<input type="color" id="cardColor" name="card_color" value="#1a2526">
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					
					<div class="form-actions">
						<button type="button" class="cancel-btn" id="cancelCommunityBtn">Cancel</button>
						<button type="submit" class="create-community-btn">Create Community</button>
					</div>
				</form>
			</div>
		</div>

		<!-- User's Communities Section -->
		<div class="user-communities-section">
			<h3>Your Communities</h3>
			<div id="communitiesList" class="communities-list">
				<!-- Communities will be loaded here -->
			</div>
		</div>

		<button onclick="location.href='/dashboard'" class="go-back-btn">Back</button>
	</div>

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="{{ url_for('static', filename='script.js') }}"></script>
	<script>
		$(document).ready(function() {
			// Load user's communities
			loadUserCommunities();

			// Background image preview functionality
			// Handle file upload preview
			$('#backgroundFile').on('change', function() {
				const file = this.files[0];
				if (file) {
					// Clear URL input
					$('#backgroundUrl').val('');
					
					// Show file info
					$('#fileInfo').text(`Selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
					
					// Preview image
					const reader = new FileReader();
					reader.onload = function(e) {
						$('#previewImage').attr('src', e.target.result);
						$('#backgroundPreview').show();
					};
					reader.readAsDataURL(file);
				} else {
					$('#fileInfo').text('');
					$('#backgroundPreview').hide();
				}
			});
			
			// Handle URL input preview
			$('#backgroundUrl').on('input', function() {
				const url = $(this).val().trim();
				if (url) {
					// Clear file input
					$('#backgroundFile').val('');
					$('#fileInfo').text('');
					
					// Preview image
					$('#previewImage').attr('src', url);
					$('#backgroundPreview').show();
				} else {
					$('#backgroundPreview').hide();
				}
			});
			
			// Color picker functionality
			function updateColorPreview() {
				const backgroundColor = $('#backgroundColor').val();
				const textColor = $('#textColor').val();
				const accentColor = $('#accentColor').val();
				const cardColor = $('#cardColor').val();
				
				// Update color previews
				$('#backgroundColorPreview').css('background-color', backgroundColor);
				$('#textColorPreview').css('background-color', textColor);
				$('#accentColorPreview').css('background-color', accentColor);
				$('#cardColorPreview').css('background-color', cardColor);
				
				// Update preview card
				$('#colorPreviewCard').css({
					'background-color': cardColor,
					'border-color': accentColor
				});
				$('.preview-header').css('color', textColor);
				$('.preview-content').css('color', textColor + 'cc'); // Add transparency
				$('.preview-btn').css({
					'background-color': accentColor + '20',
					'border-color': accentColor,
					'color': textColor
				});
			}
			
			// Initialize color previews
			updateColorPreview();
			
			// Theme preset functionality
			$('.theme-preset').click(function() {
				$('.theme-preset').removeClass('active');
				$(this).addClass('active');
				
				const theme = $(this).data('theme');
				setThemeColors(theme);
			});
			
			// Custom colors toggle
			$('#customColorsToggle').click(function() {
				$('#customColorsPanel').slideToggle(200);
			});
			
			// Update on color change
			$('#backgroundColor, #textColor, #accentColor, #cardColor').on('input', updateColorPreview);
			
			// Function to set theme colors
			function setThemeColors(theme) {
				let colors = {};
				
				switch(theme) {
					case 'default':
						colors = {
							background: '#2d3839',
							text: '#ffffff',
							accent: '#4db6ac',
							card: '#1a2526'
						};
						break;
					case 'dark':
						colors = {
							background: '#1a1a1a',
							text: '#ffffff',
							accent: '#666666',
							card: '#000000'
						};
						break;
					case 'light':
						colors = {
							background: '#f5f5f5',
							text: '#333333',
							accent: '#4db6ac',
							card: '#ffffff'
						};
						break;
					case 'colorful':
						colors = {
							background: '#667eea',
							text: '#ffffff',
							accent: '#764ba2',
							card: '#5a6fd8'
						};
						break;
				}
				
				$('#backgroundColor').val(colors.background);
				$('#textColor').val(colors.text);
				$('#accentColor').val(colors.accent);
				$('#cardColor').val(colors.card);
				
				updateColorPreview();
			}

			// Modal functionality
			$('#buildCommunityBtn').click(function() {
				$('#communityModal').fadeIn(300);
			});
			
			$('#closeModal, #cancelCommunityBtn').click(function() {
				$('#communityModal').fadeOut(300);
			});

			// Close modal when clicking outside
			$('#communityModal').click(function(e) {
				if (e.target === this) {
					$(this).fadeOut(300);
				}
			});

			// Handle community creation
			$('#createCommunityForm').submit(function(e) {
				e.preventDefault();
				
				// Create FormData object to handle file uploads
				const formData = new FormData();
				formData.append('name', $('#communityName').val());
				formData.append('type', $('#communityType').val());
				formData.append('description', $('#communityDescription').val());
				formData.append('location', $('#communityLocation').val());
				formData.append('csrf_token', $('meta[name="csrf-token"]').attr('content'));
				
				// Add background file if selected
				const backgroundFile = $('#backgroundFile')[0].files[0];
				if (backgroundFile) {
					formData.append('background_file', backgroundFile);
				}
				
				// Add background URL if provided
				const backgroundUrl = $('#backgroundUrl').val().trim();
				if (backgroundUrl) {
					formData.append('background_url', backgroundUrl);
				}
				
				// Add color palette values
				formData.append('background_color', $('#backgroundColor').val());
				formData.append('text_color', $('#textColor').val());
				formData.append('accent_color', $('#accentColor').val());
				formData.append('card_color', $('#cardColor').val());

				$.ajax({
					url: '/create_community',
					method: 'POST',
					data: formData,
					processData: false,
					contentType: false,
					success: function(response) {
						if (response.success) {
							alert('Community created successfully! Join code: ' + response.join_code);
							$('#communityModal').fadeOut(300);
							$('#createCommunityForm')[0].reset();
							$('#backgroundPreview').hide();
							$('#fileInfo').text('');
							loadUserCommunities(); // Reload communities
						} else {
							alert('Error: ' + response.error);
						}
					},
					error: function() {
						alert('Error creating community. Please try again.');
					}
				});
			});

			// Handle joining community by code
			$('#joinCommunityForm').submit(function(e) {
				e.preventDefault();
				
				const communityCode = $('#communityCode').val().trim();
				if (!communityCode) {
					showJoinMessage('Please enter a community code.', 'error');
					return;
				}

				$.ajax({
					url: '/join_community',
					method: 'POST',
					data: {
						community_code: communityCode,
						csrf_token: $('meta[name="csrf-token"]').attr('content')
					},
					success: function(response) {
						if (response.success) {
							showJoinMessage('Successfully joined "' + response.community_name + '"!', 'success');
							$('#communityCode').val('');
							loadUserCommunities(); // Reload communities
						} else {
							showJoinMessage('Error: ' + response.error, 'error');
						}
					},
					error: function() {
						showJoinMessage('Error joining community. Please try again.', 'error');
					}
				});
			});
		});

		function loadUserCommunities() {
			$.ajax({
				url: '/get_user_communities',
				method: 'GET',
				success: function(response) {
					if (response.success) {
						const communitiesList = $('#communitiesList');
						communitiesList.empty();
						
						if (response.communities.length === 0) {
							communitiesList.html('<p class="no-communities">You haven\'t joined any communities yet.</p>');
						} else {
							response.communities.forEach(function(community) {
								const joinCodeSection = community.is_creator ? `
									<div class="join-code-section">
										<span class="join-code-label">Join Code:</span>
										<span class="join-code">${community.join_code}</span>
										<button onclick="copyJoinCode('${community.join_code}', '${community.name}')" class="copy-btn" title="Copy join code">
											<i class="fas fa-copy"></i>
										</button>
									</div>
								` : '';
								
								const communityCard = $(`
									<div class="community-card">
										<button class="community-btn" onclick="event.stopPropagation(); window.location.href='/community_feed/${community.id}';">
											${community.name} - Social Feed
										</button>
										${joinCodeSection}
										<div class="community-actions">
											<button class="edit-community-btn" onclick="event.stopPropagation(); editCommunity(${community.id}, '${community.name}', '${community.type}');">
												<i class="fas fa-edit"></i> Edit
											</button>
											<button class="delete-community-btn" onclick="event.stopPropagation(); deleteCommunity(${community.id}, '${community.name}');">
												<i class="fas fa-trash"></i> Delete
											</button>
										</div>
									</div>
								`);
								communitiesList.append(communityCard);
							});
						}
					}
				},
				error: function() {
					$('#communitiesList').html('<p class="error">Error loading communities.</p>');
				}
			});
		}

		function editCommunity(communityId, currentName, currentType) {
			const newName = prompt('Enter new community name:', currentName);
			if (newName && newName.trim() !== '') {
				$.ajax({
					url: '/edit_community',
					method: 'POST',
					data: {
						community_id: communityId,
						name: newName.trim(),
						csrf_token: $('meta[name="csrf-token"]').attr('content')
					},
					success: function(response) {
						if (response.success) {
							alert('Community updated successfully!');
							loadUserCommunities(); // Reload communities
						} else {
							alert('Error: ' + response.error);
						}
					},
					error: function() {
						alert('Error updating community. Please try again.');
					}
				});
			}
		}

		function deleteCommunity(communityId, communityName) {
			const confirmDelete = confirm(`Are you 100% sure you want to delete "${communityName}"?\n\nThis will permanently delete the community and all its posts. This action cannot be undone.`);
			
			if (confirmDelete) {
				$.ajax({
					url: '/delete_community',
					method: 'POST',
					data: {
						community_id: communityId,
						csrf_token: $('meta[name="csrf-token"]').attr('content')
					},
					success: function(response) {
						if (response.success) {
							alert('Community deleted successfully!');
							loadUserCommunities(); // Reload communities
						} else {
							alert('Error: ' + response.error);
						}
					},
					error: function() {
						alert('Error deleting community. Please try again.');
					}
				});
			}
		}

		function showJoinMessage(message, type) {
			const joinMessage = $('#joinMessage');
			joinMessage.removeClass('success error').addClass(type).text(message);
			
			// Auto-hide success messages after 3 seconds
			if (type === 'success') {
				setTimeout(function() {
					joinMessage.fadeOut();
				}, 3000);
			}
		}

		function copyJoinCode(joinCode, communityName) {
			navigator.clipboard.writeText(joinCode).then(function() {
				// Show success message
				const message = document.createElement('div');
				message.className = 'copy-success';
				message.textContent = `Join code for "${communityName}" copied to clipboard!`;
				message.style.cssText = `
					position: fixed;
					top: 20px;
					right: 20px;
					background: #28a745;
					color: white;
					padding: 12px 20px;
					border-radius: 4px;
					z-index: 10000;
					font-size: 0.9em;
					box-shadow: 0 2px 10px rgba(0,0,0,0.3);
				`;
				document.body.appendChild(message);
				
				// Remove message after 3 seconds
				setTimeout(() => {
					message.remove();
				}, 3000);
			}).catch(function(err) {
				console.error('Could not copy text: ', err);
				alert(`Join code: ${joinCode}\n\nCopy this code manually.`);
			});
		}
	</script>
</body>
</html>