<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Communities</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <style>
    body { background: #0b0f10; color: #fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    .layout { display: grid; grid-template-columns: 220px 1fr; min-height: 100vh; }
    .sidebar { border-right: 1px solid #333; background: #1a1a1a; position: sticky; top: 0; height: 100vh; }
    .sidebar .title { height: 56px; display: flex; align-items: center; padding: 0 12px; border-bottom: 1px solid #333; font-weight: 600; }
    .sidebar nav a { display: block; padding: 10px 16px; color: #cfd8dc; text-decoration: none; }
    .sidebar nav a:hover { background: rgba(0,0,0,0.2); color: #7fe7df; }
    .content { padding: 24px; }
    .card { background: #000; border: 1px solid rgba(255,255,255,0.1); border-radius: 14px; padding: 12px; margin-bottom: 12px; }
    .grid { display: grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 12px; }
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; background: #4db6ac; color: #000; border-radius: 8px; border: 1px solid #4db6ac; text-decoration: none; }
    .btn:hover { filter: brightness(1.1); }
    .muted { color: #9fb0b5; font-size: 13px; }
    .tabs { position: sticky; top: 0; background: rgba(11,15,16,0.9); backdrop-filter: blur(6px); z-index: 20; display:flex; gap:10px; border-bottom: 1px solid rgba(255,255,255,0.08); }
    .tabs .tab { flex: 0 0 auto; padding: 10px 14px; border-radius: 12px 12px 0 0; color: #9fb0b5; cursor: pointer; border: 1px solid transparent; border-bottom: none; }
    .tabs .tab.active { color: #fff; border-color: rgba(255,255,255,0.12); background: #0f1516; }
    @media (max-width: 1024px){ .grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 768px){ .grid{ grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="layout">
    <!-- Sidebar (reuse structure from other HTML pages) -->
    <aside class="sidebar">
      <div class="title">Dashboard</div>
      <nav>
        <a href="/dashboard"><i class="fa-solid fa-gauge-high"></i> &nbsp;Dashboard</a>
        <a href="/profile"><i class="fa-solid fa-user"></i> &nbsp;Profile</a>
        <a href="/user_chat"><i class="fa-solid fa-message"></i> &nbsp;Messages</a>
        <a href="/communities" style="color:#7fe7df"><i class="fa-solid fa-people-group"></i> &nbsp;Your Communities</a>
        <a href="/logout"><i class="fa-solid fa-right-from-bracket"></i> &nbsp;Logout</a>
        <a href="/account_settings"><i class="fa-solid fa-cog"></i> &nbsp;Settings</a>
      </nav>
    </aside>

    <!-- Content -->
    <main class="content">
      <div style="max-width: 1100px; margin: 0 auto;">
        <h2 style="margin:0 0 8px 0">Communities</h2>
        <!-- Top tabs -->
        <div class="tabs">
          <div id="tab-timeline" class="tab active" onclick="switchTab('timeline')">Home Timeline</div>
          <div id="tab-communities" class="tab" onclick="switchTab('communities')">Community List</div>
        </div>

        <!-- Home Timeline section -->
        <section id="section-timeline" style="margin-top: 12px;">
          <div class="card" style="margin-bottom: 16px;">
            <div style="display:flex; align-items:center; justify-content:space-between;">
              <h3 style="margin: 0; font-size: 18px;">Home Timeline</h3>
            </div>
            <div class="muted" style="margin-top: 4px;">Most recent posts across all your communities</div>
            <div id="timeline" style="margin-top: 10px; display: grid; gap: 10px;"></div>
          </div>
        </section>

        <!-- Communities Management section -->
        <section id="section-communities" style="display:none; margin-top: 12px;">
          <div class="card">
            <div style="display:flex; align-items:center; justify-content:space-between;">
              <h3 style="margin: 0; font-size: 18px;">Your Communities</h3>
              <div style="display:flex; gap:8px;">
                <a class="btn" href="/premium_dashboard"><i class="fa-solid fa-plus"></i> Create</a>
                <a class="btn" href="/premium_dashboard"><i class="fa-solid fa-door-open"></i> Join</a>
              </div>
            </div>
            <div class="muted" style="margin-top: 4px;">Manage and access your communities</div>
            <div id="communities" style="margin-top: 10px; display: grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 10px;"></div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    function switchTab(which){
      const t1 = document.getElementById('tab-timeline')
      const t2 = document.getElementById('tab-communities')
      const s1 = document.getElementById('section-timeline')
      const s2 = document.getElementById('section-communities')
      if (which === 'timeline'){
        t1.classList.add('active'); t2.classList.remove('active')
        s1.style.display = ''; s2.style.display = 'none'
      } else {
        t2.classList.add('active'); t1.classList.remove('active')
        s2.style.display = ''; s1.style.display = 'none'
      }
    }
    // Fetch Home Timeline (same API used by React mobile)
    async function loadTimeline(){
      const el = document.getElementById('timeline')
      el.innerHTML = '<div class="muted">Loading…</div>'
      try{
        const r = await fetch('/api/home_timeline', { credentials:'include' })
        const j = await r.json()
        if (!j || !j.success){ el.innerHTML = '<div class="muted">Failed to load timeline.</div>'; return }
        const posts = Array.isArray(j.posts) ? j.posts.slice(0, 8) : []
        if (posts.length === 0){ el.innerHTML = '<div class="muted">No recent posts.</div>'; return }
        el.innerHTML = ''
        posts.forEach(p => {
          const card = document.createElement('div')
          card.className = 'card'
          card.innerHTML = `
            <div style="display:flex; align-items:center; gap:8px;">
              <div style="font-weight:600;">${p.username || ''}</div>
              <div class="muted" style="margin-left:auto; font-size:12px;">${(p.timestamp||'').replace('T',' ').slice(0,16)}</div>
            </div>
            <div style="margin-top:6px; white-space:pre-wrap;">${(p.content||'').replace(/</g,'&lt;')}</div>
            ${p.image_path ? `<div style="margin-top:8px;"><img src="${p.image_path.startsWith('/uploads')||p.image_path.startsWith('/static')?p.image_path:'/uploads/'+p.image_path}" alt="" style="max-width:100%; max-height:360px; border:1px solid rgba(255,255,255,0.1); border-radius:8px;"/></div>` : ''}
            <div style="margin-top:8px; display:flex; gap:10px; font-size:12px; color:#9fb0b5;">
              <div><i class="fa-regular fa-heart"></i> ${(p.reactions && (p.reactions['heart']||0))}</div>
              <div><i class="fa-regular fa-comment"></i> ${(p.replies_count || (p.replies?p.replies.length:0) || 0)}</div>
            </div>
          `
          el.appendChild(card)
        })
      }catch(e){ el.innerHTML = '<div class="muted">Failed to load timeline.</div>' }
    }

    // Fetch user's communities for management grid
    async function loadCommunities(){
      const el = document.getElementById('communities')
      el.innerHTML = '<div class="muted">Loading…</div>'
      try{
        const r = await fetch('/api/user_parent_community', { credentials:'include' })
        const j = await r.json()
        if (!j || !j.success || !Array.isArray(j.communities) || j.communities.length === 0){
          el.innerHTML = '<div class="muted">No communities found.</div>'
          return
        }
        el.innerHTML = ''
        j.communities.forEach(c => {
          const item = document.createElement('div')
          item.className = 'card'
          const link = `/community_feed_react/${c.id}`
          item.innerHTML = `
            <div style="font-weight:600;">${c.name}</div>
            <div class="muted">${c.type || ''}</div>
            <div style="margin-top:8px;">
              <a class="btn" href="${link}"><i class="fa-solid fa-arrow-right"></i> Open</a>
            </div>
          `
          el.appendChild(item)
        })
      }catch(e){ el.innerHTML = '<div class="muted">Failed to load communities.</div>' }
    }

    loadTimeline();
    loadCommunities();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
	<title>Communities</title>
	<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=4.0">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
	<meta name="csrf-token" content="{{ csrf_token }}">
	<style>
		html, body {
			background: #000000 !important;
			margin: 0;
			padding: 0;
		}

		.communities-container {
			margin-left: 80px;
			padding: 20px;
			max-width: 700px;
			margin: 0 auto;
			position: relative;
			left: 40px;
			background: #000000;
			min-height: 100vh;
		}

		.communities-header {
			text-align: center;
			margin-bottom: 16px;
		}

		.communities-header h1 {
			font-size: 20px;
			font-weight: 600;
			color: #ffffff;
			margin-bottom: 4px;
			letter-spacing: -0.5px;
		}

		.communities-header p {
			color: rgba(255, 255, 255, 0.7);
			font-size: 12px;
			margin: 0;
		}

		.join-community-section {
			background: rgba(255, 255, 255, 0.03);
			border: 1px solid rgba(255, 255, 255, 0.08);
			border-radius: 8px;
			padding: 12px;
			margin-bottom: 16px;
			backdrop-filter: blur(20px);
		}

		.join-community-section h3 {
			color: #4db6ac;
			margin-bottom: 8px;
			font-size: 14px;
			font-weight: 600;
			display: flex;
			align-items: center;
			gap: 4px;
		}

		.join-community-form {
			display: flex;
			gap: 8px;
			align-items: flex-start;
			flex-wrap: nowrap;
		}

		.join-community-form .form-group {
			flex: 1;
			min-width: 150px;
			display: flex;
			flex-direction: column;
		}

		.join-community-form label {
			display: block;
			color: rgba(255, 255, 255, 0.8);
			font-size: 11px;
			font-weight: 500;
			margin-bottom: 3px;
			line-height: 1.2;
		}

		.join-community-form input {
			width: 100%;
			padding: 6px 10px;
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid rgba(255, 255, 255, 0.1);
			border-radius: 4px;
			color: #ffffff;
			font-size: 12px;
			transition: all 0.2s ease;
			height: 32px;
			box-sizing: border-box;
			display: block;
		}

		.join-community-form input:focus {
			outline: none;
			border-color: #4db6ac;
			background: rgba(255, 255, 255, 0.08);
		}

		.join-community-btn {
			background: #4db6ac;
			color: #ffffff;
			border: none;
			padding: 8px 16px;
			border-radius: 4px;
			font-size: 12px;
			font-weight: 500;
			cursor: pointer;
			transition: all 0.2s ease;
			white-space: nowrap;
			height: 32px;
			display: inline-flex;
			align-items: center;
			justify-content: center;
			flex-shrink: 0;
			/* Align with input by accounting for label height (11px * 1.2 line-height + 3px margin) */
			margin-top: calc(11px * 1.2 + 3px);
		}

		.join-community-btn:hover {
			background: #37a69c;
			transform: translateY(-1px);
		}

		.community-creation-section {
			text-align: center;
			margin-bottom: 16px;
		}
		
		/* Joined Communities Section */
		.joined-communities-section {
			background: rgba(255, 255, 255, 0.03);
			border: 1px solid rgba(255, 255, 255, 0.08);
			border-radius: 8px;
			padding: 12px;
			margin-bottom: 16px;
			backdrop-filter: blur(20px);
		}
		
		.joined-communities-list {
			display: flex;
			flex-direction: column;
			gap: 8px;
		}
		
		.joined-community-item {
			display: flex;
			align-items: center;
			justify-content: space-between;
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid rgba(255, 255, 255, 0.1);
			border-radius: 6px;
			padding: 10px;
			transition: all 0.2s ease;
		}
		
		.joined-community-item:hover {
			background: rgba(255, 255, 255, 0.08);
			border-color: rgba(77, 182, 172, 0.4);
			transform: translateX(2px);
		}
		
		.joined-community-info {
			flex: 1;
			display: flex;
			flex-direction: column;
			gap: 2px;
		}
		
		.joined-community-name {
			color: #ffffff;
			font-size: 13px;
			font-weight: 500;
		}
		
		.joined-community-type {
			color: rgba(255, 255, 255, 0.6);
			font-size: 11px;
		}
		
		.enter-community-btn {
			background: #4db6ac;
			color: #ffffff;
			border: none;
			padding: 6px 12px;
			border-radius: 4px;
			font-size: 11px;
			font-weight: 500;
			cursor: pointer;
			transition: all 0.2s ease;
			white-space: nowrap;
		}
		
		.enter-community-btn:hover {
			background: #37a69c;
			transform: translateY(-1px);
		}
		
		.exit-community-btn {
			background: rgba(255, 87, 87, 0.2);
			color: #ff5757;
			border: 1px solid rgba(255, 87, 87, 0.3);
			padding: 6px 12px;
			border-radius: 4px;
			font-size: 11px;
			font-weight: 500;
			cursor: pointer;
			transition: all 0.2s ease;
			white-space: nowrap;
		}
		
		.exit-community-btn:hover {
			background: rgba(255, 87, 87, 0.3);
			border-color: rgba(255, 87, 87, 0.4);
			transform: translateY(-1px);
		}
		
		/* Join message with link styling */
		#joinMessage {
			margin-top: 8px;
			padding: 8px 12px;
			border-radius: 4px;
			font-size: 12px;
			font-weight: 500;
			text-align: center;
			display: none;
		}
		
		#joinMessage.success {
			background: rgba(77, 182, 172, 0.2);
			color: #4db6ac;
			border: 1px solid rgba(77, 182, 172, 0.3);
		}
		
		#joinMessage.error {
			background: rgba(255, 87, 87, 0.2);
			color: #ff5757;
			border: 1px solid rgba(255, 87, 87, 0.3);
		}
		
		#joinMessage a {
			color: #4db6ac !important;
			text-decoration: underline;
			font-weight: 600;
			margin-left: 4px;
			transition: all 0.2s ease;
		}
		
		#joinMessage a:hover {
			color: #37a69c !important;
			text-decoration: none;
		}

		.build-community-btn {
			background: rgba(255, 255, 255, 0.05);
			color: #ffffff;
			border: 1px solid rgba(255, 255, 255, 0.1);
			padding: 10px 16px;
			border-radius: 6px;
			font-size: 13px;
			font-weight: 500;
			cursor: pointer;
			transition: all 0.2s ease;
			backdrop-filter: blur(20px);
			display: inline-flex;
			align-items: center;
			gap: 4px;
		}

		.build-community-btn:hover {
			background: rgba(255, 255, 255, 0.08);
			border-color: #4db6ac;
			transform: translateY(-1px);
		}

		.user-communities-section {
			margin-top: 16px;
			text-align: center;
		}

		.view-communities-btn {
			background: rgba(255, 255, 255, 0.05);
			color: #ffffff;
			border: 1px solid rgba(255, 255, 255, 0.1);
			padding: 10px 16px;
			border-radius: 6px;
			font-size: 13px;
			font-weight: 500;
			cursor: pointer;
			transition: all 0.2s ease;
			backdrop-filter: blur(20px);
			display: inline-flex;
			align-items: center;
			gap: 4px;
		}

		.view-communities-btn:hover {
			background: rgba(255, 255, 255, 0.08);
			border-color: #4db6ac;
			transform: translateY(-1px);
		}

		.communities-modal {
			max-width: 800px;
			max-height: 85vh;
			overflow-y: auto;
			min-height: 400px;
		}

		.communities-modal .modal-header {
			border-bottom: 1px solid rgba(255, 255, 255, 0.1);
			padding-bottom: 12px;
			margin-bottom: 16px;
		}

		.communities-modal .modal-header h3 {
			color: #4db6ac;
			font-size: 18px;
			font-weight: 600;
			display: flex;
			align-items: center;
			gap: 6px;
			margin: 0;
		}

		.communities-list {
			display: grid;
			gap: 12px;
			min-height: 300px;
		}

		.community-card {
			background: rgba(255, 255, 255, 0.03);
			border: 1px solid rgba(255, 255, 255, 0.08);
			border-radius: 10px;
			padding: 16px;
			transition: all 0.2s ease;
			backdrop-filter: blur(20px);
		}

		.community-card:hover {
			background: rgba(255, 255, 255, 0.05);
			border-color: rgba(255, 255, 255, 0.12);
		}
		
		.community-card.deactivated {
			background: rgba(255, 68, 68, 0.02);
			border-color: rgba(255, 68, 68, 0.15);
			opacity: 0.85;
		}
		
		.community-card.deactivated:hover {
			border-color: rgba(255, 68, 68, 0.3);
			box-shadow: 0 2px 8px rgba(255, 68, 68, 0.1);
		}
		
		.deactivated-badge {
			display: inline-block;
			margin-left: 10px;
			padding: 2px 8px;
			background: rgba(255, 68, 68, 0.1);
			color: #ff4444;
			border: 1px solid rgba(255, 68, 68, 0.2);
			border-radius: 12px;
			font-size: 11px;
			font-weight: normal;
			vertical-align: middle;
		}

		.community-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			margin-bottom: 10px;
		}

		.community-info h4 {
			color: #ffffff;
			font-size: 16px;
			font-weight: 600;
			margin: 0 0 4px 0;
		}

		.community-meta {
			color: rgba(255, 255, 255, 0.6);
			font-size: 12px;
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.community-actions {
			display: flex;
			gap: 6px;
		}

		.edit-community-btn,
		.delete-community-btn {
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid rgba(255, 255, 255, 0.1);
			color: #ffffff;
			padding: 6px 10px;
			border-radius: 4px;
			font-size: 11px;
			cursor: pointer;
			transition: all 0.2s ease;
			display: flex;
			align-items: center;
			gap: 3px;
		}

		.edit-community-btn:hover {
			background: rgba(255, 255, 255, 0.08);
			border-color: #4db6ac;
		}

		.delete-community-btn:hover {
			background: rgba(255, 59, 48, 0.1);
			border-color: #FF3B30;
			color: #FF3B30;
		}

		.community-btn {
			background: rgba(255, 255, 255, 0.05);
			color: #ffffff;
			border: 1px solid rgba(255, 255, 255, 0.1);
			padding: 10px 14px;
			border-radius: 6px;
			font-size: 13px;
			font-weight: 500;
			cursor: pointer;
			transition: all 0.2s ease;
			width: 100%;
			text-align: left;
			display: flex;
			align-items: center;
			justify-content: space-between;
		}

		.community-btn:hover {
			background: rgba(255, 255, 255, 0.08);
			border-color: #4db6ac;
		}

		.join-code-section {
			margin-top: 10px;
			padding: 6px 10px;
			background: rgba(77, 182, 172, 0.1);
			border: 1px solid rgba(77, 182, 172, 0.2);
			border-radius: 5px;
			display: flex;
			align-items: center;
			gap: 8px;
		}

		.join-code-label {
			color: #4db6ac;
			font-size: 11px;
			font-weight: 500;
			white-space: nowrap;
		}

		.join-code {
			font-family: 'Courier New', monospace;
			background: rgba(0, 0, 0, 0.3);
			padding: 3px 6px;
			border-radius: 3px;
			font-size: 11px;
			color: #ffffff;
			border: 1px solid rgba(255, 255, 255, 0.1);
			max-width: 120px;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
		}

		.copy-btn {
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid rgba(255, 255, 255, 0.1);
			color: #ffffff;
			padding: 3px 6px;
			border-radius: 3px;
			font-size: 10px;
			cursor: pointer;
			transition: all 0.2s ease;
			flex-shrink: 0;
		}

		.copy-btn:hover {
			background: rgba(255, 255, 255, 0.08);
			border-color: #4db6ac;
		}

		.no-communities {
			text-align: center;
			padding: 60px 20px;
			color: rgba(255, 255, 255, 0.5);
			min-height: 300px;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
		}

		.no-communities i {
			font-size: 32px;
			margin-bottom: 12px;
			color: #4db6ac;
		}

		.no-communities h4 {
			font-size: 16px;
			margin-bottom: 6px;
			color: #ffffff;
		}

		.no-communities p {
			font-size: 13px;
			margin: 0;
		}

		@media (max-width: 768px) {
			.communities-container {
				margin-left: 0;
				padding: 16px;
				left: 0;
				background: #000000;
			}

			.join-community-form {
				flex-direction: column;
				align-items: stretch;
				gap: 12px;
			}
			
			.join-community-form .form-group {
				width: 100%;
			}
			
			.join-community-btn {
				width: 100%;
				justify-content: center;
				margin-top: 0;
			}

			.community-header {
				flex-direction: column;
				align-items: flex-start;
				gap: 8px;
			}

			.community-actions {
				align-self: stretch;
				justify-content: flex-end;
			}
		}
	</style>
</head>
<body class="communities-page">
	<style>
		/* Match community_feed sidebar/menu */
		.communities-page { margin-left: 200px; }
		.communities-page .sidebar { position: fixed !important; top: 0 !important; left: 0 !important; width: 200px !important; height: 100vh !important; background: #1a1a1a !important; border-right: 1px solid #333333 !important; z-index: 1000 !important; display: flex !important; flex-direction: column !important; }
		.communities-page .sidebar-header { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #333333; height: 60px; box-sizing: border-box; }
		.communities-page .sidebar-logo { padding: 5px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
		.communities-page .community-name { flex: 1; display: flex; align-items: center; color: #ffffff; font-size: 16px; font-weight: 600; padding-left: 10px; overflow: hidden; }
		.communities-page .community-name span { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
		.communities-page .sidebar-menu { flex: 1; padding: 10px 0; display: block !important; overflow-y: auto !important; }
		.communities-page .sidebar-menu a { display: block !important; padding: 12px 20px !important; color: #ffffff !important; text-decoration: none !important; transition: all 0.3s ease !important; border: none !important; font-size: 14px !important; }
		.communities-page .sidebar-menu a:hover { background: rgba(77, 182, 172, 0.2) !important; color: #4db6ac !important; padding-left: 25px !important; }
		.communities-page .menu-btn, .communities-page .dropdown-content { display: none !important; }
		@media (max-width: 768px) {
			.communities-page { margin-left: 0 !important; padding-top: 60px !important; }
			.communities-page .sidebar { width: 100% !important; height: 60px !important; overflow: visible !important; }
			.communities-page .sidebar-header { padding: 8px !important; height: 60px !important; }
			.communities-page .community-name { font-size: 14px !important; }
			.communities-page .sidebar-menu { display: none !important; position: absolute !important; top: 60px !important; left: 0 !important; right: 0 !important; background: #1a1a1a !important; border-top: 1px solid #333333 !important; max-height: calc(100vh - 60px) !important; overflow-y: auto !important; }
			.communities-page .sidebar:hover .sidebar-menu, .communities-page .sidebar:focus-within .sidebar-menu { display: block !important; }
		}
	</style>
	<div class="sidebar">
		<div class="sidebar-header">
			<div class="sidebar-logo" id="sidebarLogo"></div>
			<div class="community-name">
				<span>Your Communities</span>
			</div>
		</div>
		<div class="sidebar-menu">
			{% if session['username'] == 'admin' %}
			<a href="{{ url_for('admin_profile') }}">Admin Profile</a>
			<a href="{{ url_for('admin') }}">Admin Dashboard</a>
			{% endif %}
			<a href="{{ url_for('dashboard') }}">Dashboard</a>
			<a href="{{ url_for('profile') }}">Profile</a>
			<a href="{{ url_for('user_chat') }}">Messages</a>
			<a href="{{ url_for('communities') }}">Your Communities</a>
			<a href="{{ url_for('your_sports') }}">Your Sports</a>
			<a href="{{ url_for('logout') }}">Logout</a>
		</div>
	</div>
	
	<div class="communities-container">
		<style>
			/* Align content and header with sidebar */
			.communities-page .communities-container { padding-top: 80px; margin-top: 0; }
			/* Header aligned exactly with sidebar header */
			.communities-header-bar { 
				position: fixed; 
				top: 0; 
				left: 200px; 
				right: 0; 
				height: 60px; 
				padding: 10px;
				background: transparent; 
				border-bottom: 1px solid #333333; 
				z-index: 900;
				box-sizing: border-box;
				display: flex;
				align-items: center;
			}
			@media (max-width: 768px) {
				.communities-header-bar { left: 0 !important; }
			}
		</style>
		<div class="communities-header-bar"></div>
		<div class="communities-header">
			<h1>Your Communities</h1>
			<p>Join existing communities or create your own</p>
		</div>
		
		<!-- Join Community Section -->
		<div class="join-community-section">
			<h3><i class="fas fa-users"></i> Join a Community</h3>
			<form id="joinCommunityForm" class="join-community-form">
				<div class="form-group">
					<label for="communityCode">Community Code</label>
					<input type="text" id="communityCode" name="communityCode" placeholder="Enter community code..." required>
				</div>
				<button type="submit" class="join-community-btn">Join Community</button>
			</form>
			<div id="joinMessage" class="join-message"></div>
		</div>
		
		<!-- Your Joined Communities Section -->
		<div class="joined-communities-section" id="joinedCommunitiesSection" style="display: none;">
			<h3 style="color: #4db6ac; font-size: 14px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 4px;">
				<i class="fas fa-home"></i> Your Communities
			</h3>
			<div id="joinedCommunitiesList" class="joined-communities-list">
				<!-- Joined communities will be loaded here -->
			</div>
		</div>
		
		<!-- Community Creation Section -->
		<div class="community-creation-section">
			<button id="buildCommunityBtn" class="build-community-btn">
				<i class="fas fa-plus"></i> Create New Community
			</button>
		</div>
		
		<!-- Community Creation Modal -->
		<div id="communityModal" class="modal-overlay" style="display: none;">
			<div class="modal-content">
				<div class="modal-header">
					<h3>Create Your Community</h3>
					<button class="modal-close" id="closeModal">&times;</button>
				</div>
				
				<form id="createCommunityForm">
					<div class="form-section">
						<div class="form-group">
							<label for="communityName">Community Name</label>
							<input type="text" id="communityName" name="name" required placeholder="Enter community name">
						</div>
						
						<div class="form-group">
							<label for="communityType">Community Type</label>
							<select id="communityType" name="type" required>
								<option value="">Select a type</option>
								<option value="University">University</option>
								<option value="Fitness">Fitness</option>
								<option value="Yoga">Yoga</option>
								<option value="Running">Running</option>
								<option value="Cycling">Cycling</option>
								<option value="Swimming">Swimming</option>
								<option value="CrossFit">CrossFit</option>
								<option value="Bodybuilding">Bodybuilding</option>
								<option value="Pilates">Pilates</option>
								<option value="Dance">Dance</option>
								<option value="Martial Arts">Martial Arts</option>
								<option value="Other">Other</option>
							</select>
						</div>
						
						<div class="form-group">
							<label for="communityDescription">Description (Optional)</label>
							<textarea id="communityDescription" name="description" rows="2" placeholder="Tell people what your community is about..."></textarea>
						</div>
						
						<div class="form-group">
							<label for="communityLocation">Location (Optional)</label>
							<input type="text" id="communityLocation" name="location" placeholder="City, Country, or Online">
						</div>
						
						<div class="form-group">
							<label for="parentCommunity">Parent Community (Optional)</label>
							<select id="parentCommunity" name="parent_community_id">
								<option value="none">None - This is a top-level community</option>
							</select>
							<small style="color: rgba(255,255,255,0.5); font-size: 11px;">Select a parent community to create an umbrella structure</small>
						</div>
					</div>
					
					<div class="form-section">
						<div class="form-group">
							<label for="communityBackground">Background Image (Optional)</label>
							<div class="background-options">
								<div class="background-option">
									<label for="backgroundFile">Upload from device:</label>
									<input type="file" id="backgroundFile" name="background_file" accept="image/*">
									<div class="file-info" id="fileInfo"></div>
								</div>
								<div class="background-option">
									<label for="backgroundUrl">Or use URL:</label>
									<input type="text" id="backgroundUrl" name="background_url" placeholder="https://example.com/image.jpg">
								</div>
							</div>
							<div class="background-preview" id="backgroundPreview" style="display: none;">
								<img id="previewImage" src="" alt="Preview">
							</div>
						</div>
					</div>
					
					<div class="form-section">
						<div class="form-group">
							<label>Color Theme</label>
							<div class="color-theme-selector">
								<div class="theme-presets">
									<button type="button" class="theme-preset active" data-theme="default">
										<span class="preset-preview default-theme"></span>
										<span class="preset-name">Default</span>
									</button>
									<button type="button" class="theme-preset" data-theme="dark">
										<span class="preset-preview dark-theme"></span>
										<span class="preset-name">Dark</span>
									</button>
									<button type="button" class="theme-preset" data-theme="light">
										<span class="preset-preview light-theme"></span>
										<span class="preset-name">Light</span>
									</button>
									<button type="button" class="theme-preset" data-theme="colorful">
										<span class="preset-preview colorful-theme"></span>
										<span class="preset-name">Colorful</span>
									</button>
								</div>
								<div class="custom-colors-toggle">
									<button type="button" id="customColorsToggle" class="custom-toggle-btn">
										<i class="fas fa-palette"></i> Custom Colors
									</button>
								</div>
								<div class="custom-colors-panel" id="customColorsPanel" style="display: none;">
									<div class="color-grid">
										<div class="color-item">
											<label>Background</label>
											<input type="color" id="backgroundColor" name="background_color" value="#2d3839">
										</div>
										<div class="color-item">
											<label>Text</label>
											<input type="color" id="textColor" name="text_color" value="#ffffff">
										</div>
										<div class="color-item">
											<label>Accent</label>
											<input type="color" id="accentColor" name="accent_color" value="#4db6ac">
										</div>
										<div class="color-item">
											<label>Cards</label>
											<input type="color" id="cardColor" name="card_color" value="#1a2526">
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					
					<div class="form-actions">
						<button type="button" class="cancel-btn" id="cancelCommunityBtn">Cancel</button>
						<button type="submit" class="create-community-btn">Create Community</button>
					</div>
				</form>
			</div>
		</div>



		<!-- Communities Modal -->
		<div id="communitiesModal" class="modal-overlay" style="display: none;">
			<div class="modal-content communities-modal">
				<div class="modal-header">
					<h3><i class="fas fa-home"></i> Your Communities</h3>
					<button class="modal-close" id="closeCommunitiesModal">&times;</button>
				</div>
				<div id="communitiesList" class="communities-list">
					<!-- Communities will be loaded here -->
				</div>
			</div>
		</div>
	</div>

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="{{ url_for('static', filename='script.js') }}"></script>
	<script>
		$(document).ready(function() {
			// Function to load available parent communities
			function loadParentCommunities(currentId = null) {
				const url = currentId 
					? `/get_available_parent_communities?current_id=${currentId}`
					: '/get_available_parent_communities';
				
				$.ajax({
					url: url,
					type: 'GET',
					success: function(response) {
						if (response.success) {
							const select = $('#parentCommunity');
							select.empty();
							select.append('<option value="none">None - This is a top-level community</option>');
							
							response.communities.forEach(function(community) {
								// Don't show communities that already have this as parent (avoid circular)
								select.append(`<option value="${community.id}">${community.name} (${community.type})</option>`);
							});
						}
					},
					error: function(xhr, status, error) {
						console.error('Error loading parent communities:', error);
					}
				});
			}
			
			// Load joined communities on page load
			loadJoinedCommunities();

			// Close communities modal
			$('#closeCommunitiesModal').on('click', function() {
				$('#communitiesModal').hide();
			});

			// Close modal when clicking outside
			$('#communitiesModal').on('click', function(e) {
				if (e.target === this) {
					$(this).hide();
				}
			});

			// Background image preview functionality
			// Handle file upload preview
			$('#backgroundFile').on('change', function() {
				const file = this.files[0];
				if (file) {
					// Clear URL input
					$('#backgroundUrl').val('');
					
					// Show file info
					$('#fileInfo').text(`Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`);
					
					// Preview image
					const reader = new FileReader();
					reader.onload = function(e) {
						$('#previewImage').attr('src', e.target.result);
						$('#backgroundPreview').show();
					};
					reader.readAsDataURL(file);
				}
			});

			// Handle URL input
			$('#backgroundUrl').on('input', function() {
				const url = $(this).val();
				if (url) {
					// Clear file input
					$('#backgroundFile').val('');
					$('#fileInfo').text('');
					
					// Preview image
					$('#previewImage').attr('src', url);
					$('#backgroundPreview').show();
				} else {
					$('#backgroundPreview').hide();
				}
			});

			// Theme preset selection
			$('.theme-preset').on('click', function() {
				$('.theme-preset').removeClass('active');
				$(this).addClass('active');
			});

			// Custom colors toggle
			$('#customColorsToggle').on('click', function() {
				$('#customColorsPanel').toggle();
			});

			// Build community button
			$('#buildCommunityBtn').on('click', function() {
				$('#communityModal').show();
				// Load available parent communities
				loadParentCommunities();
			});

			// Close modal
			$('#closeModal, #cancelCommunityBtn').on('click', function() {
				$('#communityModal').hide();
			});

			// Close modal when clicking outside
			$('#communityModal').on('click', function(e) {
				if (e.target === this) {
					$(this).hide();
				}
			});

			// Join community form
			$('#joinCommunityForm').on('submit', function(e) {
				e.preventDefault();
				const code = $('#communityCode').val().trim();
				
				if (!code) {
					showJoinMessage('Please enter a community code', 'error');
					return;
				}

				$.ajax({
					url: '/join_community',
					method: 'POST',
					data: {
						community_code: code,
						csrf_token: 'disabled'
					},
					success: function(response) {
						if (response.success) {
							// Create success message with link to the community
							let successMessage = 'Successfully joined the community! ';
							if (response.community_id) {
								successMessage += `<a href="/community_feed/${response.community_id}" style="color: #4db6ac; text-decoration: underline; font-weight: 600;">Enter Community →</a>`;
							}
							showJoinMessage(successMessage, 'success');
							$('#communityCode').val('');
							
							// Immediately add the community to the joined list
							if (response.community_id && response.community_name) {
								addCommunityToJoinedList({
									id: response.community_id,
									name: response.community_name,
									type: response.community_type || 'public'
								});
							} else {
								// Fallback to reloading if we don't have the info
								loadJoinedCommunities();
							}
						} else {
							showJoinMessage(response.error || 'Failed to join community', 'error');
						}
					},
					error: function() {
						showJoinMessage('Error joining community. Please try again.', 'error');
					}
				});
			});

			// Create community form
			$('#createCommunityForm').on('submit', function(e) {
				e.preventDefault();
				
				const formData = new FormData(this);
				formData.append('csrf_token', 'disabled');

				$.ajax({
					url: '/create_community',
					method: 'POST',
					data: formData,
					processData: false,
					contentType: false,
					success: function(response) {
						if (response.success) {
							// Get values before resetting form
							const communityName = $('#communityName').val();
							const communityType = $('#communityType').val();
							
							$('#communityModal').hide();
							$('#createCommunityForm')[0].reset();
							$('#backgroundPreview').hide();
							$('#fileInfo').text('');
							
							// Immediately add the new community to the joined list
							
							if (response.community_id) {
								addCommunityToJoinedList({
									id: response.community_id,
									name: communityName || 'New Community',
									type: communityType || 'public'
								});
							}
							
							// Create success message with link to the new community
							let successMessage = 'Community created successfully! ';
							if (response.community_id) {
								successMessage += `<a href="/community_feed/${response.community_id}" style="color: #4db6ac; text-decoration: underline; font-weight: 600;">Enter Community →</a>`;
							}
							showJoinMessage(successMessage, 'success');
						} else {
							showJoinMessage(response.error || 'Failed to create community', 'error');
						}
					},
					error: function() {
						showJoinMessage('Error creating community. Please try again.', 'error');
					}
				});
			});

			function showJoinMessage(message, type) {
				const messageDiv = $('#joinMessage');
				messageDiv.removeClass('success error').addClass(type).html(message).show();
				
				setTimeout(function() {
					messageDiv.fadeOut();
				}, 7000); // Increased timeout to give user time to click the link
			}
		});
		
		// Function to load joined communities
		function loadJoinedCommunities() {
			$.ajax({
				url: '/get_user_communities',
				method: 'GET',
				success: function(response) {
					if (response.success && response.communities && response.communities.length > 0) {
						displayJoinedCommunities(response.communities);
						$('#joinedCommunitiesSection').show();
					} else {
						$('#joinedCommunitiesSection').hide();
					}
				},
				error: function() {
					$('#joinedCommunitiesSection').hide();
				}
			});
		}
		
		// Function to add a single community to the joined list
		function addCommunityToJoinedList(community) {
			// First, check if the section is hidden and show it
			if ($('#joinedCommunitiesSection').is(':hidden')) {
				$('#joinedCommunitiesSection').fadeIn(300);
			}
			
			// Check if community already exists in the list
			if ($(`.joined-community-item[data-community-id="${community.id}"]`).length > 0) {
				return; // Community already in list
			}
			
			const communityHtml = `
				<div class="joined-community-item" data-community-id="${community.id}" style="display: none;">
					<div class="joined-community-info">
						<div class="joined-community-name">${community.name}</div>
						<div class="joined-community-type">${community.type === 'public' ? 'Public' : 'Private'} Community</div>
					</div>
					<div style="display: flex; gap: 6px;">
						<button class="enter-community-btn" data-id="${community.id}">
							Enter
						</button>
						<button class="exit-community-btn" data-id="${community.id}" style="background: rgba(255, 87, 87, 0.2); color: #ff5757; border: 1px solid rgba(255, 87, 87, 0.3);">
							Exit
						</button>
					</div>
				</div>
			`;
			
			const newElement = $(communityHtml);
			$('#joinedCommunitiesList').prepend(newElement);
			newElement.fadeIn(300);
			
			// Add click handlers for the new buttons
			newElement.find('.enter-community-btn').on('click', function(e) {
				e.preventDefault();
				e.stopPropagation();
				const communityId = $(this).data('id');
				window.location.href = `/community_feed/${communityId}`;
			});
			
			newElement.find('.exit-community-btn').on('click', function(e) {
				e.preventDefault();
				e.stopPropagation();
				const communityId = $(this).data('id');
				const communityName = $(this).closest('.joined-community-item').find('.joined-community-name').text();
				
				if (confirm(`Are you sure you want to leave "${communityName}"?`)) {
					leaveCommunity(communityId);
				}
			});
		}
		
		// Function to display joined communities
		function displayJoinedCommunities(communities) {
			const container = $('#joinedCommunitiesList');
			container.empty();
			
			communities.forEach(community => {
				const communityHtml = `
					<div class="joined-community-item" data-community-id="${community.id}">
						<div class="joined-community-info">
							<div class="joined-community-name">${community.name}</div>
							<div class="joined-community-type">${community.type === 'public' ? 'Public' : 'Private'} Community</div>
						</div>
						<div style="display: flex; gap: 6px;">
							<button class="enter-community-btn" data-id="${community.id}">
								Enter
							</button>
							<button class="exit-community-btn" data-id="${community.id}" style="background: rgba(255, 87, 87, 0.2); color: #ff5757; border: 1px solid rgba(255, 87, 87, 0.3);">
								Exit
							</button>
						</div>
					</div>
				`;
				container.append(communityHtml);
			});
			
			// Add click handlers for enter buttons
			$('.enter-community-btn').off('click').on('click', function(e) {
				e.preventDefault();
				e.stopPropagation();
				const communityId = $(this).data('id');
				window.location.href = `/community_feed/${communityId}`;
			});
			
			// Add click handlers for exit buttons
			$('.exit-community-btn').off('click').on('click', function(e) {
				e.preventDefault();
				e.stopPropagation();
				const communityId = $(this).data('id');
				const communityName = $(this).closest('.joined-community-item').find('.joined-community-name').text();
				
				if (confirm(`Are you sure you want to leave "${communityName}"?`)) {
					leaveCommunity(communityId);
				}
			});
		}

		// Function to exit/leave a community
		function leaveCommunity(communityId) {
			// Immediately remove the community from the UI (optimistic update)
			const communityElement = $(`.joined-community-item[data-community-id="${communityId}"]`);
			communityElement.fadeOut(300);
			
			$.ajax({
				url: '/leave_community',
				method: 'POST',
				data: {
					community_id: communityId,
					csrf_token: 'disabled'
				},
				success: function(response) {
					if (response.success) {
						// Remove the element completely after fade
						communityElement.remove();
						
						// Check if there are any communities left
						if ($('.joined-community-item').length === 0) {
							$('#joinedCommunitiesSection').fadeOut(300);
						}
						
						showJoinMessage('Successfully left the community', 'success');
						// Note: We don't reload the lists since we already updated the UI
					} else {
						// If failed, show the element again
						communityElement.fadeIn(300);
						showJoinMessage(response.error || 'Failed to leave community', 'error');
					}
				},
				error: function() {
					// If error, show the element again
					communityElement.fadeIn(300);
					showJoinMessage('Error leaving community. Please try again.', 'error');
				}
			});
		}

		function loadUserCommunities() {
			$.ajax({
				url: '/get_user_communities',
				method: 'GET',
				success: function(response) {
					if (response.success) {
						displayCommunities(response.communities);
					} else {
						$('#communitiesList').html('<div class="error">Error loading communities</div>');
					}
				},
				error: function() {
					$('#communitiesList').html('<div class="error">Error loading communities</div>');
				}
			});
		}

		function displayCommunities(communities) {
			const container = $('#communitiesList');
			
			if (!communities || communities.length === 0) {
				container.html(`
					<div class="no-communities">
						<i class="fas fa-users"></i>
						<h4>No communities yet</h4>
						<p>Join an existing community or create your own to get started</p>
					</div>
				`);
				return;
			}

			const communitiesHtml = communities.map(community => {
				const isDeactivated = community.is_active === false || community.is_active === 0;
				const username = '{{ session.username }}';
				
				return `
				<div class="community-card ${isDeactivated ? 'deactivated' : ''}">
					<div class="community-header">
						<div class="community-info">
							<h4>
								${community.name}
								${isDeactivated ? '<span class="deactivated-badge"><i class="fas fa-ban"></i> Deactivated</span>' : ''}
							</h4>
							<div class="community-meta">
								<span><i class="fas fa-tag"></i> ${community.type}</span>
								${community.location ? `<span><i class="fas fa-map-marker-alt"></i> ${community.location}</span>` : ''}
							</div>
						</div>
						<div class="community-actions">
							<button class="edit-community-btn" onclick="editCommunity(${community.id})">
								<i class="fas fa-edit"></i> Edit
							</button>
							<button class="delete-community-btn" onclick="deleteCommunity(${community.id})">
								<i class="fas fa-trash"></i> Delete
							</button>
						</div>
					</div>
					<button class="community-btn" onclick="location.href='/community_feed/${community.id}'" 
							${isDeactivated && username !== 'admin' ? 'style="opacity: 0.6; cursor: not-allowed;" title="This community is deactivated"' : ''}>
						<span>${isDeactivated ? 'Community Deactivated' : 'View Community'}</span>
						<i class="fas fa-${isDeactivated ? 'lock' : 'arrow-right'}"></i>
					</button>
					<div class="join-code-section">
						<span class="join-code-label">Join Code:</span>
						<span class="join-code">${community.join_code}</span>
						<button class="copy-btn" onclick="copyJoinCode('${community.join_code}')">
							<i class="fas fa-copy"></i>
						</button>
					</div>
				</div>
			`}).join('');

			container.html(communitiesHtml);
		}

		function copyJoinCode(code) {
			navigator.clipboard.writeText(code).then(function() {
				// Show a brief success message
				const btn = event.target.closest('.copy-btn');
				const originalText = btn.innerHTML;
				btn.innerHTML = '<i class="fas fa-check"></i>';
				btn.style.color = '#4db6ac';
				
				setTimeout(function() {
					btn.innerHTML = originalText;
					btn.style.color = '#ffffff';
				}, 1000);
			});
		}

		function editCommunity(communityId) {
			// Implement edit functionality
			console.log('Edit community:', communityId);
		}

		function deleteCommunity(communityId) {
			if (confirm('Are you sure you want to delete this community? This action cannot be undone.')) {
				$.ajax({
					url: '/delete_community',
					method: 'POST',
					data: {
						community_id: communityId,
						csrf_token: 'disabled'
					},
					success: function(response) {
						if (response.success) {
							loadUserCommunities(); // Reload communities list
						} else {
							alert(response.error || 'Failed to delete community');
						}
					},
					error: function() {
						alert('Error deleting community. Please try again.');
					}
				});
			}
		}
	</script>
</body>
</html>