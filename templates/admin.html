<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Admin Dashboard - Workout X</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='apple-design.css') }}">
    <meta name="csrf-token" content="{{ csrf_token() }}">
</head>
<body>
    <div class="page-container">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="navbar-container">
                <a href="{{ url_for('dashboard') }}" class="navbar-brand">Workout X</a>
                <div class="navbar-nav">
                    <a href="{{ url_for('admin') }}" class="nav-link active">Admin</a>
                    <a href="{{ url_for('admin_profile') }}" class="nav-link">Profile</a>
                    <a href="{{ url_for('feed') }}" class="nav-link">Social</a>
                    <a href="{{ url_for('communities') }}" class="nav-link">Communities</a>
                    <a href="{{ url_for('logout') }}" class="nav-link">Logout</a>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <!-- Page Header -->
                <div class="text-center mb-6">
                    <h1>Admin Dashboard</h1>
                    <p class="text-secondary">Manage users, communities, and monitor platform statistics</p>
                </div>

                {% if error %}
                    <div class="alert alert-error mb-6">
                        {{ error }}
                    </div>
                {% endif %}

                <!-- Quick Actions -->
                <div class="card mb-6">
                    <div class="card-header">
                        <h2 class="card-title">Quick Actions</h2>
                        <p class="card-subtitle">Common administrative tasks</p>
                    </div>
                    <div class="card-body">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <button onclick="showStatsModal()" class="btn btn-secondary flex-col h-20">
                                <span class="text-lg mb-1">Statistics</span>
                                <span class="text-sm text-secondary">View Metrics</span>
                            </button>
                            <button onclick="showAddUserModal()" class="btn btn-secondary flex-col h-20">
                                <span class="text-lg mb-1">Add User</span>
                                <span class="text-sm text-secondary">Create Account</span>
                            </button>
                            <button onclick="showAddCommunityModal()" class="btn btn-secondary flex-col h-20">
                                <span class="text-lg mb-1">Create Community</span>
                                <span class="text-sm text-secondary">New Group</span>
                            </button>
                            <button onclick="exportData()" class="btn btn-secondary flex-col h-20">
                                <span class="text-lg mb-1">Export Data</span>
                                <span class="text-sm text-secondary">Download</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- User Management -->
                <div class="card mb-6">
                    <div class="card-header">
                        <h2 class="card-title">User Management</h2>
                        <p class="card-subtitle">Manage platform users and accounts</p>
                    </div>
                    <div class="card-body">
                        <div class="flex flex-col md:flex-row gap-4 mb-6">
                            <div class="flex-1">
                                <input type="text" id="userSearch" placeholder="Search users..." class="form-input">
                            </div>
                            <div class="w-full md:w-48">
                                <select id="userFilter" class="form-input form-select">
                                    <option value="all">All Users</option>
                                    <option value="premium">Premium Only</option>
                                    <option value="free">Free Only</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="usersGrid">
                            {% for user in users %}
                            <div class="card bg-tertiary" data-username="{{ user[0] }}" data-subscription="{{ user[1] }}">
                                <div class="card-body">
                                    <div class="flex items-center justify-between mb-4">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-accent-blue rounded-full flex items-center justify-center text-white font-medium">
                                                {{ user[0][0].upper() }}
                                            </div>
                                            <div>
                                                <h4 class="font-medium">{{ user[0] }}</h4>
                                                <span class="px-2 py-1 text-xs rounded-full {{ 'bg-accent-green text-white' if user[1] == 'premium' else 'bg-secondary text-secondary' }}">
                                                    {{ user[1]|title }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="showPasswordModal('{{ user[0] }}')" class="btn btn-sm btn-secondary flex-1">
                                            Password
                                        </button>
                                        <button onclick="showUserDetails('{{ user[0] }}')" class="btn btn-sm btn-secondary flex-1">
                                            Details
                                        </button>
                                        {% if user[0] != 'admin' %}
                                        <button onclick="deleteUser('{{ user[0] }}')" class="btn btn-sm btn-danger">
                                            Delete
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Community Management -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Community Management</h2>
                        <p class="card-subtitle">Manage platform communities and groups</p>
                    </div>
                    <div class="card-body">
                        <div class="mb-6">
                            <input type="text" id="communitySearch" placeholder="Search communities..." class="form-input">
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="communitiesGrid">
                            {% for community in communities %}
                            <div class="card bg-tertiary" data-name="{{ community.name }}">
                                <div class="card-body">
                                    <div class="flex items-center justify-between mb-4">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-accent-orange rounded-full flex items-center justify-center text-white font-medium">
                                                {{ community.name[0].upper() }}
                                            </div>
                                            <div>
                                                <h4 class="font-medium">{{ community.name }}</h4>
                                                <p class="text-sm text-secondary">{{ community.type }}</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-2 mb-4">
                                        <div class="flex justify-between text-sm">
                                            <span class="text-secondary">Creator:</span>
                                            <span>{{ community.creator_username }}</span>
                                        </div>
                                        <div class="flex justify-between text-sm">
                                            <span class="text-secondary">Members:</span>
                                            <span>{{ community.member_count }}</span>
                                        </div>
                                        <div class="flex justify-between text-sm items-center">
                                            <span class="text-secondary">Join Code:</span>
                                            <div class="flex items-center gap-2">
                                                <span class="font-mono text-xs">{{ community.join_code }}</span>
                                                <button onclick="copyJoinCode('{{ community.join_code }}')" class="btn btn-sm btn-secondary">
                                                    Copy
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex gap-2">
                                        <a href="/community_feed/{{ community.id }}" class="btn btn-sm btn-secondary flex-1">
                                            View
                                        </a>
                                        <button onclick="showCommunityMembers('{{ community.id }}', '{{ community.name }}')" class="btn btn-sm btn-secondary flex-1">
                                            Members
                                        </button>
                                        <button onclick="deleteCommunity({{ community.id }}, '{{ community.name }}')" class="btn btn-sm btn-danger">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Password Update Modal -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Update Password</h3>
                    <button onclick="closePasswordModal()" class="btn btn-sm btn-secondary">Close</button>
                </div>
                <div class="card-body">
                    <form id="passwordForm" class="space-y-4">
                        <div class="form-group">
                            <label for="targetUsername" class="form-label">Username</label>
                            <input type="text" id="targetUsername" class="form-input" readonly>
                        </div>
                        <div class="form-group">
                            <label for="newPassword" class="form-label">New Password</label>
                            <input type="password" id="newPassword" class="form-input" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword" class="form-label">Confirm Password</label>
                            <input type="password" id="confirmPassword" class="form-input" required minlength="6">
                        </div>
                        <div class="flex gap-3">
                            <button type="button" onclick="closePasswordModal()" class="btn btn-secondary flex-1">Cancel</button>
                            <button type="submit" class="btn btn-primary flex-1">Update Password</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Add New User</h3>
                    <button onclick="closeAddUserModal()" class="btn btn-sm btn-secondary">Close</button>
                </div>
                <div class="card-body">
                    <form id="addUserForm" method="POST" class="space-y-4">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="form-group">
                            <label for="newUsername" class="form-label">Username</label>
                            <input type="text" name="new_username" id="newUsername" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="newUserPassword" class="form-label">Password</label>
                            <input type="password" name="new_password" id="newUserPassword" class="form-input" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label for="newUserSubscription" class="form-label">Subscription</label>
                            <select name="new_subscription" id="newUserSubscription" class="form-input form-select">
                                <option value="free">Free</option>
                                <option value="premium">Premium</option>
                            </select>
                        </div>
                        <div class="flex gap-3">
                            <button type="button" onclick="closeAddUserModal()" class="btn btn-secondary flex-1">Cancel</button>
                            <button type="submit" name="add_user" class="btn btn-primary flex-1">Add User</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div id="statsModal" class="modal">
        <div class="modal-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Platform Statistics</h3>
                    <button onclick="closeStatsModal()" class="btn btn-sm btn-secondary">Close</button>
                </div>
                <div class="card-body">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center p-4 bg-tertiary rounded-lg">
                            <div class="text-2xl font-bold text-accent-blue mb-1">{{ stats.total_users }}</div>
                            <div class="text-sm text-secondary">Total Users</div>
                        </div>
                        <div class="text-center p-4 bg-tertiary rounded-lg">
                            <div class="text-2xl font-bold text-accent-orange mb-1">{{ stats.total_communities }}</div>
                            <div class="text-sm text-secondary">Communities</div>
                        </div>
                        <div class="text-center p-4 bg-tertiary rounded-lg">
                            <div class="text-2xl font-bold text-accent-green mb-1">{{ stats.premium_users }}</div>
                            <div class="text-sm text-secondary">Premium Users</div>
                        </div>
                        <div class="text-center p-4 bg-tertiary rounded-lg">
                            <div class="text-2xl font-bold text-accent-purple mb-1">{{ stats.total_posts }}</div>
                            <div class="text-sm text-secondary">Total Posts</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Community Members Modal -->
    <div id="membersModal" class="modal">
        <div class="modal-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Community Members</h3>
                    <button onclick="closeMembersModal()" class="btn btn-sm btn-secondary">Close</button>
                </div>
                <div class="card-body">
                    <div id="membersList" class="space-y-3">
                        <!-- Members will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Modal Functions
        function showStatsModal() {
            document.getElementById('statsModal').style.display = 'block';
        }

        function closeStatsModal() {
            document.getElementById('statsModal').style.display = 'none';
        }

        function showPasswordModal(username) {
            document.getElementById('targetUsername').value = username;
            document.getElementById('passwordModal').style.display = 'block';
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('passwordForm').reset();
        }

        function showAddUserModal() {
            document.getElementById('addUserModal').style.display = 'block';
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').style.display = 'none';
            document.getElementById('addUserForm').reset();
        }

        function showCommunityMembers(communityId, communityName) {
            document.getElementById('membersModal').style.display = 'block';
            // Load members via AJAX
            $.get(`/get_community_members/${communityId}`, function(data) {
                const membersList = document.getElementById('membersList');
                membersList.innerHTML = '';
                
                data.members.forEach(member => {
                    const memberDiv = document.createElement('div');
                    memberDiv.className = 'flex items-center justify-between p-3 bg-tertiary rounded-lg';
                    memberDiv.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-accent-blue rounded-full flex items-center justify-center text-white text-sm font-medium">
                                ${member.username[0].toUpperCase()}
                            </div>
                            <span class="font-medium">${member.username}</span>
                        </div>
                        <span class="text-sm text-secondary">${member.joined_date}</span>
                    `;
                    membersList.appendChild(memberDiv);
                });
            });
        }

        function closeMembersModal() {
            document.getElementById('membersModal').style.display = 'none';
        }

        // User Management Functions
        function deleteUser(username) {
            if (confirm(`Are you sure you want to delete user "${username}"?`)) {
                $.post('/delete_user', {
                    username: username,
                    csrf_token: $('meta[name="csrf-token"]').attr('content')
                }, function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert('Error deleting user: ' + response.error);
                    }
                });
            }
        }

        function showUserDetails(username) {
            // Implement user details view
            alert('User details for: ' + username);
        }

        // Community Management Functions
        function deleteCommunity(communityId, communityName) {
            if (confirm(`Are you sure you want to delete community "${communityName}"?`)) {
                $.post('/delete_community', {
                    community_id: communityId,
                    csrf_token: $('meta[name="csrf-token"]').attr('content')
                }, function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert('Error deleting community: ' + response.error);
                    }
                });
            }
        }

        function copyJoinCode(code) {
            navigator.clipboard.writeText(code).then(function() {
                alert('Join code copied to clipboard: ' + code);
            });
        }

        // Search and Filter Functions
        $('#userSearch').on('input', function() {
            const searchTerm = $(this).val().toLowerCase();
            $('.card[data-username]').each(function() {
                const username = $(this).data('username').toLowerCase();
                $(this).toggle(username.includes(searchTerm));
            });
        });

        $('#userFilter').on('change', function() {
            const filter = $(this).val();
            $('.card[data-username]').each(function() {
                const subscription = $(this).data('subscription');
                if (filter === 'all' || subscription === filter) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

        $('#communitySearch').on('input', function() {
            const searchTerm = $(this).val().toLowerCase();
            $('.card[data-name]').each(function() {
                const name = $(this).data('name').toLowerCase();
                $(this).toggle(name.includes(searchTerm));
            });
        });

        // Form Submissions
        $('#passwordForm').on('submit', function(e) {
            e.preventDefault();
            const newPassword = $('#newPassword').val();
            const confirmPassword = $('#confirmPassword').val();
            
            if (newPassword !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }
            
            $.post('/update_user_password', {
                username: $('#targetUsername').val(),
                new_password: newPassword,
                csrf_token: $('meta[name="csrf-token"]').attr('content')
            }, function(response) {
                if (response.success) {
                    alert('Password updated successfully');
                    closePasswordModal();
                } else {
                    alert('Error updating password: ' + response.error);
                }
            });
        });

        // Close modals when clicking outside
        $(window).on('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });

        // Close modals with Escape key
        $(document).on('keydown', function(e) {
            if (e.key === 'Escape') {
                $('.modal').hide();
            }
        });

        // Export data function
        function exportData() {
            alert('Export functionality would be implemented here');
        }

        // Show add community modal function
        function showAddCommunityModal() {
            alert('Add community functionality would be implemented here');
        }
    </script>

    <style>
        /* Additional styles for admin dashboard */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            position: relative;
            margin: 5% auto;
            width: 90%;
            max-width: 500px;
        }

        .bg-tertiary {
            background: var(--bg-tertiary);
        }

        .text-accent-blue {
            color: var(--accent-blue);
        }

        .text-accent-green {
            color: var(--accent-green);
        }

        .text-accent-orange {
            color: var(--accent-orange);
        }

        .text-accent-purple {
            color: var(--accent-purple);
        }

        .bg-accent-blue {
            background: var(--accent-blue);
        }

        .bg-accent-orange {
            background: var(--accent-orange);
        }

        .bg-accent-green {
            background: var(--accent-green);
        }

        .bg-secondary {
            background: var(--bg-secondary);
        }

        .text-secondary {
            color: var(--text-secondary);
        }

        .font-mono {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
        }

        .text-xs {
            font-size: var(--font-size-xs);
        }

        .h-20 {
            height: 5rem;
        }

        .space-y-2 > * + * {
            margin-top: var(--space-2);
        }

        .space-y-3 > * + * {
            margin-top: var(--space-3);
        }

        .space-y-4 > * + * {
            margin-top: var(--space-4);
        }

        .flex-1 {
            flex: 1;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .modal-content {
                margin: 10% auto;
                width: 95%;
            }
            
            .grid-cols-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</body>
</html>