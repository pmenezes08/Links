<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Workout X</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <meta name="csrf-token" content="disabled">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="sidebar">
        <button class="menu-btn"><i class="fas fa-bars"></i> Menu</button>
        <div class="dropdown-content">
            <a href="{{ url_for('dashboard') }}">Dashboard</a>
            <a href="{{ url_for('free_workouts') }}">Free Workouts</a>
            <a href="{{ url_for('premium_dashboard') }}">Premium Dashboard</a>
            <a href="{{ url_for('feed') }}">Social</a>
            <a href="{{ url_for('communities') }}">Your Communities</a>
            <a href="{{ url_for('your_sports') }}">Your Sports</a>
            {% if session['username'] == 'admin' %}
            <a href="{{ url_for('admin') }}">Admin Dashboard</a>
            <a href="{{ url_for('admin_profile') }}">Admin Profile</a>
            {% endif %}
            <a href="{{ url_for('logout') }}">Logout</a>
        </div>
    </div>
    
    <div class="container admin-dashboard">
        <div class="admin-header">
            <h1><i class="fas fa-shield-alt"></i> Admin Dashboard</h1>
            <p class="admin-subtitle">Manage users, communities, and monitor platform statistics</p>
        </div>

        {% if error %}
            <div class="error-message">
                <i class="fas fa-exclamation-triangle"></i>
                <p>{{ error }}</p>
            </div>
        {% endif %}

        <!-- Quick Actions -->
        <div class="quick-actions">
            <h2><i class="fas fa-bolt"></i> Quick Actions</h2>
            <div class="action-buttons">
                <button onclick="showStatsModal()" class="action-btn">
                    <i class="fas fa-chart-bar"></i>
                    View Statistics
                </button>
                <button onclick="showAddUserModal()" class="action-btn">
                    <i class="fas fa-user-plus"></i>
                    Add User
                </button>
                <button onclick="showAddCommunityModal()" class="action-btn">
                    <i class="fas fa-plus-circle"></i>
                    Create Community
                </button>
                <button onclick="exportData()" class="action-btn">
                    <i class="fas fa-download"></i>
                    Export Data
                </button>
            </div>
        </div>



        <!-- User Management Section -->
        <div class="admin-section">
            <div class="section-header">
                <h2><i class="fas fa-users"></i> User Management</h2>
                <div class="section-actions">
                    <input type="text" id="userSearch" placeholder="Search users..." class="search-input">
                    <select id="userFilter" class="filter-select">
                        <option value="all">All Users</option>
                        <option value="premium">Premium Only</option>
                        <option value="free">Free Only</option>
                    </select>
                </div>
            </div>
            
            <div class="users-grid" id="usersGrid">
                {% for user in users %}
                <div class="user-card" data-username="{{ user[0] }}" data-subscription="{{ user[1] }}">
                    <div class="user-header">
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="user-info">
                            <h4>{{ user[0] }}</h4>
                            <span class="subscription-badge {{ user[1] }}">
                                {{ user[1]|title }}
                            </span>
                        </div>
                    </div>
                    <div class="user-actions">
                        <button onclick="showPasswordModal('{{ user[0] }}')" class="action-btn small">
                            <i class="fas fa-key"></i>
                        </button>
                        <button onclick="showUserDetails('{{ user[0] }}')" class="action-btn small">
                            <i class="fas fa-eye"></i>
                        </button>
                        {% if user[0] != 'admin' %}
                        <button onclick="deleteUser('{{ user[0] }}')" class="action-btn small danger">
                            <i class="fas fa-trash"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Community Management Section -->
        <div class="admin-section">
            <div class="section-header">
                <h2><i class="fas fa-layer-group"></i> Community Management</h2>
                <div class="section-actions">
                    <input type="text" id="communitySearch" placeholder="Search communities..." class="search-input">
                </div>
            </div>
            
            <div class="communities-grid" id="communitiesGrid">
                {% for community in communities %}
                <div class="community-card" data-name="{{ community.name }}">
                    <div class="community-header">
                        <div class="community-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="community-info">
                            <h4>{{ community.name }}</h4>
                            <p class="community-type">{{ community.type }}</p>
                        </div>
                    </div>
                    <div class="community-details">
                        <div class="detail-item">
                            <span class="label">Creator:</span>
                            <span class="value">{{ community.creator_username }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Members:</span>
                            <span class="value">{{ community.member_count }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Join Code:</span>
                            <span class="value join-code">{{ community.join_code }}</span>
                            <button onclick="copyJoinCode('{{ community.join_code }}')" class="copy-btn" title="Copy">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                                         <div class="community-actions">
                         <button onclick="location.href='/community_feed/{{ community.id }}'" class="action-btn small">
                             <i class="fas fa-eye"></i>
                         </button>
                         <button onclick="showCommunityMembers('{{ community.id }}', '{{ community.name }}')" class="action-btn small">
                             <i class="fas fa-users"></i>
                         </button>
                         <button onclick="deleteCommunity({{ community.id }}, '{{ community.name }}')" class="action-btn small danger">
                             <i class="fas fa-trash"></i>
                         </button>
                     </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Password Update Modal -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-key"></i> Update Password</h3>
                <span class="close" onclick="closePasswordModal()">&times;</span>
            </div>
            <form id="passwordForm">
                <div class="form-group">
                    <label for="targetUsername">Username:</label>
                    <input type="text" id="targetUsername" readonly>
                </div>
                <div class="form-group">
                    <label for="newPassword">New Password:</label>
                    <input type="password" id="newPassword" required minlength="6">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password:</label>
                    <input type="password" id="confirmPassword" required minlength="6">
                </div>
                <div class="form-actions">
                    <button type="button" onclick="closePasswordModal()" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Update Password</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Add New User</h3>
                <span class="close" onclick="closeAddUserModal()">&times;</span>
            </div>
            <form id="addUserForm" method="POST">
                                        <input type="hidden" name="csrf_token" value="disabled">
                <div class="form-group">
                    <label for="newUsername">Username:</label>
                    <input type="text" name="new_username" id="newUsername" required>
                </div>
                <div class="form-group">
                    <label for="newUserPassword">Password:</label>
                    <input type="password" name="new_password" id="newUserPassword" required minlength="6">
                </div>
                <div class="form-group">
                    <label for="newUserSubscription">Subscription:</label>
                    <select name="new_subscription" id="newUserSubscription">
                        <option value="free">Free</option>
                        <option value="premium">Premium</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" onclick="closeAddUserModal()" class="btn-secondary">Cancel</button>
                    <button type="submit" name="add_user" class="btn-primary">Add User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div id="statsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-chart-bar"></i> Platform Statistics</h3>
                <span class="close" onclick="closeStatsModal()">&times;</span>
            </div>
            <div class="stats-modal-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ stats.total_users }}</h3>
                            <p>Total Users</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ stats.total_communities }}</h3>
                            <p>Communities</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-crown"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ stats.premium_users }}</h3>
                            <p>Premium Users</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ stats.total_posts }}</h3>
                            <p>Total Posts</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Community Members Modal -->
    <div id="membersModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-users"></i> Community Members</h3>
                <span class="close" onclick="closeMembersModal()">&times;</span>
            </div>
            <div id="membersList" class="members-list">
                <!-- Members will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Statistics Modal Functions
        function showStatsModal() {
            document.getElementById('statsModal').style.display = 'block';
        }

        function closeStatsModal() {
            document.getElementById('statsModal').style.display = 'none';
        }

        // Password Update Functions
        function showPasswordModal(username) {
            document.getElementById('targetUsername').value = username;
            document.getElementById('passwordModal').style.display = 'block';
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('passwordForm').reset();
        }

        document.getElementById('passwordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            updateUserPassword();
        });

        function updateUserPassword() {
            const username = document.getElementById('targetUsername').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long!');
                return;
            }
            
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            
            fetch('/update_user_password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: `username=${encodeURIComponent(username)}&new_password=${encodeURIComponent(newPassword)}&csrf_token=${csrfToken}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    closePasswordModal();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating password. Please try again.');
            });
        }

        // Add User Functions
        function showAddUserModal() {
            document.getElementById('addUserModal').style.display = 'block';
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').style.display = 'none';
            document.getElementById('addUserForm').reset();
        }

        // Community Members Functions
        function showCommunityMembers(communityId, communityName) {
            document.getElementById('membersModal').style.display = 'block';
            loadCommunityMembers(communityId, communityName);
        }

        function closeMembersModal() {
            document.getElementById('membersModal').style.display = 'none';
        }

        function loadCommunityMembers(communityId, communityName) {
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            
            fetch('/get_community_members', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: `community_id=${communityId}&csrf_token=${csrfToken}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayCommunityMembers(data.members, communityName);
                } else {
                    document.getElementById('membersList').innerHTML = '<p class="error">Error loading members</p>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('membersList').innerHTML = '<p class="error">Error loading members</p>';
            });
        }

        function displayCommunityMembers(members, communityName) {
            const membersList = document.getElementById('membersList');
            let html = `<h4>${communityName} Members (${members.length})</h4>`;
            
            if (members.length === 0) {
                html += '<p class="no-members">No members found</p>';
            } else {
                html += '<div class="members-grid">';
                members.forEach(member => {
                    html += `
                        <div class="member-item">
                            <div class="member-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="member-info">
                                <div class="member-name">${member.username}</div>
                                <div class="member-joined">Joined: ${member.joined_date}</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            membersList.innerHTML = html;
        }

        // Search and Filter Functions
        document.getElementById('userSearch').addEventListener('input', function() {
            filterUsers();
        });

        document.getElementById('userFilter').addEventListener('change', function() {
            filterUsers();
        });

        function filterUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const filterValue = document.getElementById('userFilter').value;
            const userCards = document.querySelectorAll('.user-card');
            
            userCards.forEach(card => {
                const username = card.dataset.username.toLowerCase();
                const subscription = card.dataset.subscription;
                const matchesSearch = username.includes(searchTerm);
                const matchesFilter = filterValue === 'all' || subscription === filterValue;
                
                card.style.display = matchesSearch && matchesFilter ? 'block' : 'none';
            });
        }

        document.getElementById('communitySearch').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const communityCards = document.querySelectorAll('.community-card');
            
            communityCards.forEach(card => {
                const name = card.dataset.name.toLowerCase();
                card.style.display = name.includes(searchTerm) ? 'block' : 'none';
            });
        });

        // Utility Functions
        function copyJoinCode(joinCode) {
            navigator.clipboard.writeText(joinCode).then(function() {
                showNotification('Join code copied to clipboard!', 'success');
            });
        }

        function deleteUser(username) {
            if (confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) {
                const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                const form = document.createElement('form');
                form.method = 'POST';
                form.innerHTML = `
                    <input type="hidden" name="username" value="${username}">
                    <input type="hidden" name="delete_user" value="1">
                    <input type="hidden" name="csrf_token" value="${csrfToken}">
                `;
                document.body.appendChild(form);
                form.submit();
            }
        }

        function deleteCommunity(communityId, communityName) {
            if (confirm(`Are you sure you want to delete the community "${communityName}"?\n\nThis will permanently delete the community and all its posts. This action cannot be undone.`)) {
                const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                const form = document.createElement('form');
                form.method = 'POST';
                form.innerHTML = `
                    <input type="hidden" name="community_id" value="${communityId}">
                    <input type="hidden" name="delete_community" value="1">
                    <input type="hidden" name="csrf_token" value="${csrfToken}">
                `;
                document.body.appendChild(form);
                form.submit();
            }
        }

        function showUserDetails(username) {
            // Implement user details view
            alert(`User details for ${username} - Feature coming soon!`);
        }

        function exportData() {
            // Implement data export
            alert('Data export feature coming soon!');
        }

        function showAddCommunityModal() {
            // Implement add community modal
            alert('Add community feature coming soon!');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : '#007bff'};
                color: white;
                padding: 12px 20px;
                border-radius: 4px;
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);

        // Menu dropdown functionality
        $(document).ready(function() {
            $('.menu-btn').click(function() {
                $('.dropdown-content').toggle();
            });
            
            $(window).resize(function() {
                if ($(window).width() > 768) {
                    $('.dropdown-content').hide();
                }
            });
            
            // Close dropdown when clicking outside
            $(document).click(function(event) {
                if (!$(event.target).closest('.sidebar').length) {
                    $('.dropdown-content').hide();
                }
            });
        });

        // Fallback vanilla JavaScript for menu
        document.addEventListener('DOMContentLoaded', function() {
            const menuBtn = document.querySelector('.menu-btn');
            const dropdownContent = document.querySelector('.dropdown-content');
            const sidebar = document.querySelector('.sidebar');
            
            console.log('Menu button found:', menuBtn);
            console.log('Dropdown content found:', dropdownContent);
            console.log('Sidebar found:', sidebar);
            
            if (sidebar) {
                const sidebarRect = sidebar.getBoundingClientRect();
                const sidebarStyles = window.getComputedStyle(sidebar);
                console.log('Sidebar position:', {
                    top: sidebarRect.top,
                    left: sidebarRect.left,
                    width: sidebarRect.width,
                    height: sidebarRect.height
                });
                console.log('Sidebar styles:', {
                    position: sidebarStyles.position,
                    zIndex: sidebarStyles.zIndex
                });
            }
            
            if (menuBtn && dropdownContent) {
                menuBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Menu button clicked!');
                    const currentDisplay = dropdownContent.style.display;
                    dropdownContent.style.display = currentDisplay === 'block' ? 'none' : 'block';
                    console.log('Dropdown display set to:', dropdownContent.style.display);
                    
                    // Debug: Check dropdown position and visibility
                    if (dropdownContent.style.display === 'block') {
                        const rect = dropdownContent.getBoundingClientRect();
                        const styles = window.getComputedStyle(dropdownContent);
                        console.log('Dropdown position:', {
                            top: rect.top,
                            left: rect.left,
                            width: rect.width,
                            height: rect.height,
                            visible: rect.width > 0 && rect.height > 0
                        });
                        console.log('Dropdown styles:', {
                            display: styles.display,
                            position: styles.position,
                            zIndex: styles.zIndex,
                            backgroundColor: styles.backgroundColor,
                            visibility: styles.visibility,
                            opacity: styles.opacity
                        });
                    }
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', function(event) {
                    if (!event.target.closest('.sidebar')) {
                        dropdownContent.style.display = 'none';
                    }
                });
            }
        });
    </script>
</body>
</html>