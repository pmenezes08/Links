<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ community.name }} - Social</title>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css', v='2.0') }}">
    <style>
        /* Custom color styles */
        .composer-card, .post {
            background-color: {{ community.card_color or '#1a2526' }} !important;
            border-color: {{ community.accent_color or '#4db6ac' }} !important;
            color: {{ community.text_color or '#ffffff' }} !important;
        }
        
        .composer-input {
            background-color: {{ community.card_color or '#1a2526' }} !important;
            color: {{ community.text_color or '#ffffff' }} !important;
            border-color: {{ community.accent_color or '#4db6ac' }} !important;
        }
        
        .post-header strong {
            color: {{ community.text_color or '#ffffff' }} !important;
        }
        
        .post p {
            color: {{ community.text_color or '#ffffff' }} !important;
        }
        
        .reaction-btn {
            color: {{ community.text_color or '#ffffff' }} !important;
        }
        
        .reaction-btn.active {
            color: {{ community.accent_color or '#4db6ac' }} !important;
        }
        
        .sleek-btn {
            background-color: {{ community.accent_color or '#4db6ac' }} !important;
            color: {{ community.text_color or '#ffffff' }} !important;
        }
        
        .sleek-btn:hover {
            background-color: {{ community.accent_color or '#4db6ac' }}dd !important;
        }
        
        body {
            background-color: {{ community.background_color or '#2d3839' }} !important;
        }
        
        .community-header-image {
            border-color: {{ community.accent_color or '#4db6ac' }} !important;
        }

        /* Admin Info Styles */
        .community-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .admin-info-btn {
            background-color: {{ community.accent_color or '#4db6ac' }} !important;
            color: {{ community.text_color or '#ffffff' }} !important;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .admin-info-btn:hover {
            opacity: 0.8;
        }

        .admin-info-section {
            background-color: {{ community.card_color or '#1a2526' }} !important;
            border: 1px solid {{ community.accent_color or '#4db6ac' }} !important;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 16px;
        }

        .admin-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .admin-info-header h3 {
            color: {{ community.text_color or '#ffffff' }} !important;
            font-size: 16px;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .close-admin-info {
            background: none;
            border: none;
            color: {{ community.text_color or '#ffffff' }} !important;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
        }

        .admin-info-content {
            display: grid;
            gap: 20px;
        }

        .info-section, .files-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            padding: 12px;
        }

        .info-section h4, .files-section h4 {
            color: {{ community.text_color or '#ffffff' }} !important;
            font-size: 14px;
            margin: 0 0 8px 0;
        }

        #communityInfo {
            width: 100%;
            background-color: {{ community.card_color or '#1a2526' }} !important;
            color: {{ community.text_color or '#ffffff' }} !important;
            border: 1px solid {{ community.accent_color or '#4db6ac' }} !important;
            border-radius: 4px;
            padding: 8px;
            font-size: 13px;
            resize: vertical;
            margin-bottom: 8px;
        }

        .file-upload-area {
            border: 2px dashed {{ community.accent_color or '#4db6ac' }} !important;
            border-radius: 6px;
            padding: 16px;
            text-align: center;
            margin-bottom: 12px;
        }

        .file-upload-area input[type="file"] {
            display: none;
        }

        .file-upload-label {
            color: {{ community.accent_color or '#4db6ac' }} !important;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 13px;
        }

        .community-files {
            display: grid;
            gap: 8px;
        }

        .community-file {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            padding: 8px 12px;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 8px;
            color: {{ community.text_color or '#ffffff' }} !important;
            font-size: 12px;
        }

        .file-actions {
            display: flex;
            gap: 4px;
        }

        .file-action-btn {
            background: none;
            border: none;
            color: {{ community.accent_color or '#4db6ac' }} !important;
            cursor: pointer;
            padding: 2px 4px;
            font-size: 11px;
        }

        .file-action-btn:hover {
            opacity: 0.7;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <meta name="current-username" content="{{ username }}">
    <script src="{{ url_for('static', filename='script.js', v='2.0') }}"></script>
</head>
<body>
    <!-- Sidebar Menu -->
    <div class="sidebar">
        <button class="menu-btn">â˜° Menu</button>
        <div class="dropdown-content">
            <a href="{{ url_for('dashboard') }}">Dashboard</a>
            <a href="{{ url_for('free_workouts') }}">Free Workouts</a>
            <a href="{{ url_for('premium_dashboard') }}">Premium Dashboard</a>
            <a href="{{ url_for('feed') }}">Social</a>
            <a href="{{ url_for('communities') }}">Your Communities</a>
            <a href="{{ url_for('logout') }}">Logout</a>
            <span id="unread-badge" class="unread-badge hidden">0</span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container feed">
        {% if community.background_path %}
        <div class="community-header-image">
            <img src="{% if community.background_path.startswith('http') %}{{ community.background_path }}{% else %}{{ url_for('static', filename=community.background_path) }}{% endif %}" alt="{{ community.name }} Header" class="header-image">
        </div>
        {% endif %}
        <div class="community-header">
            <h1>{{ community.name }}</h1>
            <p class="community-type">{{ community.type }} Community</p>
            <div class="community-actions">
                <button class="members-btn" onclick="showMembersModal()">
                    <i class="fas fa-users"></i> Members
                </button>
                {% if username == community.creator_username or username == 'admin' %}
                <button class="admin-info-btn" onclick="showAdminInfoModal()">
                    <i class="fas fa-info-circle"></i> Community Info
                </button>
                {% endif %}
            </div>
        </div>

        <!-- Admin Info Section (only visible to admin/creator) -->
        {% if username == community.creator_username or username == 'admin' %}
        <div class="admin-info-section" id="adminInfoSection" style="display: none;">
            <div class="admin-info-header">
                <h3><i class="fas fa-info-circle"></i> Community Information</h3>
                <button class="close-admin-info" onclick="hideAdminInfo()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="admin-info-content">
                <div class="info-section">
                    <h4>Important Information</h4>
                    <textarea id="communityInfo" placeholder="Add important information for community members..." rows="4">{{ community.info or '' }}</textarea>
                    <button onclick="saveCommunityInfo()" class="sleek-btn small">Save Info</button>
                </div>
                <div class="files-section">
                    <h4>Important Files</h4>
                    <div class="file-upload-area">
                        <input type="file" id="communityFile" multiple accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif">
                        <label for="communityFile" class="file-upload-label">
                            <i class="fas fa-upload"></i> Upload Files
                        </label>
                    </div>
                    <div id="communityFiles" class="community-files">
                        <!-- Files will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Composer -->
        <div class="composer-card">
            <form action="/post_status" method="POST" class="composer-form" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <input type="hidden" name="community_id" value="{{ community.id }}">
                <div class="composer-inner">
                    <div class="composer-body">
                        <input type="text" name="content" class="composer-input" placeholder="What is happening in {{ community.name }}?!">
                        <div class="composer-actions">
                            <div class="file-upload-container">
                                <label for="image-upload" class="file-upload-btn">
                                    <i class="fas fa-paperclip"></i>
                                </label>
                                <input type="file" id="image-upload" name="image" accept="image/*" style="display: none;">
                                <span id="selected-file-name" class="selected-file-name"></span>
                            </div>
                            <button type="submit" class="sleek-btn small">Post to {{ community.name }}</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Posts Display -->
        <div class="posts timeline">
            {% if posts %}
                {% for post in posts %}
                    <div class="post clickable-post" data-post-id="{{ post.id }}">
                        <div class="post-header"><strong>@{{ post.username }}</strong><span class="timestamp">{{ post.timestamp | format_date('%m/%d/%y %I:%M %p') }}</span></div>
                        <p>{{ post.content }}</p>
                        {% if post.image_path and post.image_path != 'None' and post.image_path != '' %}
                            <div class="post-image">
                                <img src="{{ url_for('uploaded_file', filename=post.image_path.replace('uploads/', '')) if post.image_path.startswith('uploads/') else url_for('uploaded_file', filename=post.image_path) }}" 
                                     alt="Post image" 
                                     loading="lazy" 
                                     onerror="console.log('Image failed to load:', this.src); this.style.display='none'; this.parentElement.innerHTML='<div style=\'padding: 20px; text-align: center; color: #9fb0b5;\'>Image could not be loaded</div>';" 
                                     onload="console.log('Image loaded successfully:', this.src);"
                                     style="max-width: 100%; height: auto; display: block;">
                            </div>
                        {% endif %}
                        <div class="post-actions">
                            <div class="reactions">
                                <button class="reaction-btn heart {{ 'active' if post.user_reaction == 'heart' }}" data-reaction="heart" aria-label="Like post"><i class="far fa-heart"></i> <span>{{ post.reactions['heart'] or 0 }}</span></button>
                                <button class="reaction-btn thumbs-up {{ 'active' if post.user_reaction == 'thumbs-up' }}" data-reaction="thumbs-up" aria-label="Thumbs up"><i class="far fa-thumbs-up"></i> <span>{{ post.reactions['thumbs-up'] or 0 }}</span></button>
                                <button class="reaction-btn thumbs-down {{ 'active' if post.user_reaction == 'thumbs-down' }}" data-reaction="thumbs-down" aria-label="Thumbs down"><i class="far fa-thumbs-down"></i> <span>{{ post.reactions['thumbs-down'] or 0 }}</span></button>
                            </div>
                            {% if post.username == session['username'] %}
                                <button class="delete-post inline-action" data-post-id="{{ post.id }}"><i class="far fa-trash-alt"></i> Delete</button>
                            {% endif %}
                        </div>
                        <!-- Reply count indicator -->
                        <div class="reply-indicator">
                            <i class="far fa-comment"></i> {{ post.replies|length }} replies
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p>No posts yet in {{ community.name }}. Be the first!</p>
            {% endif %}
        </div>
    </div>

    <!-- Post Modal -->
    <div id="postModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Post Details</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div id="modalPostContent">
                    <!-- Post content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Members Modal -->
    <div id="membersModal" class="modal" style="display: none;">
        <div class="modal-content members-modal">
            <div class="modal-header">
                <h2><i class="fas fa-users"></i> {{ community.name }} Members</h2>
                <span class="close" onclick="closeMembersModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="membersList">
                    <!-- Members will be loaded here -->
                </div>
                {% if username == community.creator_username or username == 'admin' %}
                <div class="add-member-section">
                    <h3>Add Member</h3>
                    <div class="add-member-form">
                        <input type="text" id="newMemberUsername" placeholder="Enter username to add" class="member-input">
                        <button onclick="addMember()" class="sleek-btn small">Add</button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        // Ensure members modal is hidden by default
        document.addEventListener('DOMContentLoaded', function() {
            const membersModal = document.getElementById('membersModal');
            if (membersModal) {
                membersModal.style.display = 'none';
            }
            
            // Load community files on page load
            loadCommunityFiles();
        });

        // Admin Info Functions
        function showAdminInfoModal() {
            document.getElementById('adminInfoSection').style.display = 'block';
        }

        function hideAdminInfo() {
            document.getElementById('adminInfoSection').style.display = 'none';
        }

        function saveCommunityInfo() {
            const info = document.getElementById('communityInfo').value;
            
            $.ajax({
                url: '/save_community_info',
                method: 'POST',
                data: {
                    community_id: {{ community.id }},
                    info: info,
                    csrf_token: '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.success) {
                        alert('Community information saved successfully!');
                    } else {
                        alert('Error saving information: ' + response.error);
                    }
                },
                error: function() {
                    alert('Error saving community information');
                }
            });
        }

        function loadCommunityFiles() {
            $.ajax({
                url: '/get_community_files',
                method: 'GET',
                data: {
                    community_id: {{ community.id }}
                },
                success: function(response) {
                    if (response.success) {
                        displayCommunityFiles(response.files);
                    }
                },
                error: function() {
                    console.log('Error loading community files');
                }
            });
        }

        function displayCommunityFiles(files) {
            const container = document.getElementById('communityFiles');
            
            if (!files || files.length === 0) {
                container.innerHTML = '<p style="color: rgba(255,255,255,0.6); font-size: 12px; text-align: center;">No files uploaded yet</p>';
                return;
            }

            const filesHtml = files.map(file => `
                <div class="community-file">
                    <div class="file-info">
                        <i class="fas fa-file"></i>
                        <span>${file.filename}</span>
                    </div>
                    <div class="file-actions">
                        <button class="file-action-btn" onclick="downloadFile('${file.filename}')" title="Download">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="file-action-btn" onclick="deleteFile('${file.filename}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = filesHtml;
        }

        // File upload handling
        document.getElementById('communityFile').addEventListener('change', function(e) {
            const files = e.target.files;
            if (files.length > 0) {
                uploadCommunityFiles(files);
            }
        });

        function uploadCommunityFiles(files) {
            const formData = new FormData();
            formData.append('community_id', {{ community.id }});
            formData.append('csrf_token', '{{ csrf_token }}');
            
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }

            $.ajax({
                url: '/upload_community_files',
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        alert('Files uploaded successfully!');
                        loadCommunityFiles();
                        document.getElementById('communityFile').value = '';
                    } else {
                        alert('Error uploading files: ' + response.error);
                    }
                },
                error: function() {
                    alert('Error uploading files');
                }
            });
        }

        function downloadFile(filename) {
            window.open(`/download_community_file/${filename}?community_id={{ community.id }}`, '_blank');
        }

        function deleteFile(filename) {
            if (confirm('Are you sure you want to delete this file?')) {
                $.ajax({
                    url: '/delete_community_file',
                    method: 'POST',
                    data: {
                        community_id: {{ community.id }},
                        filename: filename,
                        csrf_token: '{{ csrf_token }}'
                    },
                    success: function(response) {
                        if (response.success) {
                            alert('File deleted successfully!');
                            loadCommunityFiles();
                        } else {
                            alert('Error deleting file: ' + response.error);
                        }
                    },
                    error: function() {
                        alert('Error deleting file');
                    }
                });
            }
        }

        function showMembersModal() {
            const modal = document.getElementById('membersModal');
            if (modal) {
                modal.style.display = 'block';
                loadMembers();
            }
        }

        function closeMembersModal() {
            const modal = document.getElementById('membersModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function loadMembers() {
            fetch('/get_community_members', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                },
                body: 'community_id={{ community.id }}'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayMembers(data.members);
                } else {
                    document.getElementById('membersList').innerHTML = '<p class="error">Error loading members</p>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('membersList').innerHTML = '<p class="error">Error loading members</p>';
            });
        }

        function displayMembers(members) {
            const membersList = document.getElementById('membersList');
            if (members.length === 0) {
                membersList.innerHTML = '<p class="no-members">No members found</p>';
                return;
            }

            let html = '<div class="members-grid">';
            members.forEach(member => {
                const isOwner = member.username === '{{ community.creator_username }}';
                const canRemove = ('{{ username }}' === '{{ community.creator_username }}' || '{{ username }}' === 'admin') && !isOwner;
                
                html += `
                    <div class="member-item">
                        <div class="member-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="member-info">
                            <div class="member-name">${member.username}${isOwner ? ' <span class="owner-badge">Owner</span>' : ''}</div>
                            <div class="member-joined">Joined: ${member.joined_date}</div>
                        </div>
                        ${canRemove ? `<button class="remove-member-btn" onclick="removeMember('${member.username}')"><i class="fas fa-times"></i></button>` : ''}
                    </div>
                `;
            });
            html += '</div>';
            membersList.innerHTML = html;
        }

        function addMember() {
            const username = document.getElementById('newMemberUsername').value.trim();
            if (!username) {
                alert('Please enter a username');
                return;
            }

            fetch('/add_community_member', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                },
                body: `community_id={{ community.id }}&username=${encodeURIComponent(username)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('newMemberUsername').value = '';
                    loadMembers();
                    alert('Member added successfully!');
                } else {
                    alert(data.error || 'Error adding member');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding member');
            });
        }

        function removeMember(username) {
            if (!confirm(`Are you sure you want to remove ${username} from this community?`)) {
                return;
            }

            fetch('/remove_community_member', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                },
                body: `community_id={{ community.id }}&username=${encodeURIComponent(username)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadMembers();
                    alert('Member removed successfully!');
                } else {
                    alert(data.error || 'Error removing member');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error removing member');
            });
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const membersModal = document.getElementById('membersModal');
            if (event.target === membersModal) {
                closeMembersModal();
            }
        }
    </script>
</body>
</html>