<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ community.name }} - Social</title>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css', v='2.0') }}">
    <style>
        /* Custom color styles */
        .composer-card, .post {
            background-color: {{ community.card_color or '#1a2526' }} !important;
            border-color: {{ community.accent_color or '#4db6ac' }} !important;
            color: {{ community.text_color or '#ffffff' }} !important;
        }
        
        .composer-input {
            background-color: {{ community.card_color or '#1a2526' }} !important;
            color: {{ community.text_color or '#ffffff' }} !important;
            border-color: {{ community.accent_color or '#4db6ac' }} !important;
        }
        
        .post-header strong {
            color: {{ community.text_color or '#ffffff' }} !important;
        }
        
        .post p {
            color: {{ community.text_color or '#ffffff' }} !important;
        }
        
        .reaction-btn {
            color: {{ community.text_color or '#ffffff' }} !important;
        }
        
        .reaction-btn.active {
            color: {{ community.accent_color or '#4db6ac' }} !important;
        }
        
        .sleek-btn {
            background-color: {{ community.accent_color or '#4db6ac' }} !important;
            color: {{ community.text_color or '#ffffff' }} !important;
        }
        
        .sleek-btn:hover {
            background-color: {{ community.accent_color or '#4db6ac' }}dd !important;
        }
        
        body {
            background-color: {{ community.background_color or '#2d3839' }} !important;
        }
        
        .community-header-image {
            border-color: {{ community.accent_color or '#4db6ac' }} !important;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <meta name="current-username" content="{{ username }}">
    <script src="{{ url_for('static', filename='script.js', v='2.0') }}"></script>
</head>
<body>
    <!-- Sidebar Menu -->
    <div class="sidebar">
        <button class="menu-btn">â˜° Menu</button>
        <div class="dropdown-content">
            <a href="{{ url_for('dashboard') }}">Dashboard</a>
            <a href="{{ url_for('free_workouts') }}">Free Workouts</a>
            <a href="{{ url_for('premium_dashboard') }}">Premium Dashboard</a>
            <a href="{{ url_for('feed') }}">Social</a>
            <a href="{{ url_for('communities') }}">Your Communities</a>
            <a href="{{ url_for('logout') }}">Logout</a>
            <span id="unread-badge" class="unread-badge hidden">0</span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container feed">
        {% if community.background_path %}
        <div class="community-header-image">
            <img src="{% if community.background_path.startswith('http') %}{{ community.background_path }}{% else %}{{ url_for('static', filename=community.background_path) }}{% endif %}" alt="{{ community.name }} Header" class="header-image">
        </div>
        {% endif %}
        <div class="community-header">
            <h1>{{ community.name }}</h1>
            <p class="community-type">{{ community.type }} Community</p>
            <button class="members-btn" onclick="showMembersModal()">
                <i class="fas fa-users"></i> Members
            </button>
        </div>

        <!-- Composer -->
        <div class="composer-card">
            <form action="/post_status" method="POST" class="composer-form" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <input type="hidden" name="community_id" value="{{ community.id }}">
                <div class="composer-inner">
                    <div class="composer-body">
                        <input type="text" name="content" class="composer-input" placeholder="What is happening in {{ community.name }}?!">
                        <div class="composer-actions">
                            <div class="file-upload-container">
                                <label for="image-upload" class="file-upload-btn">
                                    <i class="fas fa-paperclip"></i>
                                </label>
                                <input type="file" id="image-upload" name="image" accept="image/*" style="display: none;">
                                <span id="selected-file-name" class="selected-file-name"></span>
                            </div>
                            <button type="submit" class="sleek-btn small">Post to {{ community.name }}</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Posts Display -->
        <div class="posts timeline">
            {% if posts %}
                {% for post in posts %}
                    <div class="post clickable-post" data-post-id="{{ post.id }}">
                        <div class="post-header"><strong>@{{ post.username }}</strong><span class="timestamp">{{ post.timestamp | format_date('%m/%d/%y %I:%M %p') }}</span></div>
                        <p>{{ post.content }}</p>
                        {% if post.image_path and post.image_path != 'None' and post.image_path != '' %}
                            <div class="post-image">
                                <img src="{{ url_for('uploaded_file', filename=post.image_path.replace('uploads/', '')) if post.image_path.startswith('uploads/') else url_for('uploaded_file', filename=post.image_path) }}" 
                                     alt="Post image" 
                                     loading="lazy" 
                                     onerror="console.log('Image failed to load:', this.src); this.style.display='none'; this.parentElement.innerHTML='<div style=\'padding: 20px; text-align: center; color: #9fb0b5;\'>Image could not be loaded</div>';" 
                                     onload="console.log('Image loaded successfully:', this.src);"
                                     style="max-width: 100%; height: auto; display: block;">
                            </div>
                        {% endif %}
                        <div class="post-actions">
                            <div class="reactions">
                                <button class="reaction-btn heart {{ 'active' if post.user_reaction == 'heart' }}" data-reaction="heart" aria-label="Like post"><i class="far fa-heart"></i> <span>{{ post.reactions['heart'] or 0 }}</span></button>
                                <button class="reaction-btn thumbs-up {{ 'active' if post.user_reaction == 'thumbs-up' }}" data-reaction="thumbs-up" aria-label="Thumbs up"><i class="far fa-thumbs-up"></i> <span>{{ post.reactions['thumbs-up'] or 0 }}</span></button>
                                <button class="reaction-btn thumbs-down {{ 'active' if post.user_reaction == 'thumbs-down' }}" data-reaction="thumbs-down" aria-label="Thumbs down"><i class="far fa-thumbs-down"></i> <span>{{ post.reactions['thumbs-down'] or 0 }}</span></button>
                            </div>
                            {% if post.username == session['username'] %}
                                <button class="delete-post inline-action" data-post-id="{{ post.id }}"><i class="far fa-trash-alt"></i> Delete</button>
                            {% endif %}
                        </div>
                        <!-- Reply count indicator -->
                        <div class="reply-indicator">
                            <i class="far fa-comment"></i> {{ post.replies|length }} replies
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p>No posts yet in {{ community.name }}. Be the first!</p>
            {% endif %}
        </div>
    </div>

    <!-- Post Modal -->
    <div id="postModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Post Details</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div id="modalPostContent">
                    <!-- Post content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Members Modal -->
    <div id="membersModal" class="modal" style="display: none;">
        <div class="modal-content members-modal">
            <div class="modal-header">
                <h2><i class="fas fa-users"></i> {{ community.name }} Members</h2>
                <span class="close" onclick="closeMembersModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="membersList">
                    <!-- Members will be loaded here -->
                </div>
                {% if username == community.creator_username or username == 'admin' %}
                <div class="add-member-section">
                    <h3>Add Member</h3>
                    <div class="add-member-form">
                        <input type="text" id="newMemberUsername" placeholder="Enter username to add" class="member-input">
                        <button onclick="addMember()" class="sleek-btn small">Add</button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        // Ensure members modal is hidden by default
        document.addEventListener('DOMContentLoaded', function() {
            const membersModal = document.getElementById('membersModal');
            if (membersModal) {
                membersModal.style.display = 'none';
            }
        });

        function showMembersModal() {
            const modal = document.getElementById('membersModal');
            if (modal) {
                modal.style.display = 'block';
                loadMembers();
            }
        }

        function closeMembersModal() {
            const modal = document.getElementById('membersModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function loadMembers() {
            fetch('/get_community_members', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                },
                body: 'community_id={{ community.id }}'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayMembers(data.members);
                } else {
                    document.getElementById('membersList').innerHTML = '<p class="error">Error loading members</p>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('membersList').innerHTML = '<p class="error">Error loading members</p>';
            });
        }

        function displayMembers(members) {
            const membersList = document.getElementById('membersList');
            if (members.length === 0) {
                membersList.innerHTML = '<p class="no-members">No members found</p>';
                return;
            }

            let html = '<div class="members-grid">';
            members.forEach(member => {
                const isOwner = member.username === '{{ community.creator_username }}';
                const canRemove = ('{{ username }}' === '{{ community.creator_username }}' || '{{ username }}' === 'admin') && !isOwner;
                
                html += `
                    <div class="member-item">
                        <div class="member-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="member-info">
                            <div class="member-name">${member.username}${isOwner ? ' <span class="owner-badge">Owner</span>' : ''}</div>
                            <div class="member-joined">Joined: ${member.joined_date}</div>
                        </div>
                        ${canRemove ? `<button class="remove-member-btn" onclick="removeMember('${member.username}')"><i class="fas fa-times"></i></button>` : ''}
                    </div>
                `;
            });
            html += '</div>';
            membersList.innerHTML = html;
        }

        function addMember() {
            const username = document.getElementById('newMemberUsername').value.trim();
            if (!username) {
                alert('Please enter a username');
                return;
            }

            fetch('/add_community_member', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                },
                body: `community_id={{ community.id }}&username=${encodeURIComponent(username)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('newMemberUsername').value = '';
                    loadMembers();
                    alert('Member added successfully!');
                } else {
                    alert(data.error || 'Error adding member');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding member');
            });
        }

        function removeMember(username) {
            if (!confirm(`Are you sure you want to remove ${username} from this community?`)) {
                return;
            }

            fetch('/remove_community_member', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                },
                body: `community_id={{ community.id }}&username=${encodeURIComponent(username)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadMembers();
                    alert('Member removed successfully!');
                } else {
                    alert(data.error || 'Error removing member');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error removing member');
            });
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const membersModal = document.getElementById('membersModal');
            if (event.target === membersModal) {
                closeMembersModal();
            }
        }
    </script>
</body>
</html>