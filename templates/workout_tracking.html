<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Tracking</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css', v='1.1') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="{{ url_for('static', filename='script.js', v='1.1') }}"></script>
</head>
<body>
    <!-- Sidebar Menu -->
    <div class="sidebar">
        <button class="menu-btn">â˜° Menu</button>
        <div class="dropdown-content">
            <a href="{{ url_for('dashboard') }}">Dashboard</a>
            <a href="{{ url_for('free_workouts') }}">Free Workouts</a>
            <a href="{{ url_for('premium_dashboard') }}">Premium Dashboard</a>
            <a href="{{ url_for('feed') }}">Social</a>
            <a href="{{ url_for('your_sports') }}">Your Sports</a>
            <a href="{{ url_for('logout') }}">Logout</a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <div class="page-header">
            <button onclick="window.location.href='{{ url_for('gym') }}'" class="back-btn">
                <i class="fas fa-arrow-left"></i> Back to Gym
            </button>
            <h1>Workout Tracking</h1>
        </div>

        <div class="tracking-content">
            <div class="tracking-header">
                <h2>Your Workouts</h2>
                <button class="add-exercise-btn" onclick="toggleExerciseForm()">
                    <i class="fas fa-plus"></i> Add Exercise
                </button>
            </div>

            <!-- Add Exercise Form -->
            <div id="exercise-form" class="exercise-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="exercise-name">Exercise Name</label>
                        <input type="text" id="exercise-name" class="form-control" placeholder="e.g., Bench Press">
                    </div>
                    <div class="form-group">
                        <label for="muscle-group">Muscle Group</label>
                        <select id="muscle-group" class="form-control">
                            <option value="Chest">Chest</option>
                            <option value="Back">Back</option>
                            <option value="Shoulders">Shoulders</option>
                            <option value="Biceps">Biceps</option>
                            <option value="Triceps">Triceps</option>
                            <option value="Legs">Legs</option>
                            <option value="Core">Core</option>
                            <option value="Cardio">Cardio</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="exercise-weight">Weight (kg)</label>
                        <input type="number" id="exercise-weight" class="form-control" placeholder="0">
                    </div>
                </div>
                <button class="submit-btn" onclick="addExercise()">Add Exercise</button>
            </div>

            <!-- Muscle Groups View -->
            <div id="muscle-groups-view" class="muscle-groups-view">
                <!-- Muscle groups will be loaded here -->
            </div>

            <!-- Exercises List View -->
            <div id="exercises-view" class="exercises-view" style="display: none;">
                <div class="view-header">
                    <button class="back-btn" onclick="showMuscleGroups()">
                        <i class="fas fa-arrow-left"></i> Back to Muscle Groups
                    </button>
                    <h3 id="current-muscle-group">Exercises</h3>
                </div>
                <div id="exercises-list" class="exercises-list">
                    <!-- Exercises will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load muscle groups on page load
        $(document).ready(function() {
            console.log('Document ready, loading muscle groups...');
            setTimeout(function() {
                console.log('Loading muscle groups after timeout...');
                loadMuscleGroups();
            }, 1000);
        });

        function toggleExerciseForm() {
            const form = document.getElementById('exercise-form');
            console.log('Toggling exercise form, current display:', form.style.display);
            form.classList.toggle('show');
            console.log('Form show class:', form.classList.contains('show'));
        }

        function addExercise() {
            const name = document.getElementById('exercise-name').value;
            const muscleGroup = document.getElementById('muscle-group').value;
            const weight = document.getElementById('exercise-weight').value;

            console.log('Adding exercise:', { name, muscleGroup, weight });

            if (!name || !muscleGroup || !weight) {
                alert('Please fill in all fields');
                return;
            }

            $.ajax({
                url: '/add_exercise',
                method: 'POST',
                data: {
                    name: name,
                    muscle_group: muscleGroup,
                    weight: weight
                },
                success: function(response) {
                    console.log('Add exercise response:', response);
                    if (response.success) {
                        document.getElementById('exercise-name').value = '';
                        document.getElementById('muscle-group').value = 'Chest'; // Reset to default
                        document.getElementById('exercise-weight').value = '';
                        document.getElementById('exercise-form').classList.remove('show');
                        loadMuscleGroups();
                    } else {
                        alert('Error adding exercise: ' + response.error);
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Add exercise error:', { xhr, status, error });
                    alert('Error adding exercise: ' + error);
                }
            });
        }

                function loadMuscleGroups() {
            console.log('Loading muscle groups...');
            $.ajax({
                url: '/get_workout_exercises',
                method: 'GET',
                success: function(response) {
                    console.log('Load muscle groups response:', response);
                    console.log('Response type:', typeof response);
                    console.log('Response keys:', Object.keys(response));
                    
                    if (response.success) {
                        console.log('Success is true, calling displayMuscleGroups');
                        displayMuscleGroups(response.muscle_groups);
                    } else {
                        console.log('Success is false, showing error message');
                        document.getElementById('muscle-groups-view').innerHTML = '<p style="color: #b0b8b9; text-align: center; font-size: 0.8rem;">No exercises added yet. Click "Add Exercise" to get started!</p>';
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Error loading muscle groups:', { xhr, status, error });
                    console.log('XHR response:', xhr.responseText);
                }
            });
        }

        function displayMuscleGroups(muscleGroups) {
            console.log('Displaying muscle groups:', muscleGroups);
            const container = document.getElementById('muscle-groups-view');
            console.log('Container element:', container);
            console.log('Container exists:', !!container);
            
            if (!container) {
                console.error('Container element not found!');
                return;
            }
            
            container.innerHTML = '';

            // Only show muscle groups that have exercises
            const muscleGroupNames = ['Chest', 'Back', 'Shoulders', 'Biceps', 'Triceps', 'Legs', 'Core', 'Cardio', 'Other'];
            const groupsWithExercises = muscleGroupNames.filter(muscleGroup => {
                const exercisesInGroup = muscleGroups[muscleGroup] || [];
                console.log(`Muscle group ${muscleGroup}:`, exercisesInGroup);
                return exercisesInGroup.length > 0;
            });
            
            console.log('Groups with exercises:', groupsWithExercises);
            
            if (groupsWithExercises.length === 0) {
                console.log('No groups with exercises, showing empty message');
                container.innerHTML = '<p style="color: #b0b8b9; text-align: center; font-size: 0.7rem;">No exercises added yet. Click "Add Exercise" to get started!</p>';
                return;
            }
            
            groupsWithExercises.forEach(function(muscleGroup) {
                const exercisesInGroup = muscleGroups[muscleGroup] || [];
                const exerciseCount = exercisesInGroup.length;
                console.log(`Creating card for ${muscleGroup} with ${exerciseCount} exercises`);
                
                const muscleGroupHtml = `
                    <div class="muscle-group-card" onclick="showExercises('${muscleGroup}')">
                        <div class="muscle-group-header">
                            <h3>${muscleGroup}</h3>
                            <span class="exercise-count">${exerciseCount} exercises</span>
                        </div>
                    </div>
                `;
                container.innerHTML += muscleGroupHtml;
            });
            
            console.log('Final container HTML:', container.innerHTML);
        }

        function showExercises(muscleGroup) {
            document.getElementById('muscle-groups-view').style.display = 'none';
            document.getElementById('exercises-view').style.display = 'block';
            document.getElementById('current-muscle-group').textContent = muscleGroup;
            
            // Load exercises for this muscle group
            $.ajax({
                url: '/get_workout_exercises',
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        displayExercisesForGroup(response.muscle_groups[muscleGroup] || [], muscleGroup);
                    }
                },
                error: function() {
                    console.log('Error loading exercises');
                }
            });
        }

        function showMuscleGroups() {
            document.getElementById('exercises-view').style.display = 'none';
            document.getElementById('muscle-groups-view').style.display = 'block';
            loadMuscleGroups();
        }

        function displayExercisesForGroup(exercises, muscleGroup) {
            const container = document.getElementById('exercises-list');
            container.innerHTML = '';

            if (exercises.length === 0) {
                container.innerHTML = '<p style="color: #b0b8b9; text-align: center; font-size: 0.8rem;">No exercises in this muscle group yet.</p>';
                return;
            }

            exercises.forEach(function(exercise) {
                const exerciseHtml = `
                    <div class="exercise-item">
                        <div class="exercise-header">
                            <h3 class="exercise-name">${exercise.name}</h3>
                        </div>
                        <div class="exercise-stats">
                            <div class="stat-item">
                                <span class="stat-label">Current Weight</span>
                                <span class="stat-value">${exercise.weight} kg</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Sets</span>
                                <span class="stat-value">${exercise.sets_data.length}</span>
                            </div>
                        </div>
                        <div class="exercise-actions">
                            <button class="action-btn" onclick="editExercise(${exercise.id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="action-btn" onclick="addSet(${exercise.id})">
                                <i class="fas fa-plus"></i> Add Set
                            </button>
                            <button class="action-btn delete" onclick="deleteExercise(${exercise.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                        <div class="workout-sets">
                            <div id="sets-${exercise.id}">
                                ${displaySets(exercise.sets_data)}
                            </div>
                            <button class="add-set-btn" onclick="addSet(${exercise.id})">
                                <i class="fas fa-plus"></i> Add New Set
                            </button>
                        </div>
                    </div>
                `;
                container.innerHTML += exerciseHtml;
            });
        }

        function displayExercises(muscleGroups) {
            const container = document.getElementById('exercises-list');
            container.innerHTML = '';

            // Sort muscle groups alphabetically
            const sortedMuscleGroups = Object.keys(muscleGroups).sort();

            sortedMuscleGroups.forEach(function(muscleGroup) {
                const exercisesInGroup = muscleGroups[muscleGroup];
                const muscleGroupHeader = `
                    <div class="muscle-group-header">
                        <h3>${muscleGroup}</h3>
                    </div>
                `;
                container.innerHTML += muscleGroupHeader;

                exercisesInGroup.forEach(function(exercise) {
                    const exerciseHtml = `
                        <div class="exercise-item">
                            <div class="exercise-header">
                                <h3 class="exercise-name">${exercise.name}</h3>
                            </div>
                            <div class="exercise-stats">
                                <div class="stat-item">
                                    <span class="stat-label">Current Weight</span>
                                    <span class="stat-value">${exercise.weight} kg</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Sets</span>
                                    <span class="stat-value">${exercise.sets_data.length}</span>
                                </div>
                            </div>
                            <div class="exercise-actions">
                                <button class="action-btn" onclick="editExercise(${exercise.id})">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="action-btn" onclick="addSet(${exercise.id})">
                                    <i class="fas fa-plus"></i> Add Set
                                </button>
                                <button class="action-btn delete" onclick="deleteExercise(${exercise.id})">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                            <div class="workout-sets">
                                <div id="sets-${exercise.id}">
                                    ${displaySets(exercise.sets_data)}
                                </div>
                                <button class="add-set-btn" onclick="addSet(${exercise.id})">
                                    <i class="fas fa-plus"></i> Add New Set
                                </button>
                            </div>
                        </div>
                    `;
                    container.innerHTML += exerciseHtml;
                });
            });
        }

        function displaySets(setsData) {
            if (!setsData || setsData.length === 0) {
                return '<p style="color: #b0b8b9; font-size: 0.7rem; text-align: center;">No sets recorded yet</p>';
            }

            let setsHtml = '';
            setsData.forEach(function(set, index) {
                setsHtml += `
                    <div class="set-item">
                        <span class="set-number">Set ${index + 1}</span>
                        <span class="set-weight">${set.weight} kg</span>
                        <div class="set-actions">
                            <button class="set-btn" onclick="editSet(${set.exercise_id}, ${set.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="set-btn delete" onclick="deleteSet(${set.exercise_id}, ${set.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            return setsHtml;
        }

        function editExercise(exerciseId) {
            const newName = prompt('Enter new exercise name:');
            if (newName) {
                $.ajax({
                    url: '/edit_exercise',
                    method: 'POST',
                    data: {
                        exercise_id: exerciseId,
                        name: newName
                    },
                    success: function(response) {
                        if (response.success) {
                            loadExercises();
                        } else {
                            alert('Error updating exercise: ' + response.error);
                        }
                    },
                    error: function() {
                        alert('Error updating exercise');
                    }
                });
            }
        }

        function deleteExercise(exerciseId) {
            if (confirm('Are you sure you want to delete this exercise?')) {
                $.ajax({
                    url: '/delete_exercise',
                    method: 'POST',
                    data: {
                        exercise_id: exerciseId
                    },
                    success: function(response) {
                        if (response.success) {
                            loadExercises();
                        } else {
                            alert('Error deleting exercise: ' + response.error);
                        }
                    },
                    error: function() {
                        alert('Error deleting exercise');
                    }
                });
            }
        }

        function addSet(exerciseId) {
            const weight = prompt('Enter weight for this set (kg):');
            if (weight && !isNaN(weight)) {
                $.ajax({
                    url: '/add_set',
                    method: 'POST',
                    data: {
                        exercise_id: exerciseId,
                        weight: weight
                    },
                    success: function(response) {
                        if (response.success) {
                            loadExercises();
                        } else {
                            alert('Error adding set: ' + response.error);
                        }
                    },
                    error: function() {
                        alert('Error adding set');
                    }
                });
            }
        }

        function editSet(exerciseId, setId) {
            const newWeight = prompt('Enter new weight for this set (kg):');
            if (newWeight && !isNaN(newWeight)) {
                $.ajax({
                    url: '/edit_set',
                    method: 'POST',
                    data: {
                        exercise_id: exerciseId,
                        set_id: setId,
                        weight: newWeight
                    },
                    success: function(response) {
                        if (response.success) {
                            loadExercises();
                        } else {
                            alert('Error updating set: ' + response.error);
                        }
                    },
                    error: function() {
                        alert('Error updating set');
                    }
                });
            }
        }

        function deleteSet(exerciseId, setId) {
            if (confirm('Are you sure you want to delete this set?')) {
                $.ajax({
                    url: '/delete_set',
                    method: 'POST',
                    data: {
                        exercise_id: exerciseId,
                        set_id: setId
                    },
                    success: function(response) {
                        if (response.success) {
                            loadExercises();
                        } else {
                            alert('Error deleting set: ' + response.error);
                        }
                    },
                    error: function() {
                        alert('Error deleting set');
                    }
                });
            }
        }
    </script>
</body>
</html>