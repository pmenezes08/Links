<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Tracking</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=1.5">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="workout-container">
        <!-- Header -->
        <div class="workout-header">
            <div class="header-content">
                <button class="back-btn" onclick="window.history.back()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <h1>Workout Tracking</h1>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" data-tab="performance-tracking">
                <i class="fas fa-chart-line"></i>
                Performance Tracking
            </button>
            <button class="tab-btn" data-tab="exercise-management">
                <i class="fas fa-dumbbell"></i>
                Exercise Management
            </button>
            <button class="tab-btn" data-tab="workouts">
                <i class="fas fa-calendar-alt"></i>
                Workouts
            </button>
        </div>

        <!-- Performance Tracking Tab (Read-only View) -->
        <div id="performance-tracking" class="tab-content active">
            <div class="performance-tracking-container">
                <div class="header-section">
                    <h3>Your Performance Overview</h3>
                    <button class="add-btn" onclick="openAddExerciseModal()">
                        <i class="fas fa-plus"></i> Add Exercise
                    </button>
                </div>
                
                <div class="overview-section">
                    <p class="overview-text">Your 1RM data is automatically calculated from your logged sets. Add exercises and log your performance to see your progress here.</p>
                </div>

                <div class="exercises-section">
                    <div id="muscle-groups-view" class="muscle-groups-view">
                        <!-- Muscle groups will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Exercise Management Tab -->
        <div id="exercise-management" class="tab-content">
            <div class="exercise-management-container">
                <div class="header-section">
                    <h3>Exercise Management</h3>
                    <button class="add-btn" onclick="openAddExerciseModal()">
                        <i class="fas fa-plus"></i> Add Exercise
                    </button>
                </div>
                
                <div class="exercises-list-section">
                    <div id="exercises-management-list" class="exercises-list">
                        <!-- Exercises will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Workouts Tab (Optional) -->
        <div id="workouts" class="tab-content">
            <div class="workouts-container">
                <div class="header-section">
                    <h3>Your Workouts</h3>
                    <button class="add-btn" onclick="openCreateWorkoutModal()">
                        <i class="fas fa-plus"></i> Create Workout
                    </button>
                </div>
                
                <div class="workouts-list-section">
                    <div id="workouts-list" class="workouts-list">
                        <!-- Workouts will be loaded here -->
                    </div>
                </div>
            </div>
        </div>


    </div>

    <!-- Exercise Detail Modal -->
    <div id="exercise-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-exercise-name">Exercise Details</h3>
                <button class="close-btn" onclick="closeExerciseModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="exercise-stats">
                    <div class="stat-card">
                        <h4>1 Rep Max</h4>
                        <div class="stat-value" id="one-rep-max" title="Estimated using Epley formula">-</div>
                        <div class="stat-formula">Estimated from your sets</div>
                    </div>
                    <div class="stat-card">
                        <h4>1RM Calculator</h4>
                        <div class="calculator">
                            <input type="number" id="percentage" placeholder="%" min="50" max="100" step="5">
                            <button onclick="calculateWeight()" class="calc-btn">Calculate</button>
                            <div class="calc-result" id="calc-result">-</div>
                        </div>
                    </div>
                </div>
                <div class="sets-history">
                    <h4>Weight History</h4>
                    <div id="sets-history" class="sets-list">
                        <!-- Sets will be loaded here -->
                    </div>
                </div>
                <div class="add-set-section">
                    <h4>Add New Set</h4>
                    <form id="add-set-form" class="set-form">
                        <div class="form-row">
                            <input type="number" id="set-weight" placeholder="Weight (kg)" required>
                            <input type="number" id="set-reps" placeholder="Reps" required>
                        </div>
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-plus"></i> Add Set
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Exercise Modal -->
    <div id="add-exercise-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Exercise</h3>
                <button class="close-btn" onclick="closeAddExerciseModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="add-exercise-form" class="exercise-form">
                    <div class="form-group">
                        <label for="modal-exercise-name">Exercise Name</label>
                        <input type="text" id="modal-exercise-name" placeholder="e.g., Bench Press" required>
                    </div>
                    <div class="form-group">
                        <label for="modal-muscle-group">Muscle Group</label>
                        <select id="modal-muscle-group" required>
                            <option value="">Select muscle group</option>
                            <option value="Chest">Chest</option>
                            <option value="Back">Back</option>
                            <option value="Shoulders">Shoulders</option>
                            <option value="Biceps">Biceps</option>
                            <option value="Triceps">Triceps</option>
                            <option value="Legs">Legs</option>
                            <option value="Core">Core</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-plus"></i> Add Exercise
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Workout Modal -->
    <div id="create-workout-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Workout</h3>
                <button class="close-btn" onclick="closeCreateWorkoutModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="create-workout-form" class="workout-form">
                    <div class="form-group">
                        <label for="modal-workout-name">Workout Name</label>
                        <input type="text" id="modal-workout-name" placeholder="e.g., Push Day" required>
                    </div>
                    <div class="form-group">
                        <label for="modal-workout-date">Date</label>
                        <input type="date" id="modal-workout-date" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-plus"></i> Create Workout
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Log Weight Modal -->
    <div id="log-weight-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="log-weight-exercise-name">Log Weight</h3>
                <button class="close-btn" onclick="closeLogWeightModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="log-weight-form" class="weight-form">
                    <div class="form-group">
                        <label for="log-weight-value">Weight (kg)</label>
                        <input type="number" id="log-weight-value" placeholder="e.g., 80" min="0" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="log-weight-reps">Reps</label>
                        <input type="number" id="log-weight-reps" placeholder="e.g., 8" min="1" max="50" required>
                    </div>
                    <div class="form-group">
                        <label for="log-weight-date">Date</label>
                        <input type="date" id="log-weight-date" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-plus"></i> Log Weight
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Workout Detail Modal -->
    <div id="workout-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-workout-name">Workout Details</h3>
                <button class="close-btn" onclick="closeWorkoutModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="workout-exercises">
                    <h4>Exercises</h4>
                    <div id="workout-exercises-list" class="exercises-list">
                        <!-- Workout exercises will be loaded here -->
                    </div>
                </div>
                <div class="add-exercise-to-workout">
                    <h4>Add Exercise to Workout</h4>
                    <form id="add-exercise-to-workout-form" class="exercise-form">
                        <div class="form-row">
                            <select id="workout-exercise-select" required>
                                <option value="">Select exercise</option>
                            </select>
                            <input type="number" id="workout-weight" placeholder="Weight (kg)" min="0" step="0.1" required>
                            <input type="number" id="workout-sets" placeholder="Sets" min="1" max="10" required>
                            <input type="number" id="workout-reps" placeholder="Reps" min="1" max="50" required>
                        </div>
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-plus"></i> Add to Workout
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // Set default date to today
            $('#log-weight-date').val(new Date().toISOString().split('T')[0]);
            $('#modal-workout-date').val(new Date().toISOString().split('T')[0]);

            // Load initial data
            loadMuscleGroups();
            loadExercisesManagement();
            loadWorkouts();

            // Tab switching
            $('.tab-btn').click(function() {
                $('.tab-btn').removeClass('active');
                $(this).addClass('active');
                
                const tabId = $(this).data('tab');
                $('.tab-content').removeClass('active');
                $('#' + tabId).addClass('active');
            });

            // Modal event handlers
            $('#add-exercise-form').submit(function(e) {
                e.preventDefault();
                addExercise();
            });

            $('#create-workout-form').submit(function(e) {
                e.preventDefault();
                createWorkout();
            });

            $('#log-weight-form').submit(function(e) {
                e.preventDefault();
                logWeight();
            });

            // Add exercise form
            $('#add-exercise-form').submit(function(e) {
                e.preventDefault();
                addExercise();
            });

            // Create workout form
            $('#create-workout-form').submit(function(e) {
                e.preventDefault();
                console.log('Create workout form submitted');
                createWorkout();
            });



            // Add set form
            $('#add-set-form').submit(function(e) {
                e.preventDefault();
                addSetToExercise();
            });

            // Add exercise to workout form
            $('#add-exercise-to-workout-form').submit(function(e) {
                e.preventDefault();
                addExerciseToWorkout();
            });
        });

        // Utility Functions
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    year: date.getFullYear() !== today.getFullYear() ? 'numeric' : undefined
                });
            }
        }

        // Performance Tracking Functions (Read-only)
        function loadMuscleGroups() {
            console.log('Loading muscle groups...');
            $.ajax({
                url: '/get_workout_exercises',
                method: 'GET',
                success: function(response) {
                    console.log('Load muscle groups response:', response);
                    console.log('Response type:', typeof response);
                    console.log('Response.success:', response.success);
                    console.log('Response.exercises:', response.exercises);
                    console.log('Response.exercises length:', response.exercises ? response.exercises.length : 'undefined');
                    
                    if (response.success && response.exercises && response.exercises.length > 0) {
                        console.log('Found exercises, displaying muscle groups');
                        displayMuscleGroups(response.exercises);
                    } else if (response.success && (!response.exercises || response.exercises.length === 0)) {
                        // No exercises found but request was successful
                        console.log('No exercises found in database');
                        $('#muscle-groups-view').html('<p style="color: #b0b8b9; text-align: center; padding: 20px;">No exercises found. Add exercises in the Workouts tab to see your 1RM data here!</p>');
                    } else {
                        console.log('Failed to load muscle groups:', response.error);
                        $('#muscle-groups-view').html('<p style="color: #b0b8b9; text-align: center; padding: 20px;">No exercises found. Add exercises in the Workouts tab to see your 1RM data here!</p>');
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Load muscle groups error:', { xhr, status, error });
                    $('#muscle-groups-view').html('<p style="color: #b0b8b9; text-align: center; padding: 20px;">Error loading exercises. Please try again.</p>');
                }
            });
        }

        function displayMuscleGroups(exercises) {
            console.log('Displaying muscle groups with exercises:', exercises);
            
            if (!exercises || !Array.isArray(exercises)) {
                console.log('No exercises found or invalid data structure');
                $('#muscle-groups-view').html('<p style="color: #b0b8b9; text-align: center; padding: 20px;">No exercises found. Add exercises in the Workouts tab to see your 1RM data here!</p>');
                return;
            }
            
            const muscleGroups = {};
            
            exercises.forEach(exercise => {
                if (!muscleGroups[exercise.muscle_group]) {
                    muscleGroups[exercise.muscle_group] = [];
                }
                muscleGroups[exercise.muscle_group].push(exercise);
            });

            if (Object.keys(muscleGroups).length === 0) {
                $('#muscle-groups-view').html('<p style="color: #b0b8b9; text-align: center; padding: 20px;">No exercises found. Add exercises in the Workouts tab to see your 1RM data here!</p>');
                return;
            }

            const html = Object.keys(muscleGroups).map(group => {
                const exercisesInGroup = muscleGroups[group];
                                        const maxWeight = Math.max(...exercisesInGroup.map(ex => 
                            ex.sets_data && ex.sets_data.length > 0 ? Math.max(...ex.sets_data.map(set => set.weight || 0)) : 0
                        ));
                        
                        return `
                            <div class="muscle-group-card" onclick="showExercises('${group}')">
                                <div class="muscle-group-header">
                                    <h3>${group}</h3>
                                    <span class="exercise-count">${exercisesInGroup.length} exercises</span>
                                </div>
                                <div class="muscle-group-stats">
                                    <div class="stat">
                                        <span class="stat-label">Max Weight</span>
                                        <span class="stat-value">${maxWeight > 0 ? maxWeight + ' kg' : 'No data'}</span>
                                    </div>
                                </div>
                            </div>
                        `;
            }).join('');

            $('#muscle-groups-view').html(html);
        }

        function showExercises(muscleGroup) {
            $.ajax({
                url: '/get_workout_exercises',
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        const exercises = response.exercises.filter(ex => ex.muscle_group === muscleGroup);
                        displayExercisesForGroup(exercises, muscleGroup);
                    }
                }
            });
        }

        function displayExercisesForGroup(exercises, muscleGroup) {
            console.log('Displaying exercises for group:', muscleGroup, exercises);
            
            if (!exercises || !Array.isArray(exercises) || exercises.length === 0) {
                const html = `
                    <div class="view-header">
                        <button class="back-btn" onclick="showMuscleGroups()">
                            <i class="fas fa-arrow-left"></i> Back to Muscle Groups
                        </button>
                        <h3>${muscleGroup} Exercises</h3>
                    </div>
                    <div class="exercises-list">
                        <p style="color: #b0b8b9; text-align: center; padding: 20px;">No exercises in this muscle group yet.</p>
                    </div>
                `;
                $('#muscle-groups-view').html(html);
                return;
            }
            
            const html = `
                <div class="view-header">
                    <button class="back-btn" onclick="showMuscleGroups()">
                        <i class="fas fa-arrow-left"></i> Back to Muscle Groups
                    </button>
                    <h3>${muscleGroup} Exercises</h3>
                </div>
                <div class="exercises-list">
                    ${exercises.map(exercise => {
                        const setsData = exercise.sets_data || [];
                        const maxWeight = setsData.length > 0 ? 
                            Math.max(...setsData.map(set => set.weight || 0)) : 0;
                        const maxWeightSet = setsData.find(set => set.weight === maxWeight);
                        
                        // Calculate 1RM using Epley formula
                        let oneRepMax = 0;
                        if (maxWeightSet) {
                            oneRepMax = Math.round(maxWeightSet.weight * (1 + maxWeightSet.reps / 30));
                        }
                        
                        return `
                            <div class="exercise-item" onclick="openExerciseModal(${exercise.id}, '${exercise.name}')">
                                <div class="exercise-header">
                                    <h4 class="exercise-name">${exercise.name}</h4>
                                </div>
                                <div class="exercise-stats">
                                                            <div class="stat">
                            <span class="stat-label">1 Rep Max</span>
                            <span class="stat-value" title="Estimated using Epley formula">${oneRepMax > 0 ? oneRepMax + ' kg' : 'No data'}</span>
                        </div>
                                    <div class="stat">
                                        <span class="stat-label">Max Weight</span>
                                        <span class="stat-value">${maxWeight > 0 ? maxWeight + ' kg' : 'No data'}</span>
                                    </div>
                                    <div class="stat">
                                        <span class="stat-label">Total Sets</span>
                                        <span class="stat-value">${setsData.length}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            $('#muscle-groups-view').html(html);
        }

        function showMuscleGroups() {
            loadMuscleGroups();
        }

        // Workouts Functions (Input Section)
        function addExercise() {
            const name = $('#exercise-name').val();
            const muscleGroup = $('#muscle-group').val();
            
            console.log('Adding exercise:', { name, muscleGroup });
            
            if (!name || !muscleGroup) {
                alert('Please enter exercise name and select muscle group');
                return;
            }
            
            $.ajax({
                url: '/add_exercise',
                method: 'POST',
                data: {
                    name: name,
                    muscle_group: muscleGroup
                },
                success: function(response) {
                    console.log('Add exercise response:', response);
                    if (response.success) {
                        $('#exercise-name').val('');
                        $('#muscle-group').val('');
                        
                        // Show success message
                        const successMsg = $('<div class="success-message" style="background: #4db6ac; color: white; padding: 10px; border-radius: 5px; margin: 10px 0; text-align: center;">Exercise added successfully! You can now add it to your workouts.</div>');
                        $('#add-exercise-form').after(successMsg);
                        
                        // Remove success message after 3 seconds
                        setTimeout(() => {
                            successMsg.fadeOut();
                        }, 3000);
                        
                        // Refresh the exercise dropdown for workouts
                        loadExercisesForWorkout();
                        
                        console.log('Exercise added successfully!');
                    } else {
                        alert('Error adding exercise: ' + (response.error || 'Unknown error'));
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Add exercise error:', { xhr, status, error });
                    alert('Error adding exercise: ' + error);
                }
            });
        }

        // Exercise Modal Functions
        let currentExerciseId = null;

        function openExerciseModal(exerciseId, exerciseName) {
            currentExerciseId = exerciseId;
            $('#modal-exercise-name').text(exerciseName);
            loadExerciseDetails(exerciseId);
            $('#exercise-modal').show();
        }

        function closeExerciseModal() {
            $('#exercise-modal').hide();
            currentExerciseId = null;
        }

        function loadExerciseDetails(exerciseId) {
            $.ajax({
                url: '/get_workout_exercises',
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        const exercise = response.exercises.find(ex => ex.id === exerciseId);
                        if (exercise) {
                            displayExerciseDetails(exercise);
                        }
                    }
                }
            });
        }

        function displayExerciseDetails(exercise) {
            // Calculate 1RM using Epley formula
            let oneRepMax = 0;
            if (exercise.sets_data.length > 0) {
                const maxWeightSet = exercise.sets_data.reduce((max, set) => 
                    set.weight > max.weight ? set : max
                );
                oneRepMax = Math.round(maxWeightSet.weight * (1 + maxWeightSet.reps / 30));
            }
            
            $('#one-rep-max').text(oneRepMax > 0 ? oneRepMax + ' kg' : 'No data');
            $('#one-rep-max').attr('title', 'Estimated using Epley formula');
            
            // Display sets history
            const setsHtml = exercise.sets_data.length > 0 ? 
                exercise.sets_data.map(set => `
                    <div class="set-item">
                        <div class="set-info">
                            <span class="set-weight">${set.weight} kg</span>
                            <span class="set-reps">${set.reps} reps</span>
                        </div>
                        <div class="set-actions">
                            <button onclick="editSet(${set.id})" class="action-btn">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteSet(${set.id})" class="action-btn">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('') : '<p>No sets recorded yet</p>';
            
            $('#sets-history').html(setsHtml);
        }

        function calculateWeight() {
            const percentage = $('#percentage').val();
            const oneRepMaxText = $('#one-rep-max').text();
            const oneRepMax = parseInt(oneRepMaxText);
            
            if (oneRepMax > 0 && percentage > 0) {
                const calculatedWeight = Math.round(oneRepMax * (percentage / 100));
                                        $('#calc-result').text(calculatedWeight + ' kg');
            } else {
                $('#calc-result').text('Invalid input');
            }
        }

        function addSetToExercise() {
            if (!currentExerciseId) return;
            
            const weight = $('#set-weight').val();
            const reps = $('#set-reps').val();
            
            $.ajax({
                url: '/log_weight_set',
                method: 'POST',
                data: {
                    exercise_id: currentExerciseId,
                    weight: weight,
                    reps: reps
                },
                success: function(response) {
                    if (response.success) {
                        $('#set-weight').val('');
                        $('#set-reps').val('');
                        loadExerciseDetails(currentExerciseId);
                        loadMuscleGroups();
                    }
                }
            });
        }

        // Workouts Functions
        function loadWorkouts() {
            console.log('Loading workouts...');
            $.ajax({
                url: '/get_workouts',
                method: 'GET',
                success: function(response) {
                    console.log('Load workouts response:', response);
                    if (response.success) {
                        displayWorkouts(response.workouts);
                    } else {
                        console.log('Failed to load workouts:', response.error);
                        $('#workouts-list').html('<p style="color: #b0b8b9; text-align: center; padding: 20px;">No workouts found. Create your first workout above!</p>');
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Load workouts error:', { xhr, status, error });
                    $('#workouts-list').html('<p style="color: #b0b8b9; text-align: center; padding: 20px;">Error loading workouts. Please try again.</p>');
                }
            });
        }

        function displayWorkouts(workouts) {
            const html = workouts && workouts.length > 0 ? 
                workouts.map(workout => `
                    <div class="workout-item" onclick="openWorkoutModal(${workout.id}, '${workout.name}')">
                        <div class="workout-header">
                            <h4 class="workout-name">${workout.name}</h4>
                            <span class="workout-date">${formatDate(workout.date)}</span>
                        </div>
                        <div class="workout-stats">
                            <div class="stat">
                                <span class="stat-label">Exercises</span>
                                <span class="stat-value">${workout.exercise_count || 0}</span>
                            </div>
                        </div>
                    </div>
                `).join('') : '<p>No workouts found for selected date range</p>';
            
            $('#workouts-list').html(html);
        }

        function createWorkout() {
            const name = $('#workout-name').val();
            const date = $('#workout-date').val();
            
            console.log('Creating workout:', { name, date });
            
            if (!name || !date) {
                alert('Please enter workout name and select a date');
                return;
            }
            
            $.ajax({
                url: '/create_workout',
                method: 'POST',
                data: {
                    name: name,
                    date: date
                },
                success: function(response) {
                    console.log('Create workout response:', response);
                    if (response.success) {
                        $('#workout-name').val('');
                        $('#workout-date').val('');
                        loadWorkouts();
                        alert('Workout created successfully!');
                    } else {
                        alert('Error creating workout: ' + (response.error || 'Unknown error'));
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Create workout error:', { xhr, status, error });
                    alert('Error creating workout: ' + error);
                }
            });
        }

        function loadExercisesForWorkout() {
            console.log('loadExercisesForWorkout called');
            $.ajax({
                url: '/get_workout_exercises',
                method: 'GET',
                success: function(response) {
                    console.log('Load exercises for workout response:', response);
                    console.log('Response.exercises:', response.exercises);
                    console.log('Response.exercises type:', typeof response.exercises);
                    console.log('Response.exercises is array:', Array.isArray(response.exercises));
                    console.log('Response.exercises length:', response.exercises ? response.exercises.length : 'undefined');
                    
                    if (response.success && response.exercises && Array.isArray(response.exercises) && response.exercises.length > 0) {
                        console.log('Creating options for exercises:', response.exercises);
                        const options = response.exercises.map(exercise => 
                            `<option value="${exercise.id}">${exercise.name} (${exercise.muscle_group})</option>`
                        ).join('');
                        console.log('Generated options HTML:', options);
                        $('#workout-exercise-select').html('<option value="">Select exercise</option>' + options);
                        console.log('Updated workout-exercise-select dropdown');
                    } else {
                        console.log('No exercises available for workout');
                        $('#workout-exercise-select').html('<option value="">No exercises available - Add exercises first</option>');
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Load exercises for workout error:', { xhr, status, error });
                    $('#workout-exercise-select').html('<option value="">Error loading exercises</option>');
                }
            });
        }

        // Workout Modal Functions
        let currentWorkoutId = null;

        function openWorkoutModal(workoutId, workoutName) {
            currentWorkoutId = workoutId;
            $('#modal-workout-name').text(workoutName);
            loadWorkoutDetails(workoutId);
            $('#workout-modal').show();
        }

        function closeWorkoutModal() {
            $('#workout-modal').hide();
            currentWorkoutId = null;
        }

        function loadWorkoutDetails(workoutId) {
            $.ajax({
                url: '/get_workout_details',
                method: 'GET',
                data: { workout_id: workoutId },
                success: function(response) {
                    if (response.success) {
                        displayWorkoutDetails(response.workout);
                    }
                }
            });
        }

        function displayWorkoutDetails(workout) {
            const exercisesHtml = workout.exercises && workout.exercises.length > 0 ? 
                workout.exercises.map(exercise => `
                    <div class="workout-exercise-item">
                        <div class="exercise-info">
                            <span class="exercise-name">${exercise.exercise_name}</span>
                            <span class="exercise-sets">${exercise.weight} kg × ${exercise.sets} sets × ${exercise.reps} reps</span>
                        </div>
                        <div class="exercise-actions">
                            <button onclick="removeExerciseFromWorkout(${exercise.id})" class="action-btn">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('') : '<p>No exercises added yet</p>';
            
            $('#workout-exercises-list').html(exercisesHtml);
        }

        function addExerciseToWorkout() {
            if (!currentWorkoutId) return;
            
            const exerciseId = $('#workout-exercise-select').val();
            const weight = $('#workout-weight').val();
            const sets = $('#workout-sets').val();
            const reps = $('#workout-reps').val();
            
            if (!exerciseId || !weight || !sets || !reps) {
                alert('Please fill in all fields');
                return;
            }
            
            $.ajax({
                url: '/add_exercise_to_workout',
                method: 'POST',
                data: {
                    workout_id: currentWorkoutId,
                    exercise_id: exerciseId,
                    weight: weight,
                    sets: sets,
                    reps: reps
                },
                success: function(response) {
                    if (response.success) {
                        $('#workout-exercise-select').val('');
                        $('#workout-weight').val('');
                        $('#workout-sets').val('');
                        $('#workout-reps').val('');
                        loadWorkoutDetails(currentWorkoutId);
                        
                        // Refresh the workout list to update exercise count
                        loadWorkouts();
                    } else {
                        alert('Error adding exercise to workout: ' + (response.error || 'Unknown error'));
                    }
                },
                error: function(xhr, status, error) {
                    alert('Error adding exercise to workout: ' + error);
                }
            });
        }

        function removeExerciseFromWorkout(workoutExerciseId) {
            if (confirm('Are you sure you want to remove this exercise from the workout?')) {
                $.ajax({
                    url: '/remove_exercise_from_workout',
                    method: 'POST',
                    data: {
                        workout_exercise_id: workoutExerciseId
                    },
                    success: function(response) {
                        if (response.success) {
                            loadWorkoutDetails(currentWorkoutId);
                            
                            // Refresh the workout list to update exercise count
                            loadWorkouts();
                        } else {
                            alert('Error removing exercise: ' + (response.error || 'Unknown error'));
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('Error removing exercise: ' + error);
                    }
                });
            }
        }

        // Modal Functions
        function openAddExerciseModal() {
            $('#add-exercise-modal').show();
            $('#modal-exercise-name').val('');
            $('#modal-muscle-group').val('');
        }

        function closeAddExerciseModal() {
            $('#add-exercise-modal').hide();
        }

        function openCreateWorkoutModal() {
            $('#create-workout-modal').show();
            $('#modal-workout-name').val('');
            $('#modal-workout-date').val(new Date().toISOString().split('T')[0]);
        }

        function closeCreateWorkoutModal() {
            $('#create-workout-modal').hide();
        }

        function openLogWeightModal(exerciseId, exerciseName) {
            $('#log-weight-modal').show();
            $('#log-weight-exercise-name').text(exerciseName);
            $('#log-weight-form').data('exercise-id', exerciseId);
            $('#log-weight-value').val('');
            $('#log-weight-reps').val('');
            $('#log-weight-date').val(new Date().toISOString().split('T')[0]);
        }

        function closeLogWeightModal() {
            $('#log-weight-modal').hide();
        }

        // New Functions for Exercise Management
        function loadExercisesManagement() {
            $.ajax({
                url: '/get_user_exercises',
                method: 'GET',
                success: function(response) {
                    if (response.success && response.exercises) {
                        displayExercisesManagement(response.exercises);
                    } else {
                        $('#exercises-management-list').html('<p style="color: #b0b8b9; text-align: center; padding: 20px;">No exercises found. Add your first exercise to get started!</p>');
                    }
                },
                error: function(xhr, status, error) {
                    $('#exercises-management-list').html('<p style="color: #b0b8b9; text-align: center; padding: 20px;">Error loading exercises. Please try again.</p>');
                }
            });
        }

        function displayExercisesManagement(exercises) {
            const exercisesHtml = exercises.map(exercise => {
                const weightHistoryHtml = exercise.weight_history && exercise.weight_history.length > 0 
                    ? exercise.weight_history.map(entry => `
                        <div class="weight-entry">
                            <span class="weight-value">${entry.weight} kg × ${entry.reps} reps</span>
                            <span class="weight-date">${formatDate(entry.date)}</span>
                        </div>
                    `).join('')
                    : '<div class="no-weights">No weights logged yet</div>';
                
                return `
                    <div class="exercise-card">
                        <div class="exercise-info">
                            <h4>${exercise.name}</h4>
                            <span class="muscle-group">${exercise.muscle_group}</span>
                        </div>
                        <div class="weight-history">
                            ${weightHistoryHtml}
                        </div>
                        <div class="exercise-actions">
                            <button onclick="openLogWeightModal(${exercise.id}, '${exercise.name}')" class="action-btn">
                                <i class="fas fa-plus"></i> Log Weight
                            </button>
                            <button onclick="deleteExercise(${exercise.id})" class="action-btn delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            $('#exercises-management-list').html(exercisesHtml);
        }

        function addExercise() {
            const name = $('#modal-exercise-name').val();
            const muscleGroup = $('#modal-muscle-group').val();
            
            if (!name || !muscleGroup) {
                alert('Please fill in all fields');
                return;
            }
            
            $.ajax({
                url: '/add_exercise',
                method: 'POST',
                data: {
                    name: name,
                    muscle_group: muscleGroup
                },
                success: function(response) {
                    if (response.success) {
                        closeAddExerciseModal();
                        loadMuscleGroups();
                        loadExercisesManagement();
                        alert('Exercise added successfully!');
                    } else {
                        alert('Error adding exercise: ' + (response.error || 'Unknown error'));
                    }
                },
                error: function(xhr, status, error) {
                    alert('Error adding exercise: ' + error);
                }
            });
        }

        function logWeight() {
            const exerciseId = $('#log-weight-form').data('exercise-id');
            const weight = $('#log-weight-value').val();
            const reps = $('#log-weight-reps').val();
            const date = $('#log-weight-date').val();
            
            if (!weight || !reps || !date) {
                alert('Please fill in all fields');
                return;
            }
            
            $.ajax({
                url: '/log_weight_set',
                method: 'POST',
                data: {
                    exercise_id: exerciseId,
                    weight: weight,
                    reps: reps,
                    date: date
                },
                success: function(response) {
                    if (response.success) {
                        closeLogWeightModal();
                        loadMuscleGroups();
                        loadExercisesManagement();
                        alert('Weight logged successfully!');
                    } else {
                        alert('Error logging weight: ' + (response.error || 'Unknown error'));
                    }
                },
                error: function(xhr, status, error) {
                    alert('Error logging weight: ' + error);
                }
            });
        }

        function deleteExercise(exerciseId) {
            if (confirm('Are you sure you want to delete this exercise? This will also delete all associated weight logs.')) {
                $.ajax({
                    url: '/delete_exercise',
                    method: 'POST',
                    data: {
                        exercise_id: exerciseId
                    },
                    success: function(response) {
                        if (response.success) {
                            loadMuscleGroups();
                            loadExercisesManagement();
                            alert('Exercise deleted successfully!');
                        } else {
                            alert('Error deleting exercise: ' + (response.error || 'Unknown error'));
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('Error deleting exercise: ' + error);
                    }
                });
            }
        }

        // Close modals when clicking outside
        $(window).click(function(e) {
            if (e.target.classList.contains('modal')) {
                $('.modal').hide();
            }
        });
    </script>
</body>
</html>