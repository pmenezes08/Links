<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Workout Tracking</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=1755799274">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Force cache refresh
        window.cacheVersion = '1.7';
    </script>
</head>
<body>
    <div class="workout-container">
        <!-- Header -->
        <div class="workout-header">
            <div class="header-content">
                <button class="back-btn" onclick="window.history.back()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <h1>Workout Tracking</h1>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" data-tab="performance-tracking">
                <i class="fas fa-chart-line"></i>
                Performance Tracking
            </button>
            <button class="tab-btn" data-tab="exercise-management">
                <i class="fas fa-dumbbell"></i>
                Exercise Management
            </button>
            <button class="tab-btn" data-tab="workouts">
                <i class="fas fa-calendar-alt"></i>
                Workouts
            </button>
        </div>

        <!-- Performance Tracking Tab (Read-only View) -->
        <div id="performance-tracking" class="tab-content active">
            <div class="performance-tracking-container">
                <div class="header-section">
                    <h3>Your Performance Overview</h3>
                    <button class="add-btn" onclick="openAddExerciseModal()">
                        <i class="fas fa-plus"></i> Add Exercise
                    </button>
                </div>
                
                <div class="overview-section">
                    <p class="overview-text">Your 1RM data is automatically calculated from your logged sets. Add exercises and log your performance to see your progress here.</p>
                </div>

                <!-- Analytics Section -->
                <div class="analytics-section">
                    <div class="analytics-header">
                        <h4>Progress Analytics</h4>
                        <div class="analytics-controls">
                            <select id="exercise-select" class="analytics-select">
                                <option value="">Select Exercise</option>
                            </select>
                            <select id="time-range" class="analytics-select">
                                <option value="30">Last 30 days</option>
                                <option value="90">Last 90 days</option>
                                <option value="180">Last 6 months</option>
                                <option value="365">Last year</option>
                                <option value="all">All time</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="progressChart"></canvas>
                    </div>
                </div>

                <div class="exercises-section">
                    <div id="muscle-groups-view" class="muscle-groups-view">
                        <!-- Muscle groups will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Exercise Management Tab -->
        <div id="exercise-management" class="tab-content">
            <div class="exercise-management-container">
                <div class="header-section">
                    <h3>Exercise Management</h3>
                    <button class="add-btn" onclick="openAddExerciseModal()">
                        <i class="fas fa-plus"></i> Add Exercise
                    </button>
                </div>
                
                <div class="exercises-list-section">
                    <div id="exercises-management-list" class="exercises-list">
                        <!-- Exercises will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Workouts Tab (Optional) -->
        <div id="workouts" class="tab-content">
            <div class="workouts-container">
                <div class="header-section">
                    <h3>Your Workouts</h3>
                    <button class="add-btn" onclick="openCreateWorkoutModal()">
                        <i class="fas fa-plus"></i> Create Workout
                    </button>
                </div>
                
                <div class="workouts-list-section">
                    <div id="workouts-list" class="workouts-list">
                        <!-- Workouts will be loaded here -->
                    </div>
                </div>
            </div>
        </div>


    </div>

    <!-- Exercise Detail Modal -->
    <div id="exercise-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-exercise-name">Exercise Details</h3>
                <button class="close-btn" onclick="closeExerciseModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="exercise-stats">
                    <div class="stat-card">
                        <h4>1 Rep Max</h4>
                        <div class="stat-value" id="one-rep-max" title="Estimated using Epley formula">-</div>
                        <div class="stat-formula">Estimated from your sets</div>
                    </div>
                    <div class="stat-card">
                        <h4>1RM Calculator</h4>
                        <div class="calculator">
                            <input type="number" id="percentage" placeholder="%" min="50" max="100" step="5">
                            <button onclick="calculateWeight()" class="calc-btn">Calculate</button>
                            <div class="calc-result" id="calc-result">-</div>
                        </div>
                    </div>
                </div>
                <div class="sets-history">
                    <h4>Weight History</h4>
                    <div id="sets-history" class="sets-list">
                        <!-- Sets will be loaded here -->
                    </div>
                </div>
                <div class="add-set-section">
                    <h4>Add New Set</h4>
                    <form id="add-set-form" class="set-form">
                        <div class="form-row">
                            <input type="number" id="set-weight" placeholder="Weight (kg)" required>
                            <input type="number" id="set-reps" placeholder="Reps" required>
                        </div>
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-plus"></i> Add Set
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Exercise Modal -->
    <div id="add-exercise-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Exercise</h3>
                <button class="close-btn" onclick="closeAddExerciseModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="add-exercise-form" class="exercise-form">
                    <div class="form-group">
                        <label for="add-exercise-name">Exercise Name</label>
                        <input type="text" id="add-exercise-name" placeholder="e.g., Bench Press" required>
                    </div>
                    <div class="form-group">
                        <label for="modal-muscle-group">Muscle Group</label>
                        <select id="modal-muscle-group" required>
                            <option value="">Select muscle group</option>
                            <option value="Chest">Chest</option>
                            <option value="Back">Back</option>
                            <option value="Shoulders">Shoulders</option>
                            <option value="Biceps">Biceps</option>
                            <option value="Triceps">Triceps</option>
                            <option value="Legs">Legs</option>
                            <option value="Core">Core</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modal-exercise-weight">Weight (kg)</label>
                        <input type="number" id="modal-exercise-weight" placeholder="e.g., 80" min="0" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="modal-exercise-reps">Reps</label>
                        <input type="number" id="modal-exercise-reps" placeholder="e.g., 8" min="1" max="50" required>
                    </div>
                    <div class="form-group">
                        <label for="modal-exercise-date">Date</label>
                        <input type="date" id="modal-exercise-date" max="" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-plus"></i> Add Exercise
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Workout Modal -->
    <div id="create-workout-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Workout</h3>
                <button class="close-btn" onclick="closeCreateWorkoutModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="create-workout-form" class="workout-form">
                    <div class="form-group">
                        <label for="modal-workout-name">Workout Name</label>
                        <input type="text" id="modal-workout-name" placeholder="e.g., Push Day" required>
                    </div>
                    <div class="form-group">
                        <label for="modal-workout-date">Date</label>
                        <input type="date" id="modal-workout-date" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-plus"></i> Create Workout
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Log Weight Modal -->
    <div id="log-weight-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="log-weight-exercise-name">Log Weight</h3>
                <button class="close-btn" onclick="closeLogWeightModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="log-weight-form" class="weight-form">
                    <div class="form-group">
                        <label for="log-weight-value">Weight (kg)</label>
                        <input type="number" id="log-weight-value" placeholder="e.g., 80" min="0" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="log-weight-reps">Reps</label>
                        <input type="number" id="log-weight-reps" placeholder="e.g., 8" min="1" max="50" required>
                    </div>
                    <div class="form-group">
                        <label for="log-weight-date">Date</label>
                        <input type="date" id="log-weight-date" max="" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-plus"></i> Log Weight
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Workout Detail Modal -->
    <div id="workout-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-workout-name">Workout Details</h3>
                <button class="close-btn" onclick="closeWorkoutModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="workout-exercises">
                    <h4>Exercises</h4>
                    <div id="workout-exercises-list" class="exercises-list">
                        <!-- Workout exercises will be loaded here -->
                    </div>
                </div>
                <div class="add-exercise-to-workout">
                    <h4>Add Exercise to Workout</h4>
                    <form id="add-exercise-to-workout-form" class="exercise-form">
                        <div class="form-row">
                            <select id="workout-exercise-select" required>
                                <option value="">Select exercise</option>
                            </select>
                            <input type="number" id="workout-weight" placeholder="Weight (kg)" min="0" step="0.1" required>
                            <input type="number" id="workout-sets" placeholder="Sets" min="1" max="10" required>
                            <input type="number" id="workout-reps" placeholder="Reps" min="1" max="50" required>
                        </div>
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-plus"></i> Add to Workout
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // Set default date to today
            $('#log-weight-date').val(new Date().toISOString().split('T')[0]);
            $('#modal-workout-date').val(new Date().toISOString().split('T')[0]);
            $('#modal-exercise-date').val(new Date().toISOString().split('T')[0]);

            // Load initial data
            loadMuscleGroups();
            loadExercisesManagement();
            loadWorkouts();
            loadAnalyticsData();

            // Analytics event listeners
            $('#exercise-select').change(function() {
                updateProgressChart();
            });

            $('#time-range').change(function() {
                updateProgressChart();
            });

            // Tab switching
            $('.tab-btn').click(function() {
                $('.tab-btn').removeClass('active');
                $(this).addClass('active');
                
                const tabId = $(this).data('tab');
                $('.tab-content').removeClass('active');
                $('#' + tabId).addClass('active');
            });

            // Modal event handlers
            $('#add-exercise-form').submit(function(e) {
                e.preventDefault();
                console.log('Form submit event triggered');
                console.log('Form element:', this);
                console.log('Form fields before addExercise:');
                console.log('Name field:', $('#add-exercise-name').val());
                console.log('Name field element:', $('#add-exercise-name')[0]);
                addExercise();
            });

            $('#create-workout-form').submit(function(e) {
                e.preventDefault();
                createWorkout();
            });

            $('#log-weight-form').submit(function(e) {
                e.preventDefault();
                logWeight();
            });

            // Add exercise form
            $('#add-exercise-form').submit(function(e) {
                e.preventDefault();
                addExercise();
            });

            // Create workout form
            $('#create-workout-form').submit(function(e) {
                e.preventDefault();
                console.log('Create workout form submitted');
                createWorkout();
            });



            // Add set form
            $('#add-set-form').submit(function(e) {
                e.preventDefault();
                addSetToExercise();
            });

            // Add exercise to workout form
            $('#add-exercise-to-workout-form').submit(function(e) {
                e.preventDefault();
                addExerciseToWorkout();
            });
        });

        // Utility Functions
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const today = new Date();
            
            // Check if it's the current year
            if (date.getFullYear() === today.getFullYear()) {
                return date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric'
                });
            } else {
                return date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    year: 'numeric'
                });
            }
        }

        // Performance Tracking Functions (Read-only)
        function loadMuscleGroups() {
            console.log('Loading muscle groups...');
            $.ajax({
                url: '/get_workout_exercises',
                method: 'GET',
                success: function(response) {
                    console.log('Load muscle groups response:', response);
                    console.log('Response type:', typeof response);
                    console.log('Response.success:', response.success);
                    console.log('Response.exercises:', response.exercises);
                    console.log('Response.exercises length:', response.exercises ? response.exercises.length : 'undefined');
                    
                    if (response.success && response.exercises && response.exercises.length > 0) {
                        console.log('Found exercises, displaying muscle groups');
                        displayMuscleGroups(response.exercises);
                    } else if (response.success && (!response.exercises || response.exercises.length === 0)) {
                        // No exercises found but request was successful
                        console.log('No exercises found in database');
                        $('#muscle-groups-view').html('<p style="color: #b0b8b9; text-align: center; padding: 20px;">No exercises found. Add exercises in the Workouts tab to see your 1RM data here!</p>');
                    } else {
                        console.log('Failed to load muscle groups:', response.error);
                        $('#muscle-groups-view').html('<p style="color: #b0b8b9; text-align: center; padding: 20px;">No exercises found. Add exercises in the Workouts tab to see your 1RM data here!</p>');
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Load muscle groups error:', { xhr, status, error });
                    $('#muscle-groups-view').html('<p style="color: #b0b8b9; text-align: center; padding: 20px;">Error loading exercises. Please try again.</p>');
                }
            });
        }

        function displayMuscleGroups(exercises) {
            console.log('Displaying muscle groups with exercises:', exercises);
            
            if (!exercises || !Array.isArray(exercises)) {
                console.log('No exercises found or invalid data structure');
                $('#muscle-groups-view').html('<p style="color: #b0b8b9; text-align: center; padding: 20px;">No exercises found. Add exercises in the Workouts tab to see your 1RM data here!</p>');
                return;
            }
            
            const muscleGroups = {};
            
            exercises.forEach(exercise => {
                if (!muscleGroups[exercise.muscle_group]) {
                    muscleGroups[exercise.muscle_group] = [];
                }
                muscleGroups[exercise.muscle_group].push(exercise);
            });

            if (Object.keys(muscleGroups).length === 0) {
                $('#muscle-groups-view').html('<p style="color: #b0b8b9; text-align: center; padding: 20px;">No exercises found. Add exercises in the Workouts tab to see your 1RM data here!</p>');
                return;
            }

            const html = Object.keys(muscleGroups).map(group => {
                const exercisesInGroup = muscleGroups[group];
                                        const maxWeight = Math.max(...exercisesInGroup.map(ex => 
                            ex.sets_data && ex.sets_data.length > 0 ? Math.max(...ex.sets_data.map(set => set.weight || 0)) : 0
                        ));
                        
                        return `
                            <div class="muscle-group-card" onclick="showExercises('${group}')">
                                <div class="muscle-group-header">
                                    <h3>${group}</h3>
                                    <span class="exercise-count">${exercisesInGroup.length} exercises</span>
                                </div>
                                <div class="muscle-group-stats">
                                    <div class="stat">
                                        <span class="stat-label">Max Weight</span>
                                        <span class="stat-value">${maxWeight > 0 ? maxWeight + ' kg' : 'No data'}</span>
                                    </div>
                                </div>
                            </div>
                        `;
            }).join('');

            $('#muscle-groups-view').html(html);
        }

        function showExercises(muscleGroup) {
            $.ajax({
                url: '/get_workout_exercises',
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        const exercises = response.exercises.filter(ex => ex.muscle_group === muscleGroup);
                        displayExercisesForGroup(exercises, muscleGroup);
                    }
                }
            });
        }

        function displayExercisesForGroup(exercises, muscleGroup) {
            console.log('Displaying exercises for group:', muscleGroup, exercises);
            
            if (!exercises || !Array.isArray(exercises) || exercises.length === 0) {
                const html = `
                    <div class="view-header">
                        <button class="back-btn" onclick="showMuscleGroups()">
                            <i class="fas fa-arrow-left"></i> Back to Muscle Groups
                        </button>
                        <h3>${muscleGroup} Exercises</h3>
                    </div>
                    <div class="exercises-list">
                        <p style="color: #b0b8b9; text-align: center; padding: 20px;">No exercises in this muscle group yet.</p>
                    </div>
                `;
                $('#muscle-groups-view').html(html);
                return;
            }
            
            const html = `
                <div class="view-header">
                    <button class="back-btn" onclick="showMuscleGroups()">
                        <i class="fas fa-arrow-left"></i> Back to Muscle Groups
                    </button>
                    <h3>${muscleGroup} Exercises</h3>
                </div>
                <div class="exercises-list">
                    ${exercises.map(exercise => {
                        const setsData = exercise.sets_data || [];
                        const maxWeight = setsData.length > 0 ? 
                            Math.max(...setsData.map(set => set.weight || 0)) : 0;
                        const maxWeightSet = setsData.find(set => set.weight === maxWeight);
                        
                        // Calculate 1RM using Epley formula
                        let oneRepMax = 0;
                        if (maxWeightSet) {
                            oneRepMax = Math.round(maxWeightSet.weight * (1 + maxWeightSet.reps / 30));
                        }
                        
                        return `
                            <div class="exercise-item" onclick="openExerciseModal(${exercise.id}, '${exercise.name}')">
                                <div class="exercise-header">
                                    <h4 class="exercise-name">${exercise.name}</h4>
                                </div>
                                <div class="exercise-stats">
                                                            <div class="stat">
                            <span class="stat-label">1 Rep Max</span>
                            <span class="stat-value" title="Estimated using Epley formula">${oneRepMax > 0 ? oneRepMax + ' kg' : 'No data'}</span>
                        </div>
                                    <div class="stat">
                                        <span class="stat-label">Max Weight</span>
                                        <span class="stat-value">${maxWeight > 0 ? maxWeight + ' kg' : 'No data'}</span>
                                    </div>
                                    <div class="stat">
                                        <span class="stat-label">Total Sets</span>
                                        <span class="stat-value">${setsData.length}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            $('#muscle-groups-view').html(html);
        }

        function showMuscleGroups() {
            loadMuscleGroups();
        }

        // Workouts Functions (Input Section) - REMOVED OLD addExercise FUNCTION

        // Exercise Modal Functions
        let currentExerciseId = null;

        function openExerciseModal(exerciseId, exerciseName) {
            currentExerciseId = exerciseId;
            $('#modal-exercise-name').text(exerciseName);
            loadExerciseDetails(exerciseId);
            $('#exercise-modal').show();
        }

        function closeExerciseModal() {
            $('#exercise-modal').hide();
            currentExerciseId = null;
        }

        function loadExerciseDetails(exerciseId) {
            $.ajax({
                url: '/get_workout_exercises',
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        const exercise = response.exercises.find(ex => ex.id === exerciseId);
                        if (exercise) {
                            displayExerciseDetails(exercise);
                        }
                    }
                }
            });
        }

        function displayExerciseDetails(exercise) {
            // Calculate 1RM using Epley formula
            let oneRepMax = 0;
            if (exercise.sets_data.length > 0) {
                const maxWeightSet = exercise.sets_data.reduce((max, set) => 
                    set.weight > max.weight ? set : max
                );
                oneRepMax = Math.round(maxWeightSet.weight * (1 + maxWeightSet.reps / 30));
            }
            
            $('#one-rep-max').text(oneRepMax > 0 ? oneRepMax + ' kg' : 'No data');
            $('#one-rep-max').attr('title', 'Estimated using Epley formula');
            
            // Display sets history
            const setsHtml = exercise.sets_data.length > 0 ? 
                exercise.sets_data.map(set => `
                    <div class="set-item">
                        <div class="set-info">
                            <span class="set-weight">${set.weight} kg</span>
                            <span class="set-reps">${set.reps} reps</span>
                        </div>
                        <div class="set-actions">
                            <button onclick="editSet(${set.id})" class="action-btn">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteSet(${set.id})" class="action-btn">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('') : '<p>No sets recorded yet</p>';
            
            $('#sets-history').html(setsHtml);
        }

        function calculateWeight() {
            const percentage = $('#percentage').val();
            const oneRepMaxText = $('#one-rep-max').text();
            const oneRepMax = parseInt(oneRepMaxText);
            
            if (oneRepMax > 0 && percentage > 0) {
                const calculatedWeight = Math.round(oneRepMax * (percentage / 100));
                                        $('#calc-result').text(calculatedWeight + ' kg');
            } else {
                $('#calc-result').text('Invalid input');
            }
        }

        function addSetToExercise() {
            if (!currentExerciseId) return;
            
            const weight = $('#set-weight').val();
            const reps = $('#set-reps').val();
            
            $.ajax({
                url: '/log_weight_set',
                method: 'POST',
                data: {
                    exercise_id: currentExerciseId,
                    weight: weight,
                    reps: reps
                },
                success: function(response) {
                    if (response.success) {
                        $('#set-weight').val('');
                        $('#set-reps').val('');
                        loadExerciseDetails(currentExerciseId);
                        loadMuscleGroups();
                    }
                }
            });
        }

        // Workouts Functions
        function loadWorkouts() {
            console.log('Loading workouts...');
            $.ajax({
                url: '/get_workouts',
                method: 'GET',
                success: function(response) {
                    console.log('Load workouts response:', response);
                    if (response.success) {
                        displayWorkouts(response.workouts);
                    } else {
                        console.log('Failed to load workouts:', response.error);
                        $('#workouts-list').html('<p style="color: #b0b8b9; text-align: center; padding: 20px;">No workouts found. Create your first workout above!</p>');
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Load workouts error:', { xhr, status, error });
                    $('#workouts-list').html('<p style="color: #b0b8b9; text-align: center; padding: 20px;">Error loading workouts. Please try again.</p>');
                }
            });
        }

        function displayWorkouts(workouts) {
            const html = workouts && workouts.length > 0 ? 
                workouts.map(workout => `
                    <div class="workout-item" onclick="openWorkoutModal(${workout.id}, '${workout.name}')">
                        <div class="workout-header">
                            <h4 class="workout-name">${workout.name}</h4>
                            <span class="workout-date">${formatDate(workout.date)}</span>
                        </div>
                        <div class="workout-stats">
                            <div class="stat">
                                <span class="stat-label">Exercises</span>
                                <span class="stat-value">${workout.exercise_count || 0}</span>
                            </div>
                        </div>
                    </div>
                `).join('') : '<p>No workouts found for selected date range</p>';
            
            $('#workouts-list').html(html);
        }

        function createWorkout() {
            const name = $('#workout-name').val();
            const date = $('#workout-date').val();
            
            console.log('Creating workout:', { name, date });
            
            if (!name || !date) {
                alert('Please enter workout name and select a date');
                return;
            }
            
            $.ajax({
                url: '/create_workout',
                method: 'POST',
                data: {
                    name: name,
                    date: date
                },
                success: function(response) {
                    console.log('Create workout response:', response);
                    if (response.success) {
                        $('#workout-name').val('');
                        $('#workout-date').val('');
                        loadWorkouts();
                        alert('Workout created successfully!');
                    } else {
                        alert('Error creating workout: ' + (response.error || 'Unknown error'));
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Create workout error:', { xhr, status, error });
                    alert('Error creating workout: ' + error);
                }
            });
        }

        function loadExercisesForWorkout() {
            console.log('loadExercisesForWorkout called');
            $.ajax({
                url: '/get_user_exercises',
                method: 'GET',
                success: function(response) {
                    console.log('Load exercises for workout response:', response);
                    console.log('Response.exercises:', response.exercises);
                    console.log('Response.exercises type:', typeof response.exercises);
                    console.log('Response.exercises is array:', Array.isArray(response.exercises));
                    console.log('Response.exercises length:', response.exercises ? response.exercises.length : 'undefined');
                    
                    if (response.success && response.exercises && Array.isArray(response.exercises) && response.exercises.length > 0) {
                        console.log('Creating options for exercises:', response.exercises);
                        const options = response.exercises.map(exercise => 
                            `<option value="${exercise.id}">${exercise.name} (${exercise.muscle_group})</option>`
                        ).join('');
                        console.log('Generated options HTML:', options);
                        $('#workout-exercise-select').html('<option value="">Select exercise</option>' + options);
                        console.log('Updated workout-exercise-select dropdown');
                    } else {
                        console.log('No exercises available for workout');
                        $('#workout-exercise-select').html('<option value="">No exercises available - Add exercises first</option>');
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Load exercises for workout error:', { xhr, status, error });
                    $('#workout-exercise-select').html('<option value="">Error loading exercises</option>');
                }
            });
        }

        // Workout Modal Functions
        let currentWorkoutId = null;

        function openWorkoutModal(workoutId, workoutName) {
            currentWorkoutId = workoutId;
            $('#modal-workout-name').text(workoutName);
            loadWorkoutDetails(workoutId);
            loadExercisesForWorkout();
            $('#workout-modal').show();
        }

        function closeWorkoutModal() {
            $('#workout-modal').hide();
            currentWorkoutId = null;
        }

        function loadWorkoutDetails(workoutId) {
            $.ajax({
                url: '/get_workout_details',
                method: 'GET',
                data: { workout_id: workoutId },
                success: function(response) {
                    if (response.success) {
                        displayWorkoutDetails(response.workout);
                    }
                }
            });
        }

        function displayWorkoutDetails(workout) {
            const exercisesHtml = workout.exercises && workout.exercises.length > 0 ? 
                workout.exercises.map(exercise => `
                    <div class="workout-exercise-item">
                        <div class="exercise-info">
                            <span class="exercise-name">${exercise.exercise_name}</span>
                            <span class="exercise-sets">${exercise.weight} kg × ${exercise.sets} sets × ${exercise.reps} reps</span>
                        </div>
                        <div class="exercise-actions">
                            <button onclick="editExerciseInWorkout(${exercise.id}, '${exercise.exercise_name}', ${exercise.weight}, ${exercise.sets}, ${exercise.reps})" class="action-btn edit" title="Edit exercise">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="removeExerciseFromWorkout(${exercise.id})" class="action-btn" title="Remove exercise">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('') : '<p>No exercises added yet</p>';
            
            $('#workout-exercises-list').html(exercisesHtml);
        }

        function addExerciseToWorkout() {
            if (!currentWorkoutId) return;
            
            const exerciseId = $('#workout-exercise-select').val();
            const weight = $('#workout-weight').val();
            const sets = $('#workout-sets').val();
            const reps = $('#workout-reps').val();
            
            if (!exerciseId || !weight || !sets || !reps) {
                alert('Please fill in all fields');
                return;
            }
            
            // Check if exercise is already in the workout
            checkExerciseInWorkout(exerciseId, function(isDuplicate, existingExercise) {
                console.log('Duplicate check result:', isDuplicate);
                if (isDuplicate) {
                    console.log('Exercise is duplicate, showing update dialog');
                    showUpdateExerciseDialog(existingExercise, weight, sets, reps);
                    return;
                }
                
                // Check if weight exceeds current 1RM before adding to workout
                checkAndUpdateOneRM(exerciseId, weight, reps, function(shouldProceed) {
                    if (shouldProceed) {
                        $.ajax({
                            url: '/add_exercise_to_workout',
                            method: 'POST',
                            data: {
                                workout_id: currentWorkoutId,
                                exercise_id: exerciseId,
                                weight: weight,
                                sets: sets,
                                reps: reps
                            },
                            success: function(response) {
                                if (response.success) {
                                    $('#workout-exercise-select').val('');
                                    $('#workout-weight').val('');
                                    $('#workout-sets').val('');
                                    $('#workout-reps').val('');
                                    loadWorkoutDetails(currentWorkoutId);
                                    
                                    // Refresh the workout list to update exercise count
                                    loadWorkouts();
                                } else {
                                    alert('Error adding exercise to workout: ' + (response.error || 'Unknown error'));
                                }
                            },
                            error: function(xhr, status, error) {
                                alert('Error adding exercise to workout: ' + error);
                            }
                        });
                    }
                });
            });
        }

        function checkExerciseInWorkout(exerciseId, callback) {
            console.log('Checking if exercise', exerciseId, 'is already in workout', currentWorkoutId);
            $.ajax({
                url: '/check_exercise_in_workout',
                method: 'GET',
                data: {
                    workout_id: currentWorkoutId,
                    exercise_id: exerciseId
                },
                success: function(response) {
                    console.log('Check exercise response:', response);
                    if (response.success) {
                        console.log('Exercise is duplicate:', response.is_duplicate);
                        callback(response.is_duplicate, response.existing_exercise);
                    } else {
                        console.log('Error checking exercise in workout: ' + (response.error || 'Unknown error'));
                        callback(false, null); // Allow adding if check fails
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Error checking exercise in workout: ' + error);
                    callback(false, null); // Allow adding if check fails
                }
            });
        }

        function editExerciseInWorkout(exerciseId, exerciseName, currentWeight, currentSets, currentReps) {
            // Populate the form with current values
            $('#workout-weight').val(currentWeight);
            $('#workout-sets').val(currentSets);
            $('#workout-reps').val(currentReps);
            
            // Show a dialog to confirm the edit
            const message = `Edit ${exerciseName}\n\nCurrent: ${currentWeight} kg × ${currentSets} sets × ${currentReps} reps\n\nPlease update the values below and click "Update Exercise" to save changes.`;
            alert(message);
            
            // Change the form submission to update instead of add
            $('#add-exercise-to-workout-form').off('submit').on('submit', function(e) {
                e.preventDefault();
                updateExistingExerciseInWorkout(exerciseId);
            });
            
            // Change the submit button text
            $('#add-exercise-to-workout-form .submit-btn').html('<i class="fas fa-save"></i> Update Exercise');
        }

        function updateExistingExerciseInWorkout(exerciseId) {
            const weight = $('#workout-weight').val();
            const sets = $('#workout-sets').val();
            const reps = $('#workout-reps').val();
            
            if (!weight || !sets || !reps) {
                alert('Please fill in all fields');
                return;
            }
            
            $.ajax({
                url: '/update_exercise_in_workout',
                method: 'POST',
                data: {
                    workout_exercise_id: exerciseId,
                    weight: weight,
                    sets: sets,
                    reps: reps
                },
                success: function(response) {
                    if (response.success) {
                        // Clear the form
                        $('#workout-exercise-select').val('');
                        $('#workout-weight').val('');
                        $('#workout-sets').val('');
                        $('#workout-reps').val('');
                        
                        // Reset the form submission handler
                        $('#add-exercise-to-workout-form').off('submit').on('submit', function(e) {
                            e.preventDefault();
                            addExerciseToWorkout();
                        });
                        
                        // Reset the submit button text
                        $('#add-exercise-to-workout-form .submit-btn').html('<i class="fas fa-plus"></i> Add to Workout');
                        
                        // Refresh the workout details
                        loadWorkoutDetails(currentWorkoutId);
                        loadWorkouts();
                        
                        alert('Exercise updated successfully!');
                    } else {
                        alert('Error updating exercise: ' + (response.error || 'Unknown error'));
                    }
                },
                error: function(xhr, status, error) {
                    alert('Error updating exercise: ' + error);
                }
            });
        }

        function showUpdateExerciseDialog(existingExercise, newWeight, newSets, newReps) {
            const message = `${existingExercise.name} is already in this workout.\n\nCurrent: ${existingExercise.weight} kg × ${existingExercise.sets} sets × ${existingExercise.reps} reps\nNew: ${newWeight} kg × ${newSets} sets × ${newReps} reps\n\nWould you like to update the existing entry?`;
            
            if (confirm(message)) {
                // Update the existing exercise
                $.ajax({
                    url: '/update_exercise_in_workout',
                    method: 'POST',
                    data: {
                        workout_exercise_id: existingExercise.id,
                        weight: newWeight,
                        sets: newSets,
                        reps: newReps
                    },
                    success: function(response) {
                        if (response.success) {
                            // Clear the form
                            $('#workout-exercise-select').val('');
                            $('#workout-weight').val('');
                            $('#workout-sets').val('');
                            $('#workout-reps').val('');
                            
                            // Refresh the workout details
                            loadWorkoutDetails(currentWorkoutId);
                            loadWorkouts();
                            
                            alert('Exercise updated successfully!');
                        } else {
                            alert('Error updating exercise: ' + (response.error || 'Unknown error'));
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('Error updating exercise: ' + error);
                    }
                });
            }
        }

        function checkAndUpdateOneRM(exerciseId, weight, reps, callback) {
            // Calculate 1RM for the input weight and reps
            const inputOneRM = weight * (1 + reps / 30);
            
            // Get current 1RM for the exercise
            $.ajax({
                url: '/get_exercise_one_rm',
                method: 'GET',
                data: { exercise_id: exerciseId },
                success: function(response) {
                    if (response.success) {
                        const currentOneRM = response.one_rm || 0;
                        
                        if (inputOneRM > currentOneRM) {
                            // Show confirmation dialog
                            const confirmMessage = `Your input weight (${weight} kg × ${reps} reps) results in a 1RM of ${inputOneRM.toFixed(1)} kg, which is higher than your current 1RM of ${currentOneRM.toFixed(1)} kg.\n\nWould you like to update your 1RM in the Exercise Management tab?`;
                            
                            if (confirm(confirmMessage)) {
                                // Update the 1RM in Exercise Management
                                $.ajax({
                                    url: '/update_exercise_one_rm',
                                    method: 'POST',
                                    data: {
                                        exercise_id: exerciseId,
                                        weight: weight,
                                        reps: reps
                                    },
                                    success: function(updateResponse) {
                                        if (updateResponse.success) {
                                            alert('1RM updated successfully!');
                                            // Refresh the Exercise Management view
                                            loadExercisesManagement();
                                        } else {
                                            alert('Error updating 1RM: ' + (updateResponse.error || 'Unknown error'));
                                        }
                                        callback(true); // Proceed with adding to workout
                                    },
                                    error: function(xhr, status, error) {
                                        alert('Error updating 1RM: ' + error);
                                        callback(true); // Proceed with adding to workout anyway
                                    }
                                });
                            } else {
                                callback(true); // Proceed with adding to workout without updating 1RM
                            }
                        } else {
                            callback(true); // Weight doesn't exceed 1RM, proceed normally
                        }
                    } else {
                        console.log('Error getting current 1RM: ' + (response.error || 'Unknown error'));
                        callback(true); // Proceed with adding to workout anyway
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Error getting current 1RM: ' + error);
                    callback(true); // Proceed with adding to workout anyway
                }
            });
        }

        function removeExerciseFromWorkout(workoutExerciseId) {
            if (confirm('Are you sure you want to remove this exercise from the workout?')) {
                $.ajax({
                    url: '/remove_exercise_from_workout',
                    method: 'POST',
                    data: {
                        workout_exercise_id: workoutExerciseId
                    },
                    success: function(response) {
                        if (response.success) {
                            loadWorkoutDetails(currentWorkoutId);
                            
                            // Refresh the workout list to update exercise count
                            loadWorkouts();
                        } else {
                            alert('Error removing exercise: ' + (response.error || 'Unknown error'));
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('Error removing exercise: ' + error);
                    }
                });
            }
        }

        // Modal Functions
        function openAddExerciseModal() {
            console.log('Opening Add Exercise Modal...');
            $('#add-exercise-modal').show();
            $('#add-exercise-name').val('');
            $('#modal-muscle-group').val('');
            $('#modal-exercise-weight').val('');
            $('#modal-exercise-reps').val('');
            
            // Set max date to today and default to today
            const today = new Date().toISOString().split('T')[0];
            $('#modal-exercise-date').attr('max', today);
            $('#modal-exercise-date').val(today);
            
            console.log('Modal should be visible now');
            console.log('Modal HTML:', $('#add-exercise-modal').html());
        }

        function closeAddExerciseModal() {
            $('#add-exercise-modal').hide();
        }

        function openCreateWorkoutModal() {
            $('#create-workout-modal').show();
            $('#modal-workout-name').val('');
            $('#modal-workout-date').val(new Date().toISOString().split('T')[0]);
        }

        function closeCreateWorkoutModal() {
            $('#create-workout-modal').hide();
        }

        function openLogWeightModal(exerciseId, exerciseName) {
            $('#log-weight-modal').show();
            $('#log-weight-exercise-name').text(exerciseName);
            $('#log-weight-form').data('exercise-id', exerciseId);
            $('#log-weight-value').val('');
            $('#log-weight-reps').val('');
            
            // Set max date to today and default to today
            const today = new Date().toISOString().split('T')[0];
            $('#log-weight-date').attr('max', today);
            $('#log-weight-date').val(today);
        }

        function closeLogWeightModal() {
            $('#log-weight-modal').hide();
        }

        // New Functions for Exercise Management
        function loadExercisesManagement() {
            $.ajax({
                url: '/get_user_exercises',
                method: 'GET',
                success: function(response) {
                    if (response.success && response.exercises) {
                        displayExercisesManagement(response.exercises);
                    } else {
                        $('#exercises-management-list').html('<p style="color: #b0b8b9; text-align: center; padding: 20px;">No exercises found. Add your first exercise to get started!</p>');
                    }
                },
                error: function(xhr, status, error) {
                    $('#exercises-management-list').html('<p style="color: #b0b8b9; text-align: center; padding: 20px;">Error loading exercises. Please try again.</p>');
                }
            });
        }

        function displayExercisesManagement(exercises) {
            // Group exercises by muscle group
            const muscleGroups = {};
            exercises.forEach(exercise => {
                if (!muscleGroups[exercise.muscle_group]) {
                    muscleGroups[exercise.muscle_group] = [];
                }
                muscleGroups[exercise.muscle_group].push(exercise);
            });
            
            const exercisesHtml = Object.keys(muscleGroups).map(muscleGroup => {
                const exercisesInGroup = muscleGroups[muscleGroup];
                const exercisesList = exercisesInGroup.map(exercise => {
                    const weightHistoryHtml = exercise.weight_history && exercise.weight_history.length > 0 
                        ? exercise.weight_history.map(entry => `
                            <div class="weight-entry">
                                <span class="weight-value">${entry.weight} kg × ${entry.reps} reps</span>
                                <span class="weight-date">${formatDate(entry.date)}</span>
                                <button onclick="deleteWeightEntry(${exercise.id}, '${entry.date}', ${entry.weight}, ${entry.reps})" class="delete-weight-btn" title="Delete this weight entry">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `).join('')
                        : '<div class="no-weights">No weights logged yet</div>';
                    
                    return `
                        <div class="exercise-row" data-exercise-id="${exercise.id}">
                            <div class="exercise-header" onclick="toggleWeightHistory(${exercise.id})">
                                <div class="exercise-info">
                                    <span class="exercise-name">${exercise.name}</span>
                                    <span class="exercise-count">${exercise.weight_history ? exercise.weight_history.length : 0} entries</span>
                                </div>
                                <div class="exercise-actions">
                                    <button onclick="event.stopPropagation(); openLogWeightModal(${exercise.id}, '${exercise.name}')" class="action-btn small">
                                        <i class="fas fa-plus"></i> Add Weight
                                    </button>
                                    <button onclick="event.stopPropagation(); deleteExercise(${exercise.id})" class="action-btn small delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <i class="fas fa-chevron-down toggle-icon" id="toggle-${exercise.id}"></i>
                                </div>
                            </div>
                            <div class="weight-history-dropdown" id="history-${exercise.id}" style="display: none;">
                                <div class="weight-history">
                                    ${weightHistoryHtml}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="muscle-group-section">
                        <h3 class="muscle-group-title">${muscleGroup}</h3>
                        <div class="exercises-list">
                            ${exercisesList}
                        </div>
                    </div>
                `;
            }).join('');
            
            $('#exercises-management-list').html(exercisesHtml);
        }

        function addExercise() {
            // Add a small delay to ensure form values are properly set
            setTimeout(() => {
                const name = $('#add-exercise-name').val();
                const muscleGroup = $('#modal-muscle-group').val();
                const weight = $('#modal-exercise-weight').val();
                const reps = $('#modal-exercise-reps').val();
                const date = $('#modal-exercise-date').val();
                
                console.log('addExercise called with values:', { name, muscleGroup, weight, reps, date });
                console.log('Field values:', {
                    name: $('#add-exercise-name').val(),
                    muscleGroup: $('#modal-muscle-group').val(),
                    weight: $('#modal-exercise-weight').val(),
                    reps: $('#modal-exercise-reps').val(),
                    date: $('#modal-exercise-date').val()
                });
                
                if (!name || !muscleGroup || !weight || !reps || !date) {
                    console.log('Validation failed - missing fields');
                    console.log('Empty fields:', {
                        name: !name,
                        muscleGroup: !muscleGroup,
                        weight: !weight,
                        reps: !reps,
                        date: !date
                    });
                    alert('Please fill in all fields');
                    return;
                }
                
                // Check if date is in the future
                const selectedDate = new Date(date);
                const today = new Date();
                today.setHours(23, 59, 59, 999); // Set to end of today
                
                if (selectedDate > today) {
                    alert('Cannot log exercises for future dates. Please select today or an earlier date.');
                    return;
                }
            
            $.ajax({
                url: '/add_exercise',
                method: 'POST',
                data: {
                    name: name,
                    muscle_group: muscleGroup,
                    weight: weight,
                    reps: reps,
                    date: date
                },
                success: function(response) {
                    if (response.success) {
                        closeAddExerciseModal();
                        loadMuscleGroups();
                        loadExercisesManagement();
                        alert('Exercise added successfully!');
                    } else {
                        alert('Error adding exercise: ' + (response.error || 'Unknown error'));
                    }
                },
                error: function(xhr, status, error) {
                    alert('Error adding exercise: ' + error);
                }
            });
            }, 100); // Close setTimeout
        }

        function logWeight() {
            const exerciseId = $('#log-weight-form').data('exercise-id');
            const weight = $('#log-weight-value').val();
            const reps = $('#log-weight-reps').val();
            const date = $('#log-weight-date').val();
            
            if (!weight || !reps || !date) {
                alert('Please fill in all fields');
                return;
            }
            
            // Check if date is in the future
            const selectedDate = new Date(date);
            const today = new Date();
            today.setHours(23, 59, 59, 999); // Set to end of today
            
            if (selectedDate > today) {
                alert('Cannot log exercises for future dates. Please select today or an earlier date.');
                return;
            }
            
            $.ajax({
                url: '/log_weight_set',
                method: 'POST',
                data: {
                    exercise_id: exerciseId,
                    weight: weight,
                    reps: reps,
                    date: date
                },
                success: function(response) {
                    if (response.success) {
                        closeLogWeightModal();
                        loadMuscleGroups();
                        loadExercisesManagement();
                        alert('Weight logged successfully!');
                    } else {
                        alert('Error logging weight: ' + (response.error || 'Unknown error'));
                    }
                },
                error: function(xhr, status, error) {
                    alert('Error logging weight: ' + error);
                }
            });
        }

        function deleteExercise(exerciseId) {
            if (confirm('Are you sure you want to delete this exercise? This will also delete all associated weight logs.')) {
                $.ajax({
                    url: '/delete_exercise',
                    method: 'POST',
                    data: {
                        exercise_id: exerciseId
                    },
                    success: function(response) {
                        if (response.success) {
                            loadMuscleGroups();
                            loadExercisesManagement();
                            alert('Exercise deleted successfully!');
                        } else {
                            alert('Error deleting exercise: ' + (response.error || 'Unknown error'));
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('Error deleting exercise: ' + error);
                    }
                });
            }
        }

        function toggleWeightHistory(exerciseId) {
            const dropdown = $(`#history-${exerciseId}`);
            const toggleIcon = $(`#toggle-${exerciseId}`);
            
            if (dropdown.is(':visible')) {
                dropdown.slideUp(200);
                toggleIcon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
            } else {
                dropdown.slideDown(200);
                toggleIcon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
            }
        }

        function deleteWeightEntry(exerciseId, date, weight, reps) {
            if (confirm(`Are you sure you want to delete this weight entry: ${weight} kg × ${reps} reps on ${formatDate(date)}?`)) {
                $.ajax({
                    url: '/delete_weight_entry',
                    method: 'POST',
                    data: {
                        exercise_id: exerciseId,
                        date: date,
                        weight: weight,
                        reps: reps
                    },
                    success: function(response) {
                        if (response.success) {
                            loadMuscleGroups();
                            loadExercisesManagement();
                            alert('Weight entry deleted successfully!');
                        } else {
                            alert('Error deleting weight entry: ' + (response.error || 'Unknown error'));
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('Error deleting weight entry: ' + error);
                    }
                });
            }
        }

        // Analytics Functions
        let progressChart = null;

        function loadAnalyticsData() {
            $.ajax({
                url: '/get_user_exercises',
                method: 'GET',
                success: function(response) {
                    if (response.success && response.exercises) {
                        populateExerciseSelect(response.exercises);
                        updateProgressChart();
                    }
                }
            });
        }

        function populateExerciseSelect(exercises) {
            const select = $('#exercise-select');
            select.empty();
            select.append('<option value="">Select Exercise</option>');
            
            exercises.forEach(exercise => {
                select.append(`<option value="${exercise.id}">${exercise.name} (${exercise.muscle_group})</option>`);
            });
        }

        function updateProgressChart() {
            const exerciseId = $('#exercise-select').val();
            const timeRange = $('#time-range').val();
            
            if (!exerciseId) {
                if (progressChart) {
                    progressChart.destroy();
                    progressChart = null;
                }
                return;
            }

            $.ajax({
                url: '/get_exercise_progress',
                method: 'GET',
                data: {
                    exercise_id: exerciseId,
                    time_range: timeRange
                },
                success: function(response) {
                    if (response.success) {
                        renderProgressChart(response.data);
                    }
                },
                error: function() {
                    console.log('Error loading progress data');
                }
            });
        }

        function renderProgressChart(data) {
            const ctx = document.getElementById('progressChart').getContext('2d');
            
            if (progressChart) {
                progressChart.destroy();
            }

            progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Max Weight (kg)',
                        data: data.maxWeights,
                        borderColor: '#4db6ac',
                        backgroundColor: 'rgba(77, 182, 172, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#4db6ac',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#4db6ac',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                font: {
                                    size: 11
                                }
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                font: {
                                    size: 11
                                }
                            },
                            title: {
                                display: true,
                                text: 'Weight (kg)',
                                color: 'rgba(255, 255, 255, 0.8)',
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // Close modals when clicking outside
        $(window).click(function(e) {
            if (e.target.classList.contains('modal')) {
                $('.modal').hide();
            }
        });
    </script>
</body>
</html>