<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Tracking</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=1.3">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="workout-container">
        <!-- Header -->
        <div class="workout-header">
            <div class="header-content">
                <button class="back-btn" onclick="window.history.back()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <h1>Workout Tracking</h1>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" data-tab="weight-tracking">
                <i class="fas fa-dumbbell"></i>
                Weight Tracking
            </button>
            <button class="tab-btn" data-tab="workouts">
                <i class="fas fa-calendar-alt"></i>
                Workouts
            </button>
        </div>

        <!-- Weight Tracking Tab -->
        <div id="weight-tracking" class="tab-content active">
            <div class="weight-tracking-container">
                <!-- Add Exercise Section -->
                <div class="add-exercise-section">
                    <h3>Add New Exercise</h3>
                    <form id="add-exercise-form" class="exercise-form">
                        <div class="form-row">
                            <input type="text" id="exercise-name" placeholder="Exercise name" required>
                            <select id="muscle-group" required>
                                <option value="">Select muscle group</option>
                                <option value="Chest">Chest</option>
                                <option value="Back">Back</option>
                                <option value="Shoulders">Shoulders</option>
                                <option value="Biceps">Biceps</option>
                                <option value="Triceps">Triceps</option>
                                <option value="Legs">Legs</option>
                                <option value="Core">Core</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-plus"></i> Add Exercise
                        </button>
                    </form>
                </div>

                <!-- Exercise List -->
                <div class="exercises-section">
                    <h3>Your Exercises</h3>
                    <div id="muscle-groups-view" class="muscle-groups-view">
                        <!-- Muscle groups will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Workouts Tab -->
        <div id="workouts" class="tab-content">
            <div class="workouts-container">
                <!-- Create New Workout -->
                <div class="create-workout-section">
                    <h3>Create New Workout</h3>
                    <form id="create-workout-form" class="workout-form">
                        <div class="form-row">
                            <input type="text" id="workout-name" placeholder="Workout name (e.g., Push Day)" required>
                            <select id="workout-day" required>
                                <option value="">Select day</option>
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                                <option value="Saturday">Saturday</option>
                                <option value="Sunday">Sunday</option>
                            </select>
                        </div>
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-plus"></i> Create Workout
                        </button>
                    </form>
                </div>

                <!-- Workouts List -->
                <div class="workouts-list-section">
                    <h3>Your Workouts</h3>
                    <div id="workouts-list" class="workouts-list">
                        <!-- Workouts will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Exercise Detail Modal -->
    <div id="exercise-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-exercise-name">Exercise Details</h3>
                <button class="close-btn" onclick="closeExerciseModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="exercise-stats">
                    <div class="stat-card">
                        <h4>1 Rep Max</h4>
                        <div class="stat-value" id="one-rep-max">-</div>
                        <div class="stat-formula">Estimated from your sets</div>
                    </div>
                    <div class="stat-card">
                        <h4>Weight Calculator</h4>
                        <div class="calculator">
                            <input type="number" id="percentage" placeholder="%" min="50" max="100" step="5">
                            <button onclick="calculateWeight()" class="calc-btn">Calculate</button>
                            <div class="calc-result" id="calc-result">-</div>
                        </div>
                    </div>
                </div>
                <div class="sets-history">
                    <h4>Weight History</h4>
                    <div id="sets-history" class="sets-list">
                        <!-- Sets will be loaded here -->
                    </div>
                </div>
                <div class="add-set-section">
                    <h4>Add New Set</h4>
                    <form id="add-set-form" class="set-form">
                        <div class="form-row">
                            <input type="number" id="set-weight" placeholder="Weight (lbs)" required>
                            <input type="number" id="set-reps" placeholder="Reps" required>
                        </div>
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-plus"></i> Add Set
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Workout Detail Modal -->
    <div id="workout-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-workout-name">Workout Details</h3>
                <button class="close-btn" onclick="closeWorkoutModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="workout-exercises">
                    <h4>Exercises</h4>
                    <div id="workout-exercises-list" class="exercises-list">
                        <!-- Workout exercises will be loaded here -->
                    </div>
                </div>
                <div class="add-exercise-to-workout">
                    <h4>Add Exercise to Workout</h4>
                    <form id="add-exercise-to-workout-form" class="exercise-form">
                        <div class="form-row">
                            <select id="workout-exercise-select" required>
                                <option value="">Select exercise</option>
                            </select>
                            <input type="number" id="workout-sets" placeholder="Sets" min="1" max="10" required>
                            <input type="number" id="workout-reps" placeholder="Reps" min="1" max="50" required>
                        </div>
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-plus"></i> Add to Workout
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}?v=1.3"></script>
    <script>
        $(document).ready(function() {
            // Load initial data
            loadMuscleGroups();
            loadWorkouts();
            loadExercisesForWorkout();

            // Tab switching
            $('.tab-btn').click(function() {
                $('.tab-btn').removeClass('active');
                $(this).addClass('active');
                
                const tabId = $(this).data('tab');
                $('.tab-content').removeClass('active');
                $('#' + tabId).addClass('active');
            });

            // Add exercise form
            $('#add-exercise-form').submit(function(e) {
                e.preventDefault();
                addExercise();
            });

            // Create workout form
            $('#create-workout-form').submit(function(e) {
                e.preventDefault();
                createWorkout();
            });

            // Add set form
            $('#add-set-form').submit(function(e) {
                e.preventDefault();
                addSetToExercise();
            });

            // Add exercise to workout form
            $('#add-exercise-to-workout-form').submit(function(e) {
                e.preventDefault();
                addExerciseToWorkout();
            });
        });

        // Weight Tracking Functions
        function loadMuscleGroups() {
            console.log('Loading muscle groups...');
            $.ajax({
                url: '/get_workout_exercises',
                method: 'GET',
                success: function(response) {
                    console.log('Load muscle groups response:', response);
                    if (response.success) {
                        displayMuscleGroups(response.exercises);
                    } else {
                        console.log('Failed to load muscle groups:', response.error);
                        $('#muscle-groups-view').html('<p>No exercises found. Add your first exercise above!</p>');
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Load muscle groups error:', { xhr, status, error });
                    $('#muscle-groups-view').html('<p>Error loading exercises. Please try again.</p>');
                }
            });
        }

        function displayMuscleGroups(exercises) {
            const muscleGroups = {};
            
            exercises.forEach(exercise => {
                if (!muscleGroups[exercise.muscle_group]) {
                    muscleGroups[exercise.muscle_group] = [];
                }
                muscleGroups[exercise.muscle_group].push(exercise);
            });

            const html = Object.keys(muscleGroups).map(group => {
                const exercisesInGroup = muscleGroups[group];
                const maxWeight = Math.max(...exercisesInGroup.map(ex => 
                    ex.sets_data.length > 0 ? Math.max(...ex.sets_data.map(set => set.weight)) : 0
                ));
                
                return `
                    <div class="muscle-group-card" onclick="showExercises('${group}')">
                        <div class="muscle-group-header">
                            <h3>${group}</h3>
                            <span class="exercise-count">${exercisesInGroup.length} exercises</span>
                        </div>
                        <div class="muscle-group-stats">
                            <div class="stat">
                                <span class="stat-label">Max Weight</span>
                                <span class="stat-value">${maxWeight > 0 ? maxWeight + ' lbs' : 'No data'}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            $('#muscle-groups-view').html(html);
        }

        function showExercises(muscleGroup) {
            $.ajax({
                url: '/get_workout_exercises',
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        const exercises = response.exercises.filter(ex => ex.muscle_group === muscleGroup);
                        displayExercisesForGroup(exercises, muscleGroup);
                    }
                }
            });
        }

        function displayExercisesForGroup(exercises, muscleGroup) {
            const html = `
                <div class="view-header">
                    <button class="back-btn" onclick="showMuscleGroups()">
                        <i class="fas fa-arrow-left"></i> Back to Muscle Groups
                    </button>
                    <h3>${muscleGroup} Exercises</h3>
                </div>
                <div class="exercises-list">
                    ${exercises.map(exercise => {
                        const maxWeight = exercise.sets_data.length > 0 ? 
                            Math.max(...exercise.sets_data.map(set => set.weight)) : 0;
                        const maxWeightSet = exercise.sets_data.find(set => set.weight === maxWeight);
                        
                        return `
                            <div class="exercise-item" onclick="openExerciseModal(${exercise.id}, '${exercise.name}')">
                                <div class="exercise-header">
                                    <h4 class="exercise-name">${exercise.name}</h4>
                                </div>
                                <div class="exercise-stats">
                                    <div class="stat">
                                        <span class="stat-label">Max Weight</span>
                                        <span class="stat-value">${maxWeight > 0 ? maxWeight + ' lbs' : 'No data'}</span>
                                    </div>
                                    <div class="stat">
                                        <span class="stat-label">Best Set</span>
                                        <span class="stat-value">${maxWeightSet ? maxWeightSet.reps + ' reps' : 'No data'}</span>
                                    </div>
                                    <div class="stat">
                                        <span class="stat-label">Total Sets</span>
                                        <span class="stat-value">${exercise.sets_data.length}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            $('#muscle-groups-view').html(html);
        }

        function showMuscleGroups() {
            loadMuscleGroups();
        }

        function addExercise() {
            const name = $('#exercise-name').val();
            const muscleGroup = $('#muscle-group').val();
            
            console.log('Adding exercise:', { name, muscleGroup });
            
            if (!name || !muscleGroup) {
                alert('Please fill in all fields');
                return;
            }
            
            $.ajax({
                url: '/add_exercise',
                method: 'POST',
                data: {
                    name: name,
                    muscle_group: muscleGroup
                },
                success: function(response) {
                    console.log('Add exercise response:', response);
                    if (response.success) {
                        $('#exercise-name').val('');
                        $('#muscle-group').val('');
                        loadMuscleGroups();
                        loadExercisesForWorkout();
                        alert('Exercise added successfully!');
                    } else {
                        alert('Error adding exercise: ' + (response.error || 'Unknown error'));
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Add exercise error:', { xhr, status, error });
                    alert('Error adding exercise: ' + error);
                }
            });
        }

        // Exercise Modal Functions
        let currentExerciseId = null;

        function openExerciseModal(exerciseId, exerciseName) {
            currentExerciseId = exerciseId;
            $('#modal-exercise-name').text(exerciseName);
            loadExerciseDetails(exerciseId);
            $('#exercise-modal').show();
        }

        function closeExerciseModal() {
            $('#exercise-modal').hide();
            currentExerciseId = null;
        }

        function loadExerciseDetails(exerciseId) {
            $.ajax({
                url: '/get_workout_exercises',
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        const exercise = response.exercises.find(ex => ex.id === exerciseId);
                        if (exercise) {
                            displayExerciseDetails(exercise);
                        }
                    }
                }
            });
        }

        function displayExerciseDetails(exercise) {
            // Calculate 1RM using Epley formula
            let oneRepMax = 0;
            if (exercise.sets_data.length > 0) {
                const maxWeightSet = exercise.sets_data.reduce((max, set) => 
                    set.weight > max.weight ? set : max
                );
                oneRepMax = Math.round(maxWeightSet.weight * (1 + maxWeightSet.reps / 30));
            }
            
            $('#one-rep-max').text(oneRepMax > 0 ? oneRepMax + ' lbs' : 'No data');
            
            // Display sets history
            const setsHtml = exercise.sets_data.length > 0 ? 
                exercise.sets_data.map(set => `
                    <div class="set-item">
                        <div class="set-info">
                            <span class="set-weight">${set.weight} lbs</span>
                            <span class="set-reps">${set.reps} reps</span>
                        </div>
                        <div class="set-actions">
                            <button onclick="editSet(${set.id})" class="action-btn">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteSet(${set.id})" class="action-btn">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('') : '<p>No sets recorded yet</p>';
            
            $('#sets-history').html(setsHtml);
        }

        function calculateWeight() {
            const percentage = $('#percentage').val();
            const oneRepMaxText = $('#one-rep-max').text();
            const oneRepMax = parseInt(oneRepMaxText);
            
            if (oneRepMax > 0 && percentage > 0) {
                const calculatedWeight = Math.round(oneRepMax * (percentage / 100));
                $('#calc-result').text(calculatedWeight + ' lbs');
            } else {
                $('#calc-result').text('Invalid input');
            }
        }

        function addSetToExercise() {
            if (!currentExerciseId) return;
            
            const weight = $('#set-weight').val();
            const reps = $('#set-reps').val();
            
            $.ajax({
                url: '/add_set',
                method: 'POST',
                data: {
                    exercise_id: currentExerciseId,
                    weight: weight,
                    reps: reps
                },
                success: function(response) {
                    if (response.success) {
                        $('#set-weight').val('');
                        $('#set-reps').val('');
                        loadExerciseDetails(currentExerciseId);
                        loadMuscleGroups();
                    }
                }
            });
        }

        // Workouts Functions
        function loadWorkouts() {
            $.ajax({
                url: '/get_workouts',
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        displayWorkouts(response.workouts);
                    }
                }
            });
        }

        function displayWorkouts(workouts) {
            const html = workouts.length > 0 ? 
                workouts.map(workout => `
                    <div class="workout-item" onclick="openWorkoutModal(${workout.id}, '${workout.name}')">
                        <div class="workout-header">
                            <h4 class="workout-name">${workout.name}</h4>
                            <span class="workout-day">${workout.day}</span>
                        </div>
                        <div class="workout-stats">
                            <div class="stat">
                                <span class="stat-label">Exercises</span>
                                <span class="stat-value">${workout.exercises ? workout.exercises.length : 0}</span>
                            </div>
                        </div>
                    </div>
                `).join('') : '<p>No workouts created yet</p>';
            
            $('#workouts-list').html(html);
        }

        function createWorkout() {
            const name = $('#workout-name').val();
            const day = $('#workout-day').val();
            
            $.ajax({
                url: '/create_workout',
                method: 'POST',
                data: {
                    name: name,
                    day: day
                },
                success: function(response) {
                    if (response.success) {
                        $('#workout-name').val('');
                        $('#workout-day').val('');
                        loadWorkouts();
                    }
                }
            });
        }

        function loadExercisesForWorkout() {
            $.ajax({
                url: '/get_workout_exercises',
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        const options = response.exercises.map(exercise => 
                            `<option value="${exercise.id}">${exercise.name} (${exercise.muscle_group})</option>`
                        ).join('');
                        $('#workout-exercise-select').html('<option value="">Select exercise</option>' + options);
                    }
                }
            });
        }

        // Workout Modal Functions
        let currentWorkoutId = null;

        function openWorkoutModal(workoutId, workoutName) {
            currentWorkoutId = workoutId;
            $('#modal-workout-name').text(workoutName);
            loadWorkoutDetails(workoutId);
            $('#workout-modal').show();
        }

        function closeWorkoutModal() {
            $('#workout-modal').hide();
            currentWorkoutId = null;
        }

        function loadWorkoutDetails(workoutId) {
            $.ajax({
                url: '/get_workout_details',
                method: 'GET',
                data: { workout_id: workoutId },
                success: function(response) {
                    if (response.success) {
                        displayWorkoutDetails(response.workout);
                    }
                }
            });
        }

        function displayWorkoutDetails(workout) {
            const exercisesHtml = workout.exercises && workout.exercises.length > 0 ? 
                workout.exercises.map(exercise => `
                    <div class="workout-exercise-item">
                        <div class="exercise-info">
                            <span class="exercise-name">${exercise.exercise_name}</span>
                            <span class="exercise-sets">${exercise.sets} sets × ${exercise.reps} reps</span>
                        </div>
                        <div class="exercise-actions">
                            <button onclick="removeExerciseFromWorkout(${exercise.id})" class="action-btn">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('') : '<p>No exercises added yet</p>';
            
            $('#workout-exercises-list').html(exercisesHtml);
        }

        function addExerciseToWorkout() {
            if (!currentWorkoutId) return;
            
            const exerciseId = $('#workout-exercise-select').val();
            const sets = $('#workout-sets').val();
            const reps = $('#workout-reps').val();
            
            $.ajax({
                url: '/add_exercise_to_workout',
                method: 'POST',
                data: {
                    workout_id: currentWorkoutId,
                    exercise_id: exerciseId,
                    sets: sets,
                    reps: reps
                },
                success: function(response) {
                    if (response.success) {
                        $('#workout-exercise-select').val('');
                        $('#workout-sets').val('');
                        $('#workout-reps').val('');
                        loadWorkoutDetails(currentWorkoutId);
                        loadWorkouts();
                    }
                }
            });
        }

        function removeExerciseFromWorkout(workoutExerciseId) {
            if (confirm('Are you sure you want to remove this exercise from the workout?')) {
                $.ajax({
                    url: '/remove_exercise_from_workout',
                    method: 'POST',
                    data: {
                        workout_exercise_id: workoutExerciseId
                    },
                    success: function(response) {
                        if (response.success) {
                            loadWorkoutDetails(currentWorkoutId);
                            loadWorkouts();
                        }
                    }
                });
            }
        }

        // Close modals when clicking outside
        $(window).click(function(e) {
            if (e.target.classList.contains('modal')) {
                $('.modal').hide();
            }
        });
    </script>
</body>
</html>