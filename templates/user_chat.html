<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>C.Point - Messages</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
	<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=2.0">
	<style>
		/* Messages Page with Dashboard Layout */
		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			background: #000000;
			color: #ffffff;
			margin: 0;
			padding: 0;
		}
		
		.messages-page { margin-left: 200px; }
		.messages-page .sidebar { position: fixed !important; top: 0 !important; left: 0 !important; width: 200px !important; height: 100vh !important; background: #1a1a1a !important; border-right: 1px solid #333333 !important; z-index: 1000 !important; display: flex !important; flex-direction: column !important; }
		.messages-page .sidebar-header { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #333333; height: 60px; box-sizing: border-box; }
		.messages-page .sidebar-logo { padding: 5px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
		.messages-page .community-name { flex: 1; display: flex; align-items: center; color: #ffffff; font-size: 16px; font-weight: 600; padding-left: 10px; overflow: hidden; }
		.messages-page .community-name span { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
		.messages-page .sidebar-menu { flex: 1; padding: 10px 0; display: block !important; overflow-y: auto !important; }
		.messages-page .sidebar-menu a { display: block !important; padding: 12px 20px !important; color: #ffffff !important; text-decoration: none !important; transition: all 0.3s ease !important; border: none !important; font-size: 14px !important; }
		.messages-page .sidebar-menu a:hover { background: rgba(77, 182, 172, 0.2) !important; color: #4db6ac !important; padding-left: 25px !important; }
		.messages-page .menu-btn, .messages-page .dropdown-content { display: none !important; }
		.messages-page .container { 
			padding: 80px 20px 20px 20px; 
			min-height: 100vh;
			box-sizing: border-box;
		}
		
		/* Messages Header Bar */
		.messages-header-bar { 
			position: fixed; 
			top: 0; 
			left: 200px; 
			right: 0; 
			height: 60px; 
			background: transparent; 
			border-bottom: 1px solid #333333; 
			z-index: 900;
			box-sizing: border-box;
		}
		
		/* Main Content Area */
		.messages-main-content {
			display: flex;
			gap: 20px;
			height: calc(100vh - 100px);
			min-height: calc(100vh - 100px);
			padding: 0;
		}
		
		/* Communities List Panel */
		.communities-list-panel {
			width: 280px;
			min-height: 100%;
			height: calc(100vh - 100px);
			background: rgba(255, 255, 255, 0.02);
			border: 1px solid rgba(255, 255, 255, 0.08);
			border-radius: 6px;
			overflow: hidden;
			display: flex;
			flex-direction: column;
		}
		
		.communities-header {
			padding: 12px 15px;
			background: rgba(0, 0, 0, 0.3);
			border-bottom: 1px solid rgba(255, 255, 255, 0.1);
			flex-shrink: 0;
			height: 48px;
			box-sizing: border-box;
		}
		
		.communities-header h3 {
			margin: 0;
			color: #ffffff;
			font-size: 15px;
			font-weight: 600;
		}
		
		.communities-list {
			flex: 1;
			height: 100%;
			min-height: 100%;
			overflow-y: auto;
			padding: 8px;
		}
		
		.community-section {
			margin-bottom: 6px;
		}
		
		.community-header-btn {
			width: 100%;
			padding: 8px 12px;
			background: rgba(77, 182, 172, 0.1);
			border: 1px solid rgba(255, 255, 255, 0.1);
			border-radius: 4px;
			color: #ffffff;
			font-size: 13px;
			font-weight: 500;
			text-align: left;
			cursor: pointer;
			transition: all 0.2s ease;
			display: flex;
			align-items: center;
			justify-content: space-between;
		}
		
		.community-header-btn:hover {
			background: rgba(77, 182, 172, 0.2);
		}
		
		.community-header-btn.active {
			background: rgba(77, 182, 172, 0.25);
			border-radius: 6px 6px 0 0;
			border-bottom: none;
		}
		
		.community-name {
			display: flex;
			align-items: center;
			gap: 6px;
		}
		
		.community-arrow {
			transition: transform 0.2s ease;
			color: rgba(255, 255, 255, 0.6);
			font-size: 12px;
		}
		
		.community-header-btn.active .community-arrow {
			transform: rotate(90deg);
		}
		
		.community-users {
			display: none;
			padding: 4px;
			background: rgba(0, 0, 0, 0.2);
			border: 1px solid rgba(255, 255, 255, 0.1);
			border-top: none;
			border-radius: 0 0 4px 4px;
		}
		
		.community-users.show {
			display: block;
		}
		
		.user-item {
			display: flex;
			align-items: center;
			padding: 6px 8px;
			margin: 2px 4px;
			background: rgba(255, 255, 255, 0.03);
			border-radius: 3px;
			cursor: pointer;
			transition: all 0.2s ease;
			position: relative;
		}
		
		.user-item:hover {
			background: rgba(77, 182, 172, 0.15);
			transform: translateX(2px);
		}
		
		.user-item.active {
			background: rgba(77, 182, 172, 0.25);
			border-left: 2px solid #4db6ac;
			padding-left: 6px;
		}
		
		.user-avatar {
			width: 32px;
			height: 32px;
			border-radius: 50%;
			background: rgba(255, 255, 255, 0.1);
			display: flex;
			align-items: center;
			justify-content: center;
			margin-right: 10px;
			font-size: 14px;
			color: #4db6ac;
			flex-shrink: 0;
		}
		
		.user-info {
			flex: 1;
			min-width: 0;
		}
		
		.user-name {
			color: #ffffff;
			font-size: 14px;
			font-weight: 500;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}
		
		.user-status {
			color: rgba(255, 255, 255, 0.6);
			font-size: 12px;
		}
		
		.unread-indicator {
			position: absolute;
			right: 10px;
			top: 50%;
			transform: translateY(-50%);
			background: #4db6ac;
			color: #ffffff;
			padding: 2px 6px;
			border-radius: 10px;
			font-size: 11px;
			font-weight: 600;
		}
		
		/* Chat Panel */
		.chat-panel {
			flex: 1;
			height: 100%;
			background: rgba(255, 255, 255, 0.03);
			border: 1px solid rgba(255, 255, 255, 0.1);
			border-radius: 8px;
			overflow: hidden;
			display: flex;
			flex-direction: column;
		}
		
		#chatContent {
			flex: 1;
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
		}
		
		#chatContent:has(.chat-header) {
			justify-content: flex-start;
			align-items: stretch;
		}
		
		.chat-header {
			padding: 12px 15px;
			background: rgba(0, 0, 0, 0.3);
			border-bottom: 1px solid rgba(255, 255, 255, 0.1);
			display: flex;
			align-items: center;
			justify-content: space-between;
			height: 48px;
			box-sizing: border-box;
			flex-shrink: 0;
		}
		
		.chat-user-info {
			display: flex;
			align-items: center;
		}
		
		.chat-user-name {
			color: #ffffff;
			font-size: 16px;
			font-weight: 600;
		}
		
		.messages-area {
			flex: 1;
			overflow-y: auto;
			padding: 20px;
			display: flex;
			flex-direction: column;
			min-height: 0;
		}
		
		.message {
			margin-bottom: 15px;
			display: flex;
			align-items: flex-start;
		}
		
		.message.sent {
			justify-content: flex-end;
		}
		
		.message-content {
			max-width: 70%;
			padding: 10px 14px;
			border-radius: 8px;
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid rgba(255, 255, 255, 0.1);
		}
		
		.message.sent .message-content {
			background: rgba(77, 182, 172, 0.2);
			border-color: rgba(77, 182, 172, 0.3);
		}
		
		.message-text {
			color: #ffffff;
			font-size: 14px;
			line-height: 1.4;
		}
		
		.message-time {
			color: rgba(255, 255, 255, 0.5);
			font-size: 11px;
			margin-top: 4px;
		}
		
		.message-input-area {
			padding: 8px 10px;
			background: rgba(0, 0, 0, 0.3);
			border-top: 1px solid rgba(255, 255, 255, 0.1);
		}
		
		.message-input-form {
			display: flex;
			gap: 6px;
			align-items: flex-end;
		}
		
		.message-input {
			flex: 1;
			padding: 6px 10px;
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid rgba(255, 255, 255, 0.1);
			border-radius: 4px;
			color: #ffffff;
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			font-size: 13px;
			line-height: 1.4;
			min-height: 32px;
			max-height: 100px;
			resize: none;
			overflow-y: auto;
		}
		
		.message-input:focus {
			outline: none;
			border-color: #4db6ac;
			background: rgba(255, 255, 255, 0.08);
		}
		
		.send-btn {
			padding: 6px 14px;
			background: #4db6ac;
			color: #ffffff;
			border: none;
			border-radius: 4px;
			font-size: 13px;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.2s ease;
			display: inline-flex;
			align-items: center;
			justify-content: center;
			gap: 4px;
			white-space: nowrap;
			min-height: 32px;
			min-width: 70px;
			align-self: flex-end;
		}
		
		.send-btn:hover {
			background: #37a69c;
			transform: translateY(-1px);
		}
		
		.send-btn i {
			font-size: 14px;
		}
		
		/* Empty State */
		.empty-state {
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			height: 100%;
			color: rgba(255, 255, 255, 0.5);
			text-align: center;
			padding: 20px;
		}
		
		.empty-state i {
			font-size: 48px;
			margin-bottom: 15px;
			color: rgba(77, 182, 172, 0.5);
		}
		
		.empty-state p {
			font-size: 16px;
			margin: 0;
		}
		
		@media (max-width: 900px) {
			.messages-page { margin-left: 0 !important; padding-top: 60px !important; }
			.messages-page .sidebar { width: 100% !important; height: 60px !important; overflow: visible !important; }
			.messages-page .sidebar-header { padding: 8px !important; height: 60px !important; }
			.messages-page .community-name { font-size: 14px !important; }
			.messages-page .sidebar-menu { display: none !important; position: absolute !important; top: 60px !important; left: 0 !important; right: 0 !important; background: #1a1a1a !important; border-top: 1px solid #333333 !important; max-height: calc(100vh - 60px) !important; overflow-y: auto !important; }
			.messages-page .sidebar:hover .sidebar-menu, .messages-page .sidebar:focus-within .sidebar-menu { display: block !important; }
			.messages-header-bar { left: 0 !important; }
			
			.messages-main-content {
				flex-direction: column;
				height: auto;
			}
			
			.communities-list-panel {
				width: 100%;
				max-width: 500px;
				margin: 0 auto;
				max-height: 300px;
			}
			
			.chat-panel {
				min-height: 500px;
			}
		}
	</style>
</head>
<body class="messages-page">
	<div class="sidebar">
		<div class="sidebar-header">
			<div class="sidebar-logo" id="sidebarLogo"></div>
			<div class="community-name">
				<span>Messages</span>
			</div>
		</div>
		<div class="sidebar-menu">
			{% if session['username'] == 'admin' %}
			<a href="{{ url_for('admin_profile') }}">Admin Profile</a>
			<a href="{{ url_for('admin') }}">Admin Dashboard</a>
			{% endif %}
			<a href="{{ url_for('dashboard') }}">Dashboard</a>
			<a href="{{ url_for('profile') }}">Profile</a>
			<a href="{{ url_for('user_chat') }}">Messages</a>
			<a href="{{ url_for('communities') }}">Your Communities</a>
			<a href="{{ url_for('your_sports') }}">Your Sports</a>
			<a href="{{ url_for('logout') }}">Logout</a>
		</div>
	</div>
	
	<div class="messages-header-bar"></div>
	
	<div class="container">
		<div class="messages-main-content">
			<!-- Communities List Panel -->
			<div class="communities-list-panel">
				<div class="communities-header">
					<h3><i class="fas fa-layer-group"></i> Your Communities</h3>
				</div>
				<div class="communities-list" id="communitiesList">
					<!-- Communities and users will be loaded here -->
					<div class="empty-state" id="loadingState">
						<i class="fas fa-spinner fa-spin"></i>
						<p>Loading communities...</p>
					</div>
				</div>
			</div>
			
			<!-- Chat Panel -->
			<div class="chat-panel">
				<div id="chatContent">
					<div class="empty-state">
						<i class="fas fa-comments"></i>
						<p>Select a user to start messaging</p>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="{{ url_for('static', filename='script.js') }}"></script>
	<script>
		let currentChatUser = null;
		let currentChatUsername = null;
		let communitiesData = {};
		
		$(document).ready(function() {
			loadUserCommunities();
		});
		
		function loadUserCommunities() {
			$.ajax({
				url: '/get_user_communities_with_members',
				method: 'GET',
				success: function(response) {
					if (response.success && response.communities) {
						displayCommunities(response.communities);
					} else {
						$('#loadingState').html(`
							<i class="fas fa-exclamation-circle"></i>
							<p>No communities found</p>
							<p style="font-size: 12px; margin-top: 10px;">Join a community to start messaging</p>
						`);
					}
				},
				error: function() {
					$('#loadingState').html(`
						<i class="fas fa-exclamation-triangle"></i>
						<p>Error loading communities</p>
					`);
				}
			});
		}
		
		function displayCommunities(communities) {
			const container = $('#communitiesList');
			container.empty();
			
			if (!communities || communities.length === 0) {
				container.html(`
					<div class="empty-state">
						<i class="fas fa-users-slash"></i>
						<p>No communities joined</p>
						<p style="font-size: 12px; margin-top: 10px;">Join a community to connect with members</p>
					</div>
				`);
				return;
			}
			
			communities.forEach(community => {
				const communityHtml = `
					<div class="community-section" data-community-id="${community.id}">
						<button class="community-header-btn" onclick="toggleCommunity(${community.id})">
							<div class="community-name">
								<i class="fas fa-users"></i>
								<span>${community.name}</span>
								<span style="color: rgba(255,255,255,0.5); font-size: 12px;">(${community.members ? community.members.length : 0})</span>
							</div>
							<i class="fas fa-chevron-right community-arrow"></i>
						</button>
						<div class="community-users" id="community-users-${community.id}">
							${community.members && community.members.length > 0 ? 
								community.members.map(member => `
									<div class="user-item" data-user-id="${member.id}" data-username="${member.username}" onclick="selectUser(${member.id}, '${member.username}')">
										<div class="user-avatar">
											<i class="fas fa-user"></i>
										</div>
										<div class="user-info">
											<div class="user-name">${member.username}</div>
											<div class="user-status">${member.online ? 'Online' : 'Offline'}</div>
										</div>
									</div>
								`).join('') : 
								'<div style="padding: 10px; color: rgba(255,255,255,0.5); text-align: center; font-size: 12px;">No members yet</div>'
							}
						</div>
					</div>
				`;
				container.append(communityHtml);
				communitiesData[community.id] = community;
			});
		}
		
		function toggleCommunity(communityId) {
			const btn = $(`.community-section[data-community-id="${communityId}"] .community-header-btn`);
			const users = $(`#community-users-${communityId}`);
			
			btn.toggleClass('active');
			users.toggleClass('show');
		}
		
		function selectUser(userId, userName) {
			currentChatUser = userId;
			currentChatUsername = userName;
			
			// Update active state
			$('.user-item').removeClass('active');
			$(`.user-item[data-user-id="${userId}"]`).addClass('active');
			
			// Load chat interface
			const chatHtml = `
				<div class="chat-header">
					<div class="chat-user-info">
						<div class="user-avatar" style="margin-right: 12px;">
							<i class="fas fa-user"></i>
						</div>
						<div class="chat-user-name">${userName}</div>
					</div>
				</div>
				<div class="messages-area" id="messagesArea">
					<div class="empty-state">
						<i class="fas fa-spinner fa-spin"></i>
						<p>Loading messages...</p>
					</div>
				</div>
				<div class="message-input-area">
					<form class="message-input-form" onsubmit="sendMessage(event)">
						<textarea class="message-input" id="messageInput" placeholder="Type a message..." rows="1" required></textarea>
						<button type="submit" class="send-btn">
							<span>Send</span>
							<i class="fas fa-paper-plane"></i>
						</button>
					</form>
				</div>
			`;
			
			$('#chatContent').html(chatHtml);
			loadMessages(userId, userName);
		}
		
		function loadMessages(userId, userName) {
			$.ajax({
				url: '/get_messages',
				method: 'POST',
				data: {
					other_user_id: userId,
					csrf_token: 'disabled'
				},
				success: function(response) {
					const messagesArea = $('#messagesArea');
					messagesArea.empty();
					
					if (response.success && response.messages && response.messages.length > 0) {
						response.messages.forEach(msg => {
							const messageHtml = `
								<div class="message ${msg.sent ? 'sent' : 'received'}">
									<div class="message-content">
										<div class="message-text">${msg.text}</div>
										<div class="message-time">${msg.time || 'Just now'}</div>
									</div>
								</div>
							`;
							messagesArea.append(messageHtml);
						});
					} else {
						messagesArea.html(`
							<div class="empty-state">
								<i class="fas fa-comments"></i>
								<p>No messages yet</p>
								<p style="font-size: 12px; margin-top: 10px;">Start the conversation with ${userName}</p>
							</div>
						`);
					}
					
					// Scroll to bottom
					messagesArea.scrollTop(messagesArea[0].scrollHeight);
				},
				error: function() {
					$('#messagesArea').html(`
						<div class="empty-state">
							<i class="fas fa-exclamation-triangle"></i>
							<p>Error loading messages</p>
						</div>
					`);
				}
			});
		}
		
		function sendMessage(event) {
			event.preventDefault();
			const input = $('#messageInput');
			const message = input.val().trim();
			
			if (message && currentChatUser) {
				// Add message to UI immediately (optimistic update)
				const tempMessageHtml = `
					<div class="message sent temp-message">
						<div class="message-content">
							<div class="message-text">${message}</div>
							<div class="message-time">Sending...</div>
						</div>
					</div>
				`;
				
				// Remove empty state if it exists
				$('#messagesArea .empty-state').remove();
				
				$('#messagesArea').append(tempMessageHtml);
				$('#messagesArea').scrollTop($('#messagesArea')[0].scrollHeight);
				
				// Clear input
				input.val('');
				
				// Send to server
				$.ajax({
					url: '/send_message',
					method: 'POST',
					data: {
						recipient_id: currentChatUser,
						message: message,
						csrf_token: 'disabled'
					},
					success: function(response) {
						if (response.success) {
							// Update the temporary message
							$('.temp-message').removeClass('temp-message').find('.message-time').text('Just now');
						} else {
							// Remove failed message
							$('.temp-message').remove();
							alert('Failed to send message: ' + (response.error || 'Unknown error'));
						}
					},
					error: function() {
						// Remove failed message
						$('.temp-message').remove();
						alert('Error sending message. Please try again.');
					}
				});
			}
		}
		
		// Auto-refresh messages periodically when a chat is open
		setInterval(function() {
			if (currentChatUser) {
				loadMessages(currentChatUser, currentChatUsername);
			}
		}, 10000); // Refresh every 10 seconds
		
		// Auto-resize textarea function
		function autoResizeTextarea(textarea) {
			textarea.style.height = 'auto';
			const newHeight = Math.min(textarea.scrollHeight, 100);
			textarea.style.height = newHeight + 'px';
		}
		
		// Auto-resize on input
		$(document).on('input', '#messageInput', function() {
			autoResizeTextarea(this);
		});
		
		// Initialize textarea height when chat opens
		$(document).on('focus', '#messageInput', function() {
			autoResizeTextarea(this);
		});
		
		// Handle Enter key for sending (Shift+Enter for new line)
		$(document).on('keydown', '#messageInput', function(e) {
			if (e.key === 'Enter' && !e.shiftKey) {
				e.preventDefault();
				$(this).closest('form').submit();
			}
		});
		
		// Reset textarea height after sending
		$(document).on('submit', '.message-input-form', function() {
			setTimeout(() => {
				const textarea = document.getElementById('messageInput');
				if (textarea) {
					textarea.style.height = '32px';
				}
			}, 100);
		});
	</script>
</body>
</html>