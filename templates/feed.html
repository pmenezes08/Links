<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social</title>
    <!-- <meta name="csrf-token" content="{{ csrf_token }}"> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=2.0">
    <style>
        body {
            background-color: #000000 !important;
        }
        
        .container.feed {
            background-color: #000000 !important;
        }
        
        .composer-card, .post {
            background-color: #1a2526 !important;
            border-color: #4db6ac !important;
        }
        
        .composer-input {
            background-color: rgba(255, 255, 255, 0.05) !important;
            color: #ffffff !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
        }
        
        .composer-input:focus {
            border-color: #4db6ac !important;
            background-color: rgba(255, 255, 255, 0.08) !important;
        }
        
        /* Compact Poll Styles */
        .poll-container-compact {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
            width: 250px;
            float: right;
            margin-left: 16px;
        }
        
        .poll-question-compact {
            font-weight: 600;
            margin-bottom: 8px;
            color: #ffffff;
            font-size: 14px;
        }
        
        .poll-question-compact i {
            color: #4db6ac;
            margin-right: 6px;
        }
        
        .poll-options-compact {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .poll-option-compact {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            padding: 6px 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .poll-option-compact:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: #4db6ac;
        }
        
        .poll-option-text-compact {
            color: #ffffff;
            font-size: 12px;
            flex: 1;
        }
        
        .poll-option-votes-compact {
            color: #4db6ac;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .poll-footer-compact {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .poll-total-compact {
            color: #9fb0b5;
            font-size: 11px;
        }
        
        .poll-voted-compact {
            color: #4db6ac;
            font-size: 11px;
        }
        
        /* Poll Modal Styles */
        #pollModal .modal-content {
            max-width: 500px;
        }
        
        #pollModal .form-group {
            margin-bottom: 16px;
        }
        
        #pollModal label {
            display: block;
            margin-bottom: 6px;
            color: #ffffff;
            font-weight: 500;
        }
        
        #pollModal input,
        #pollModal textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
            font-size: 14px;
        }
        
        #pollModal input:focus,
        #pollModal textarea:focus {
            outline: none;
            border-color: #4db6ac;
            box-shadow: 0 0 0 2px rgba(77, 182, 172, 0.2);
        }
        
        #pollOptions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        

    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <meta name="current-username" content="{{ username }}">
    <script src="{{ url_for('static', filename='script.js') }}?v=2.0"></script>
</head>
<body>
    <!-- Sidebar Menu -->
    <div class="sidebar">
        <button class="menu-btn"><i class="fas fa-bars"></i> Menu</button>
        <div class="dropdown-content">
            {% if session['username'] == 'admin' %}
            <a href="{{ url_for('admin') }}">Admin Dashboard</a>
            <a href="{{ url_for('admin_profile') }}">Admin Profile</a>
            {% endif %}
            <a href="{{ url_for('profile') }}">Profile</a>
            <a href="{{ url_for('user_chat') }}">Messages</a>
            <a href="{{ url_for('premium_dashboard') }}">Main Dashboard</a>
            <a href="{{ url_for('feed') }}">Social</a>
            <a href="{{ url_for('communities') }}">Your Communities</a>
            <a href="{{ url_for('your_sports') }}">Your Sports</a>
            <a href="{{ url_for('logout') }}">Logout</a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container feed">

        <!-- Composer -->
        <div class="composer-card">
            <form action="/post_status" method="POST" class="composer-form" enctype="multipart/form-data">
                <div class="composer-inner">
                    <div class="composer-body">
                        <input type="text" name="content" class="composer-input" placeholder="What is happening?!">
                        <div class="composer-actions">
                            <div class="file-upload-container">
                                <label for="image-upload" class="file-upload-btn">
                                    <i class="fas fa-paperclip"></i>
                                </label>
                                <input type="file" id="image-upload" name="image" accept="image/*" style="display: none;">
                                <span id="selected-file-name" class="selected-file-name"></span>
                            </div>
                            <button type="button" class="sleek-btn small" onclick="showPollModal()">
                                <i class="fas fa-poll-h"></i> Poll
                            </button>
                            <button type="submit" class="sleek-btn small">Post</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Posts Display -->
        <div class="posts timeline">
            {% if posts %}
                {% for post in posts %}
                    <div class="post clickable-post" data-post-id="{{ post.id }}">
                        <div class="post-header"><strong>@{{ post.username }}</strong><span class="timestamp">{{ post.timestamp | format_date('%m/%d/%y %I:%M %p') }}</span></div>
                        <p>{{ post.content }}</p>
                        
                        <!-- Poll Display -->
                        {% if post.poll %}
                        <div class="poll-container-compact">
                            <div class="poll-question-compact">
                                <i class="fas fa-poll-h"></i> {{ post.poll.question }}
                            </div>
                            <div class="poll-options-compact">
                                {% for option in post.poll.options %}
                                <div class="poll-option-compact" data-poll-id="{{ post.poll.id }}" data-option-id="{{ option.id }}">
                                    <div class="poll-option-text-compact">{{ option.option_text }}</div>
                                    <div class="poll-option-votes-compact">{{ option.votes }}</div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="poll-footer-compact">
                                <span class="poll-total-compact">{{ post.poll.total_votes }} votes</span>
                                {% if post.poll.user_vote %}
                                <span class="poll-voted-compact"><i class="fas fa-check"></i></span>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if post.image_path and post.image_path != 'None' and post.image_path != '' %}
                            <div class="post-image">
                                <!-- Debug info -->
                                <script>console.log('Post {{ post.id }} image_path:', '{{ post.image_path }}');</script>
                                <img src="{{ url_for('uploaded_file', filename=post.image_path.replace('uploads/', '')) if post.image_path.startswith('uploads/') else url_for('uploaded_file', filename=post.image_path) }}" 
                                     alt="Post image" 
                                     loading="lazy" 
                                     onerror="console.log('Image failed to load:', this.src); this.style.display='none'; this.parentElement.innerHTML='<div style=\'padding: 20px; text-align: center; color: #9fb0b5;\'>Image could not be loaded</div>';" 
                                     onload="console.log('Image loaded successfully:', this.src);"
                                     style="max-width: 100%; height: auto; display: block;">
                            </div>
                        {% else %}
                            <!-- Debug info for posts without images -->
                            <script>console.log('Post {{ post.id }} has no image_path or invalid value:', '{{ post.image_path }}');</script>
                        {% endif %}
                        <div class="post-actions">
                            <div class="reactions">
                                <button class="reaction-btn heart {{ 'active' if post.user_reaction == 'heart' }}" data-reaction="heart" aria-label="Like post"><i class="far fa-heart"></i> <span>{{ post.reactions['heart'] or 0 }}</span></button>
                                <button class="reaction-btn thumbs-up {{ 'active' if post.user_reaction == 'thumbs-up' }}" data-reaction="thumbs-up" aria-label="Thumbs up"><i class="far fa-thumbs-up"></i> <span>{{ post.reactions['thumbs-up'] or 0 }}</span></button>
                                <button class="reaction-btn thumbs-down {{ 'active' if post.user_reaction == 'thumbs-down' }}" data-reaction="thumbs-down" aria-label="Thumbs down"><i class="far fa-thumbs-down"></i> <span>{{ post.reactions['thumbs-down'] or 0 }}</span></button>
                            </div>
                            {% if post.username == session['username'] %}
                                <button class="delete-post inline-action" data-post-id="{{ post.id }}"><i class="far fa-trash-alt"></i> Delete</button>
                            {% endif %}
                        </div>
                        <!-- Reply count indicator -->
                        <div class="reply-indicator">
                            <i class="far fa-comment"></i> {{ post.replies|length }} replies
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p>No posts yet. Be the first!</p>
            {% endif %}
        </div>
    </div>

    <!-- Poll Creation Modal -->
    <div id="pollModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create Poll</h2>
                <span class="close" onclick="closePollModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="pollForm">
                    <div class="form-group">
                        <label for="pollContent">Post Content (Optional)</label>
                        <textarea id="pollContent" name="content" placeholder="Add some context to your poll..." rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="pollQuestion">Poll Question *</label>
                        <input type="text" id="pollQuestion" name="question" placeholder="What would you like to ask?" required>
                    </div>
                    <div class="form-group">
                        <label>Poll Options *</label>
                        <div id="pollOptions">
                            <input type="text" name="options[]" placeholder="Option 1" required>
                            <input type="text" name="options[]" placeholder="Option 2" required>
                        </div>
                        <button type="button" onclick="addPollOption()" class="btn-secondary">+ Add Option</button>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn">Create Poll</button>
                        <button type="button" class="btn-secondary" onclick="closePollModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Post Modal -->
    <div id="postModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Post Details</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div id="modalPostContent">
                    <!-- Post content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            console.log('Feed page script loaded');
            
            let menuTimeout;
            
            // Show menu on button click
            $('.menu-btn').on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Menu clicked');
                $('.dropdown-content').slideDown(200);
            });
            
            // Keep menu open when hovering over sidebar
            $('.sidebar').on('mouseenter', function() {
                clearTimeout(menuTimeout);
            });
            
            // Keep menu open when hovering over dropdown
            $('.dropdown-content').on('mouseenter', function() {
                clearTimeout(menuTimeout);
            });
            
            // Close menu when leaving sidebar area
            $('.sidebar').on('mouseleave', function() {
                menuTimeout = setTimeout(function() {
                    $('.dropdown-content').slideUp(200);
                }, 300); // 300ms delay before closing
            });
            
            // Close menu when leaving dropdown
            $('.dropdown-content').on('mouseleave', function() {
                menuTimeout = setTimeout(function() {
                    $('.dropdown-content').slideUp(200);
                }, 300); // 300ms delay before closing
            });
            
            // Close menu on escape key
            $(document).on('keydown', function(e) {
                if (e.key === 'Escape') {
                    $('.dropdown-content').slideUp(200);
                }
            });
            
            // Debug info
            console.log('Menu button found:', $('.menu-btn').length);
            console.log('Dropdown found:', $('.dropdown-content').length);
            
            // Poll functionality
            setupPollHandlers();
        });
        
        // Poll Modal Functions
        function showPollModal() {
            document.getElementById('pollModal').style.display = 'block';
        }
        
        function closePollModal() {
            document.getElementById('pollModal').style.display = 'none';
            document.getElementById('pollForm').reset();
            // Reset to 2 options
            const optionsContainer = document.getElementById('pollOptions');
            optionsContainer.innerHTML = `
                <input type="text" name="options[]" placeholder="Option 1" required>
                <input type="text" name="options[]" placeholder="Option 2" required>
            `;
        }
        
        function addPollOption() {
            const optionsContainer = document.getElementById('pollOptions');
            const optionCount = optionsContainer.children.length;
            
            if (optionCount >= 6) {
                alert('Maximum 6 options allowed');
                return;
            }
            
            const newOption = document.createElement('input');
            newOption.type = 'text';
            newOption.name = 'options[]';
            newOption.placeholder = `Option ${optionCount + 1}`;
            newOption.required = true;
            
            optionsContainer.appendChild(newOption);
        }
        
        function setupPollHandlers() {
            // Poll form submission (modal)
            document.getElementById('pollForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                
                fetch('/create_poll', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Poll created successfully!');
                        closePollModal();
                        location.reload(); // Refresh to show new poll
                    } else {
                        alert('Error creating poll: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error creating poll');
                });
            });
            
            // Poll option voting (for compact polls)
            document.addEventListener('click', function(e) {
                if (e.target.closest('.poll-option-compact')) {
                    const pollOption = e.target.closest('.poll-option-compact');
                    const pollId = pollOption.dataset.pollId;
                    const optionId = pollOption.dataset.optionId;
                    
                    voteOnPoll(pollId, optionId, pollOption);
                }
            });
        }
        
        function voteOnPoll(pollId, optionId, pollOptionElement) {
            const formData = new FormData();
            formData.append('poll_id', pollId);
            formData.append('option_id', optionId);
            
            fetch('/vote_poll', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updatePollDisplay(pollOptionElement, data.poll_results);
                } else {
                    alert('Error voting: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error voting on poll');
            });
        }
        
        function updatePollDisplay(pollOptionElement, pollResults) {
            const pollContainer = pollOptionElement.closest('.poll-container-compact');
            const totalVotes = pollResults.reduce((sum, option) => sum + option.votes, 0);
            
            // Update each option
            pollResults.forEach(option => {
                const optionElement = pollContainer.querySelector(`[data-option-id="${option.id}"]`);
                if (optionElement) {
                    const votesElement = optionElement.querySelector('.poll-option-votes-compact');
                    votesElement.textContent = option.votes;
                }
            });
            
            // Update total votes
            const totalElement = pollContainer.querySelector('.poll-total-compact');
            if (totalElement) {
                totalElement.textContent = `${totalVotes} votes`;
            }
            
            // Add voted indicator
            const pollFooter = pollContainer.querySelector('.poll-footer-compact');
            if (pollFooter && !pollFooter.querySelector('.poll-voted-compact')) {
                const votedSpan = document.createElement('span');
                votedSpan.className = 'poll-voted-compact';
                votedSpan.innerHTML = '<i class="fas fa-check"></i>';
                pollFooter.appendChild(votedSpan);
            }
        }
    </script>
</body>
</html>
