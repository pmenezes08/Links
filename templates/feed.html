<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social</title>
    <!-- <meta name="csrf-token" content="{{ csrf_token }}"> -->
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css', v='1.1') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            background-color: #000000 !important;
        }
        
        .container.feed {
            background-color: #000000 !important;
        }
        
        .composer-card, .post {
            background-color: #1a2526 !important;
            border-color: #4db6ac !important;
        }
        
        .composer-input {
            background-color: rgba(255, 255, 255, 0.05) !important;
            color: #ffffff !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
        }
        
        .composer-input:focus {
            border-color: #4db6ac !important;
            background-color: rgba(255, 255, 255, 0.08) !important;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <meta name="current-username" content="{{ username }}">
    <script src="{{ url_for('static', filename='script.js', v='1.1') }}"></script>
</head>
<body>
    <!-- Sidebar Menu -->
    <div class="sidebar">
        <button class="menu-btn"><i class="fas fa-bars"></i> Menu</button>
        <div class="dropdown-content">
            {% if session['username'] == 'admin' %}
            <a href="{{ url_for('admin') }}">Admin Dashboard</a>
            <a href="{{ url_for('admin_profile') }}">Admin Profile</a>
            {% endif %}
            <a href="{{ url_for('profile') }}">Profile</a>
            <a href="{{ url_for('user_chat') }}">Messages</a>
            <a href="{{ url_for('premium_dashboard') }}">Main Dashboard</a>
            <a href="{{ url_for('feed') }}">Social</a>
            <a href="{{ url_for('communities') }}">Your Communities</a>
            <a href="{{ url_for('your_sports') }}">Your Sports</a>
            <a href="{{ url_for('logout') }}">Logout</a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container feed">

        <!-- Composer -->
        <div class="composer-card">
            <form action="/post_status" method="POST" class="composer-form" enctype="multipart/form-data">
                <div class="composer-inner">
                    <div class="composer-body">
                        <input type="text" name="content" class="composer-input" placeholder="What is happening?!">
                        <div class="composer-actions">
                            <div class="file-upload-container">
                                <label for="image-upload" class="file-upload-btn">
                                    <i class="fas fa-paperclip"></i>
                                </label>
                                <input type="file" id="image-upload" name="image" accept="image/*" style="display: none;">
                                <span id="selected-file-name" class="selected-file-name"></span>
                            </div>
                            <button type="submit" class="sleek-btn small">Post</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Posts Display -->
        <div class="posts timeline">
            {% if posts %}
                {% for post in posts %}
                    <div class="post clickable-post" data-post-id="{{ post.id }}">
                        <div class="post-header"><strong>@{{ post.username }}</strong><span class="timestamp">{{ post.timestamp | format_date('%m/%d/%y %I:%M %p') }}</span></div>
                        <p>{{ post.content }}</p>
                        {% if post.image_path and post.image_path != 'None' and post.image_path != '' %}
                            <div class="post-image">
                                <!-- Debug info -->
                                <script>console.log('Post {{ post.id }} image_path:', '{{ post.image_path }}');</script>
                                <img src="{{ url_for('uploaded_file', filename=post.image_path.replace('uploads/', '')) if post.image_path.startswith('uploads/') else url_for('uploaded_file', filename=post.image_path) }}" 
                                     alt="Post image" 
                                     loading="lazy" 
                                     onerror="console.log('Image failed to load:', this.src); this.style.display='none'; this.parentElement.innerHTML='<div style=\'padding: 20px; text-align: center; color: #9fb0b5;\'>Image could not be loaded</div>';" 
                                     onload="console.log('Image loaded successfully:', this.src);"
                                     style="max-width: 100%; height: auto; display: block;">
                            </div>
                        {% else %}
                            <!-- Debug info for posts without images -->
                            <script>console.log('Post {{ post.id }} has no image_path or invalid value:', '{{ post.image_path }}');</script>
                        {% endif %}
                        <div class="post-actions">
                            <div class="reactions">
                                <button class="reaction-btn heart {{ 'active' if post.user_reaction == 'heart' }}" data-reaction="heart" aria-label="Like post"><i class="far fa-heart"></i> <span>{{ post.reactions['heart'] or 0 }}</span></button>
                                <button class="reaction-btn thumbs-up {{ 'active' if post.user_reaction == 'thumbs-up' }}" data-reaction="thumbs-up" aria-label="Thumbs up"><i class="far fa-thumbs-up"></i> <span>{{ post.reactions['thumbs-up'] or 0 }}</span></button>
                                <button class="reaction-btn thumbs-down {{ 'active' if post.user_reaction == 'thumbs-down' }}" data-reaction="thumbs-down" aria-label="Thumbs down"><i class="far fa-thumbs-down"></i> <span>{{ post.reactions['thumbs-down'] or 0 }}</span></button>
                            </div>
                            {% if post.username == session['username'] %}
                                <button class="delete-post inline-action" data-post-id="{{ post.id }}"><i class="far fa-trash-alt"></i> Delete</button>
                            {% endif %}
                        </div>
                        <!-- Reply count indicator -->
                        <div class="reply-indicator">
                            <i class="far fa-comment"></i> {{ post.replies|length }} replies
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p>No posts yet. Be the first!</p>
            {% endif %}
        </div>
    </div>

    <!-- Post Modal -->
    <div id="postModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Post Details</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div id="modalPostContent">
                    <!-- Post content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</body>
</html>
